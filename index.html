<!DOCTYPE html>
<html lang="ta">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>роХрогро┐род ро╡ро░рпИрокроЯ роЙро░рпБро╡роХрокрпНрокроЯрпБродрпНродрпБродро▓рпН</title>
    <style>
        /* CSS Reset and Basic Styles */
        :root {
            --primary-color: #4f46e5;
            --primary-dark: #4338ca;
            --secondary-color: #10b981;
            --background-light: #f5f3ff;
            --text-dark: #1e293b;
            --text-light: #475569;
            --border-color: #d1d5db;
            --white: #ffffff;
            --shadow-color: rgba(0, 0, 0, 0.1);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html, body {
            height: 100%;
            overflow-x: hidden;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background-color: var(--background-light);
            color: var(--text-dark);
            display: flex;
            flex-direction: column;
        }
        
        .no-select {
            -webkit-user-select: none; /* Safari */
            -ms-user-select: none; /* IE 10+ */
            user-select: none; /* Standard syntax */
        }

        /* App Container and Header */
        .app-container {
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }

        .app-header {
            background-color: var(--white);
            padding: 1rem 2rem;
            text-align: center;
            border-bottom: 1px solid var(--border-color);
            box-shadow: 0 2px 4px var(--shadow-color);
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .app-header h1 {
            font-size: clamp(1.5rem, 4vw, 2.5rem);
            color: var(--primary-color);
            font-weight: 800;
            cursor: pointer;
        }

        .app-header p {
            font-size: clamp(0.75rem, 2vw, 1rem);
            color: var(--text-light);
            margin-top: 0.25rem;
        }
        
        .hidden {
            display: none !important;
        }
        
        /* Home Screen Styles */
        #homeScreen {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 2rem;
            flex-grow: 1;
        }
        
        .card-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 2rem;
            width: 100%;
            max-width: 900px;
        }

        .card {
            background: var(--white);
            border-radius: 1rem;
            padding: 2rem;
            box-shadow: 0 10px 15px -3px var(--shadow-color), 0 4px 6px -4px var(--shadow-color);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            cursor: pointer;
            border: 2px solid transparent;
            text-align: center;
            -webkit-tap-highlight-color: transparent; /* Remove tap highlight on mobile */
        }

        .card:hover {
            transform: translateY(-8px);
            box-shadow: 0 20px 25px -5px var(--shadow-color), 0 8px 10px -6px var(--shadow-color);
            border-color: var(--primary-color);
        }

        .card h2 {
            font-size: clamp(2.25rem, 7vw, 3.5rem);
            color: var(--primary-dark);
            margin-bottom: 0.5rem;
        }

        .card p {
            color: var(--text-light);
        }
        
        .card.disabled {
            opacity: 0.6;
            cursor: not-allowed;
            background-color: #f9fafb;
        }
        
        .card.disabled:hover {
              transform: none;
              box-shadow: 0 10px 15px -3px var(--shadow-color), 0 4px 6px -4px var(--shadow-color);
              border-color: transparent;
        }

        /* Simulation Screen Styles */
        #simulationScreen {
            display: flex;
            flex-direction: column;
            flex-grow: 1;
        }
        
        .tab-container {
            display: flex;
            gap: 0.5rem;
            padding: 0 1.5rem;
            border-bottom: 1px solid var(--border-color);
            background-color: var(--white);
            flex-wrap: wrap;
        }
        
        .tab-btn {
            padding: 0.75rem 1.5rem;
            border: none;
            background-color: transparent;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            color: var(--text-light);
            border-bottom: 3px solid transparent;
            transition: all 0.2s ease;
            -webkit-tap-highlight-color: transparent;
        }
        
        .tab-btn:hover {
            color: var(--primary-color);
        }
        
        .tab-btn.active {
            color: var(--primary-color);
            border-bottom-color: var(--primary-color);
        }
        
        .tab-btn:disabled {
            color: #9ca3af;
            cursor: not-allowed;
        }

        .tab-content {
            display: none;
            padding: 1.5rem;
            flex-grow: 1;
        }

        .tab-content.active {
            display: block;
        }
        
        .simulation-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 1.5rem;
            height: 100%;
        }

        .panel {
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(10px);
            border-radius: 1rem;
            padding: 1.5rem;
            box-shadow: 0 4px 6px -1px var(--shadow-color);
        }

        .controls-panel h2 {
            font-size: 1.5rem;
            color: var(--primary-dark);
            margin-bottom: 1rem;
        }

        .controls-panel p {
            margin-bottom: 1rem;
            line-height: 1.6;
        }

        .data-table {
            width: 100%;
            text-align: center;
            border-collapse: collapse;
            margin-bottom: 1.5rem;
            font-size: 0.9rem;
        }
        
        .data-table th, .data-table td {
            border: 1px solid var(--border-color);
            padding: 0.5rem;
        }

        .data-table td {
            font-size: 1.1rem;
            font-weight: 700;
        }

        .data-table th {
            background-color: #e0e7ff;
        }
        
        .input-group {
            display: flex;
            gap: 0.5rem;
            margin: 1rem 0;
            align-items: center;
            flex-wrap: wrap; /* Allows wrapping on small screens */
        }
        .input-group input {
            flex: 1 1 120px; /* Allow input to grow/shrink with a base size */
            padding: 0.6rem;
            border: 1px solid var(--border-color);
            border-radius: 0.5rem;
        }
        #addPointBtn, #addPointBtn2, #addPointBtn3, #addPointBtn4 {
            padding: 0.6rem 0.8rem;
        }

        .btn-group {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }

        .btn {
            padding: 0.75rem 1rem;
            border-radius: 0.5rem;
            font-weight: 600;
            color: var(--white);
            border: none;
            cursor: pointer;
            transition: all 0.2s ease;
            box-shadow: 0 2px 4px var(--shadow-color);
            -webkit-tap-highlight-color: transparent;
        }

        .btn-primary {
            background-color: var(--primary-color);
        }
        .btn-primary:hover {
            background-color: var(--primary-dark);
            transform: translateY(-2px);
        }
        
        .btn-secondary {
            background-color: #6b7280;
        }
        .btn-secondary:hover {
             background-color: #4b5563;
        }

        .btn:disabled {
            background-color: #d1d5db;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        .formula {
            background-color: #eef2ff;
            border: 1px solid #c7d2fe;
            padding: 0.75rem;
            border-radius: 0.5rem;
            text-align: center;
            color: var(--primary-dark);
            font-size: 1.2rem;
            margin: 1rem 0;
        }

        /* Feedback and Result Box */
        .feedback-box, .result-box {
            border-radius: 0.5rem;
            padding: 1rem;
            margin-top: 1rem;
            font-weight: 500;
            min-height: 50px;
            background: #eef2ff;
            color: var(--primary-dark);
            text-align: center;
            transition: background-color 0.3s, color 0.3s;
        }
        
        .result-box {
            font-weight: bold;
            font-size: 1.1rem;
            background-color: #ecfdf5;
            color: #065f46;
        }
        .question-box {
             background-color: #fffbeb;
             border: 1px solid #fde68a;
             padding: 1rem;
             margin-top: 1.5rem;
             border-radius: 0.75rem;
        }
        .question-box p {
             margin-bottom: 0.5rem;
             font-weight: 600;
        }


        /* Slider */
        .slider-container {
            padding-top: 1rem;
        }
        .slider-container label {
            font-weight: 600;
            color: var(--primary-dark);
        }
        input[type=range] {
            -webkit-appearance: none;
            width: 100%;
            margin: 10px 0;
            background: transparent;
        }
        input[type=range]:focus { outline: none; }
        input[type=range]::-webkit-slider-runnable-track {
            width: 100%; height: 8px; cursor: pointer; background: #c7d2fe; border-radius: 4px;
        }
        input[type=range]::-webkit-slider-thumb {
            height: 24px; width: 24px; border-radius: 50%; background: var(--primary-color); cursor: pointer;
            -webkit-appearance: none; margin-top: -8px; box-shadow: 0 0 5px rgba(0,0,0,0.3);
        }

        /* Canvas Panel */
        .canvas-panel {
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 400px;
            height: 100%;
        }
        #graphCanvas, #graphCanvas2, #graphCanvas3, #graphCanvas4, #graphCanvas5 {
            background-color: var(--white);
            border-radius: 0.75rem;
            max-width: 100%;
            max-height: 100%;
        }
        
        #graphCanvas.plotting-active, #graphCanvas2.plotting-active, #graphCanvas3.plotting-active, #graphCanvas4.plotting-active, #graphCanvas5.plotting-active {
            cursor: none;
        }
        
        #plot-tool-activator, #plot-tool-activator2, #plot-tool-activator3, #plot-tool-activator4, #plot-tool-activator5 {
            text-align: center;
            margin-top: 1rem;
            background-color: #eef2ff;
            padding: 0.5rem;
            border-radius: 0.75rem;
            border: 2px dashed var(--primary-color);
            cursor: pointer;
            transition: background-color 0.2s;
            -webkit-tap-highlight-color: transparent;
        }
        #plot-tool-activator:hover, #plot-tool-activator2:hover, #plot-tool-activator3:hover, #plot-tool-activator4:hover, #plot-tool-activator5:hover {
            background-color: #e0e7ff;
        }
        #activatorFinger, #activatorFinger2, #activatorFinger3, #activatorFinger4, #activatorFinger5 {
            font-size: 2.5rem;
            user-select: none;
        }

        .app-footer {
            text-align: center;
            padding: 1.5rem;
            color: var(--text-light);
            font-size: 0.9rem;
            background-color: var(--white);
            border-top: 1px solid var(--border-color);
            margin-top: auto;
            font-weight: bold;
        }

        /* Responsive Styles */
        @media (min-width: 768px) {
            .card-grid {
                grid-template-columns: 1fr 1fr;
            }
        }

        @media (min-width: 1024px) {
            .simulation-grid {
                grid-template-columns: 400px 1fr;
            }
        }

    </style>
</head>
<body>

    <div class="app-container">
        <header class="app-header">
            <h1 id="headerTitle">роХройрпНроп роЪроорпНрокрпВро░рпНрогро╛ родро┐роЯрпНроЯроорпН/роХройрпНропро╛ рокрпЖрогрпНроХро│рпН роХро▓рпНро╡ро┐ родро┐роЯрпНроЯроорпН</h1>
            <p style="font-weight: 600; font-size: clamp(0.9rem, 2.5vw, 1.2rem);">роЗродрпНродро┐роЯрпНроЯроорпН TITAN рооро▒рпНро▒рпБроорпН KALIKE роиро┐ро▒рпБро╡ройроЩрпНроХро│ро┐ройрпН рокроЩрпНроХро│ро┐рокрпНрокрпБроЯройрпН роЪрпЖропро▓рпНрокроЯрпБродрпНродрокрпНрокроЯрпБроХро┐ро▒родрпБ</p>
            <p style="font-size: clamp(1.2rem, 3.5vw, 1.75rem); font-weight: 600; margin-top: 0.5rem;">рокродрпНродро╛роорпН ро╡роХрпБрокрпНрокрпБ - роХрогро┐родроорпН</p>
        </header>

        <main id="mainContent">
            <!-- Home Screen -->
            <div id="homeScreen">
                <div class="card-grid">
                    <div id="graphButton" class="card">
                        <h2>ро╡ро░рпИрокроЯроЩрпНроХро│рпН</h2>
                    </div>
                    <div class="card disabled">
                        <h2>ро╡роЯро┐ро╡ро┐ропро▓рпН</h2>
                        <p>(ро╡ро┐ро░рпИро╡ро┐ро▓рпН ро╡ро░рпБроХро┐ро▒родрпБ)</p>
                    </div>
                </div>
            </div>

            <!-- Simulation Screen -->
            <div id="simulationScreen" class="hidden">
                 <div class="tab-container">
                    <button class="tab-btn active" data-tab="model1">рооро╛родро┐ро░ро┐ 1</button>
                    <button class="tab-btn" data-tab="model2">рооро╛родро┐ро░ро┐ 2</button>
                    <button class="tab-btn" data-tab="model3">рооро╛родро┐ро░ро┐ 3</button>
                    <button class="tab-btn" data-tab="model4">рооро╛родро┐ро░ро┐ 4</button>
                    <button class="tab-btn" data-tab="model5">рооро╛родро┐ро░ро┐ 5</button>
                </div>
                <!-- Model 1 Content -->
                <div id="model1" class="tab-content active">
                    <div class="simulation-grid">
                        <div class="controls-panel panel">
                            <h2>роХрогроХрпНроХрпБ</h2>
                            <p>
                                <b>ро╡ро░рпНро╖ро┐роХро╛ ро╡рпЖро╡рпНро╡рпЗро▒рпБ роЕро│ро╡рпБроХро│ро┐ро▓рпН 6 ро╡роЯрпНроЯроЩрпНроХро│рпИ ро╡ро░рпИроирпНродро╛ро│рпН. роЕроЯрпНроЯро╡рогрпИропро┐ро▓рпН роЙро│рпНро│ро╡ро╛ро▒рпБ, роТро╡рпНро╡рпКро░рпБ ро╡роЯрпНроЯродрпНродро┐ройрпН ро╡ро┐роЯрпНроЯродрпНродро┐ро▒рпНроХрпБроорпН роЕродройрпН роЪрпБро▒рпНро▒ро│ро╡ро┐ро▒рпНроХрпБроорпН роЙро│рпНро│ родрпЛро░ро╛ропродрпН родрпКроЯро░рпНрокрпБроХрпНроХрпБ роТро░рпБ ро╡ро░рпИрокроЯроорпН ро╡ро░рпИропро╡рпБроорпН. роЕродройрпИрокрпН рокропройрпНрокроЯрпБродрпНродро┐, ро╡ро┐роЯрпНроЯрооро╛ройродрпБ 6 роЪрпЖ.роорпА роЖроХ роЗро░рпБроХрпНроХрпБроорпНрокрпЛродрпБ ро╡роЯрпНроЯродрпНродро┐ройрпН роЪрпБро▒рпНро▒ро│ро╡рпИроХрпН роХро╛рогрпНроХ.</b>
                            </p>
                            
                            <p class="formula"><b>роЪрпВродрпНродро┐ро░роорпН: роЪрпБро▒рпНро▒ро│ро╡рпБ тЙИ ╧А ├Ч ро╡ро┐роЯрпНроЯроорпН</b></p>

                            <div class="input-group">
                                <input type="number" id="xInput" placeholder="ро╡ро┐роЯрпНроЯроорпН (x)">
                                <button id="addPointBtn" class="btn btn-secondary">роЪрпЗро░рпНроХрпНроХ</button>
                            </div>

                            <table class="data-table">
                                <thead>
                                    <tr><th>ро╡ро┐роЯрпНроЯроорпН (x)</th><th>роЪрпБро▒рпНро▒ро│ро╡рпБ (y)</th></tr>
                                </thead>
                                <tbody id="dataTableBody">
                                    <!-- Data points will be populated by script -->
                                </tbody>
                            </table>
                            
                            <div id="plot-tool-activator" class="hidden">
                                <div id="activatorFinger">ЁЯСЖ</div>
                                <span>рокрпБро│рпНро│ро┐ропрпИроХрпН роХрпБро▒ро┐роХрпНроХ роЗродрпИ роЕро┤рпБродрпНродро╡рпБроорпН</span>
                            </div>

                            <div class="btn-group">
                                <button id="plotBtn" class="btn btn-primary" disabled>1. рокрпБро│рпНро│ро┐роХро│рпИроХрпН роХрпБро▒ро┐роХрпНроХро╡рпБроорпН</button>
                                <button id="lineBtn" class="btn btn-primary" disabled>2. роирпЗро░рпНроХрпНроХрпЛроЯрпБ ро╡ро░рпИропро╡рпБроорпН</button>
                                
                                <div id="sliderSection" class="slider-container hidden">
                                    <label for="diameterSlider">3. ро╡ро┐роЯрпНроЯродрпНродрпИ родрпЗро░рпНро╡рпБ роЪрпЖропрпНропро╡рпБроорпН: <span id="sliderValue" style="font-size: 1.25rem; font-weight: bold;">6</span> роЪрпЖ.роорпА</label>
                                    <input type="range" id="diameterSlider" min="1" max="10" value="6" step="0.5">
                                </div>
                                 <div id="resultBox" class="result-box hidden"></div>
                            </div>

                            <div style="display: flex; gap: 1rem; margin-top: 1.5rem;">
                                <button id="resetBtn" class="btn btn-secondary" style="flex: 1;">роорпАроЯрпНроЯроорпИ</button>
                                <button id="backBtn" class="btn btn-secondary" style="flex: 1; background-color: #ef4444;">рокро┐ройрпН роЪрпЖро▓рпН</button>
                            </div>
                            <div class="feedback-box" id="feedbackBox">
                                ро╡ро┤ро┐роорпБро▒рпИроХро│рпБроХрпНроХрпБ роЗроЩрпНроХрпЗ рокро╛ро░рпНроХрпНроХро╡рпБроорпН.
                            </div>
                        </div>

                        <div class="canvas-panel panel">
                            <canvas id="graphCanvas"></canvas>
                        </div>
                    </div>
                </div>
                 <!-- Model 2 Content -->
                <div id="model2" class="tab-content">
                    <div class="simulation-grid">
                         <div class="controls-panel panel">
                            <h2>роХрогроХрпНроХрпБ</h2>
                            <p>
                                <b>роТро░рпБ рокрпЗро░рпБроирпНродрпБ 50 роХро┐.роорпА/роорогро┐ роОройрпНро▒ роЪрпАро░ро╛рой ро╡рпЗроХродрпНродро┐ро▓рпН рокропрогро┐роХрпНроХро┐ро▒родрпБ. роЗродрпНродрпКроЯро░рпНрокрпБроХрпНроХро╛рой родрпВро░роорпН тАУ роирпЗро░роорпН ро╡ро░рпИрокроЯроорпН ро╡ро░рпИроирпНродрпБ, рокро┐ройрпНро╡ро░рпБро╡ройро╡ро▒рпНро▒рпИроХрпН роХро╛рогрпНроХ.</b>
                            </p>
                             <ul style="padding-left: 20px; margin-bottom: 1rem;">
                                 <li><b>(i) ро╡ро┐роХро┐родроЪроо рооро╛ро▒ро┐ро▓ро┐ропрпИроХрпН роХро╛рогрпНроХ</b></li>
                                 <li><b>(ii) 90 роиро┐рооро┐роЯроЩрпНроХро│ро┐ро▓рпН рокропрогро┐роХрпНроХрпБроорпН родрпВро░роорпН роОро╡рпНро╡ро│ро╡рпБ?</b></li>
                                 <li><b>(iii) 300 роХро┐.роорпА. родрпВро░родрпНродрпИ рокропрогро┐роХрпНроХ роОро╡рпНро╡ро│ро╡рпБ роирпЗро░роорпН роЖроХрпБроорпН?</b></li>
                             </ul>
                            
                            <p class="formula"><b>роЪрпВродрпНродро┐ро░роорпН: y = kx</b></p>

                             <div class="input-group">
                                 <input type="number" id="xInput2" placeholder="роирпЗро░роорпН (роиро┐рооро┐роЯроЩрпНроХро│ро┐ро▓рпН)">
                                 <button id="addPointBtn2" class="btn btn-secondary">роЪрпЗро░рпНроХрпНроХ</button>
                             </div>

                            <table class="data-table">
                                <thead>
                                    <tr><th>рокропрог роирпЗро░роорпН (x) роиро┐рооро┐роЯроЩрпНроХро│рпН</th><th>рокропрог родрпВро░роорпН (y) роХро┐.роорпА-ро▓рпН</th></tr>
                                </thead>
                                <tbody id="dataTableBody2"></tbody>
                            </table>
                            
                            <div id="plot-tool-activator2" class="hidden">
                                <div id="activatorFinger2">ЁЯСЖ</div>
                                <span>рокрпБро│рпНро│ро┐ропрпИроХрпН роХрпБро▒ро┐роХрпНроХ роЗродрпИ роЕро┤рпБродрпНродро╡рпБроорпН</span>
                            </div>

                            <div class="btn-group">
                                <button id="plotBtn2" class="btn btn-primary" disabled>1. рокрпБро│рпНро│ро┐роХро│рпИроХрпН роХрпБро▒ро┐роХрпНроХро╡рпБроорпН</button>
                                <button id="lineBtn2" class="btn btn-primary" disabled>2. роирпЗро░рпНроХрпНроХрпЛроЯрпБ ро╡ро░рпИропро╡рпБроорпН</button>
                            </div>
                            
                             <div id="questionsSection2" class="hidden">
                                 <div class="question-box">
                                     <p>(i) ро╡ро┐роХро┐родроЪроо рооро╛ро▒ро┐ро▓ро┐ (k):</p>
                                     <div id="resultBox2_k" class="result-box" style="margin-top: 0;"></div>
                                 </div>
                                <div class="question-box">
                                     <p>(ii) 90 роиро┐рооро┐роЯроЩрпНроХро│ро┐ро▓рпН рокропрогро┐роХрпНроХрпБроорпН родрпВро░роорпН:</p>
                                     <div id="sliderSection2_dist" class="slider-container">
                                         <label for="timeSlider">роирпЗро░родрпНродрпИ родрпЗро░рпНро╡рпБ роЪрпЖропрпНропро╡рпБроорпН: <span id="sliderValue2_time">90</span> роиро┐рооро┐роЯроЩрпНроХро│рпН</label>
                                         <input type="range" id="timeSlider" min="0" max="360" value="90" step="10">
                                     </div>
                                    <div id="resultBox2_dist" class="result-box"></div>
                                </div>
                                 <div class="question-box">
                                     <p>(iii) 300 роХро┐.роорпА. рокропрогро┐роХрпНроХ роЖроХрпБроорпН роирпЗро░роорпН:</p>
                                     <div id="sliderSection2_time" class="slider-container">
                                         <label for="distSlider">родрпВро░родрпНродрпИ родрпЗро░рпНро╡рпБ роЪрпЖропрпНропро╡рпБроорпН: <span id="sliderValue2_dist">300</span> роХро┐.роорпА</label>
                                         <input type="range" id="distSlider" min="0" max="350" value="300" step="10">
                                     </div>
                                     <div id="resultBox2_time" class="result-box"></div>
                                 </div>
                             </div>


                            <div style="display: flex; gap: 1rem; margin-top: 1.5rem;">
                                <button id="resetBtn2" class="btn btn-secondary" style="flex: 1;">роорпАроЯрпНроЯроорпИ</button>
                                <button id="backBtn2" class="btn btn-secondary" style="flex: 1; background-color: #ef4444;">рокро┐ройрпН роЪрпЖро▓рпН</button>
                            </div>
                            <div class="feedback-box" id="feedbackBox2">
                                ро╡ро┤ро┐роорпБро▒рпИроХро│рпБроХрпНроХрпБ роЗроЩрпНроХрпЗ рокро╛ро░рпНроХрпНроХро╡рпБроорпН.
                            </div>
                        </div>
                        <div class="canvas-panel panel">
                            <canvas id="graphCanvas2"></canvas>
                        </div>
                    </div>
                </div>
                <!-- Model 3 Content -->
                <div id="model3" class="tab-content">
                    <div class="simulation-grid">
                         <div class="controls-panel panel">
                            <h2>роХрогроХрпНроХрпБ</h2>
                            <p>
                                <b>роТро░рпБ роиро┐ро▒рпБро╡ройрооро╛ройродрпБ родрпКроЯроХрпНроХродрпНродро┐ро▓рпН 40 ро╡рпЗро▓рпИропро╛роЯрпНроХро│рпБроЯройрпН 150 роиро╛роЯрпНроХро│ро┐ро▓рпН роТро░рпБ ро╡рпЗро▓рпИропрпИ роорпБроЯро┐роХрпНроХродрпН родрпКроЯроЩрпНроХро┐ропродрпБ. рокро┐ро▒роХрпБ, ро╡рпЗро▓рпИропрпИ ро╡ро┐ро░рпИро╡ро╛роХ роорпБроЯро┐родрпНродро┐роЯ ро╡рпЗро▓рпИропро╛ро│рпНроХро│рпИ роЕродро┐роХро░ро┐родрпНродродрпБ.</b>
                            </p>
                             <ul style="padding-left: 20px; margin-bottom: 1rem;">
                                 <li><b>(i) роорпЗро▓рпЗ роХрпКроЯрпБроХрпНроХрокрпНрокроЯрпНроЯрпБро│рпНро│ родро░ро╡рпБроХро│рпБроХрпНроХрпБ ро╡ро░рпИрокроЯроорпН ро╡ро░рпИроирпНродрпБ рооро╛ро▒рпБрокро╛роЯрпНроЯро┐ройрпН ро╡роХрпИропрпИ роЕроЯрпИропро╛ро│роорпН роХро╛рогрпНроХ.</b></li>
                                 <li><b>(ii) 120 ро╡рпЗро▓рпИропро╛ро│рпНроХро│рпИ ро╡рпЗро▓рпИроХрпНроХрпБ роЕрооро░рпНродрпНродро┐ройро╛ро▓рпН, ро╡рпЗро▓рпИ роорпБроЯро┐роп роОродрпНродройрпИ роиро╛роЯрпНроХро│рпН роЖроХрпБроорпН?</b></li>
                                 <li><b>(iii) ро╡рпЗро▓рпИропро╛ройродрпБ 200 роиро╛роЯрпНроХро│ро┐ро▓рпН роорпБроЯро┐роп ро╡рпЗрогрпНроЯрпБроорпН роОройро┐ро▓рпН, роОродрпНродройрпИ ро╡рпЗро▓рпИропро╛роЯрпНроХро│рпН родрпЗро╡рпИ?</b></li>
                             </ul>
                            
                            <p class="formula"><b>роЪрпВродрпНродро┐ро░роорпН: xy = k (роОродро┐ро░рпН рооро╛ро▒рпБрокро╛роЯрпБ)</b></p>

                            <div class="input-group">
                                <input type="number" id="xInput3" placeholder="ро╡рпЗро▓рпИропро╛роЯрпНроХро│рпН (x)">
                                <button id="addPointBtn3" class="btn btn-secondary">роЪрпЗро░рпНроХрпНроХ</button>
                            </div>

                            <table class="data-table">
                                <thead>
                                    <tr><th>ро╡рпЗро▓рпИропро╛роЯрпНроХро│рпН (x)</th><th>роиро╛роЯрпНроХро│рпН (y)</th></tr>
                                </thead>
                                <tbody id="dataTableBody3"></tbody>
                            </table>
                            
                            <div id="plot-tool-activator3" class="hidden">
                                <div id="activatorFinger3">ЁЯСЖ</div>
                                <span>рокрпБро│рпНро│ро┐ропрпИроХрпН роХрпБро▒ро┐роХрпНроХ роЗродрпИ роЕро┤рпБродрпНродро╡рпБроорпН</span>
                            </div>

                            <div class="btn-group">
                                <button id="plotBtn3" class="btn btn-primary" disabled>1. рокрпБро│рпНро│ро┐роХро│рпИроХрпН роХрпБро▒ро┐роХрпНроХро╡рпБроорпН</button>
                                <button id="lineBtn3" class="btn btn-primary" disabled>2. ро╡ро│рпИроХрпЛроЯрпБ ро╡ро░рпИропро╡рпБроорпН</button>
                            </div>
                            
                             <div id="questionsSection3" class="hidden">
                                 <div class="question-box">
                                     <p>(i) рооро╛ро▒рпБрокро╛роЯрпНроЯро┐ройрпН ро╡роХрпИ:</p>
                                     <div id="resultBox3_k" class="result-box" style="margin-top: 0;"></div>
                                 </div>
                                <div class="question-box">
                                     <p>(ii) 120 ро╡рпЗро▓рпИропро╛роЯрпНроХро│рпН роОройро┐ро▓рпН, родрпЗро╡рпИрокрпНрокроЯрпБроорпН роиро╛роЯрпНроХро│рпН:</p>
                                     <div class="slider-container">
                                         <label for="workersSlider3">ро╡рпЗро▓рпИропро╛роЯрпНроХро│рпИ родрпЗро░рпНро╡рпБ роЪрпЖропрпНропро╡рпБроорпН: <span id="sliderValue3_workers">120</span></label>
                                         <input type="range" id="workersSlider3" min="20" max="200" value="120" step="5">
                                     </div>
                                    <div id="resultBox3_days" class="result-box"></div>
                                </div>
                                 <div class="question-box">
                                     <p>(iii) 200 роиро╛роЯрпНроХро│ро┐ро▓рпН роорпБроЯро┐роХрпНроХ, родрпЗро╡рпИрокрпНрокроЯрпБроорпН ро╡рпЗро▓рпИропро╛роЯрпНроХро│рпН:</p>
                                     <div class="slider-container">
                                         <label for="daysSlider3">роиро╛роЯрпНроХро│рпИ родрпЗро░рпНро╡рпБ роЪрпЖропрпНропро╡рпБроорпН: <span id="sliderValue3_days">200</span></label>
                                         <input type="range" id="daysSlider3" min="20" max="300" value="200" step="5">
                                     </div>
                                     <div id="resultBox3_workers" class="result-box"></div>
                                 </div>
                             </div>


                            <div style="display: flex; gap: 1rem; margin-top: 1.5rem;">
                                <button id="resetBtn3" class="btn btn-secondary" style="flex: 1;">роорпАроЯрпНроЯроорпИ</button>
                                <button id="backBtn3" class="btn btn-secondary" style="flex: 1; background-color: #ef4444;">рокро┐ройрпН роЪрпЖро▓рпН</button>
                            </div>
                            <div class="feedback-box" id="feedbackBox3">
                                ро╡ро┤ро┐роорпБро▒рпИроХро│рпБроХрпНроХрпБ роЗроЩрпНроХрпЗ рокро╛ро░рпНроХрпНроХро╡рпБроорпН.
                            </div>
                        </div>
                        <div class="canvas-panel panel">
                            <canvas id="graphCanvas3"></canvas>
                        </div>
                    </div>
                </div>
                <!-- Model 4 Content -->
                <div id="model4" class="tab-content">
                    <div class="simulation-grid">
                         <div class="controls-panel panel">
                            <h2>роХрогроХрпНроХрпБ</h2>
                            <p>
                                <b>xy = 24, x, y > 0 роОройрпНро▒ ро╡ро░рпИрокроЯродрпНродрпИ ро╡ро░рпИроХ. ро╡ро░рпИрокроЯродрпНродрпИрокрпН рокропройрпНрокроЯрпБродрпНродро┐, (i) x = 3 роОройро┐ро▓рпН y - роРроХрпН роХро╛рогрпНроХ рооро▒рпНро▒рпБроорпН (ii) y = 6 роОройро┐ро▓рпН x - роРроХрпН роХро╛рогрпНроХ.</b>
                            </p>
                            
                            <p class="formula"><b>роЪрпВродрпНродро┐ро░роорпН: xy = 24 (роОродро┐ро░рпН рооро╛ро▒рпБрокро╛роЯрпБ)</b></p>

                            <div class="input-group">
                                <input type="number" id="xInput4" placeholder="x роородро┐рокрпНрокрпБ">
                                <button id="addPointBtn4" class="btn btn-secondary">роЪрпЗро░рпНроХрпНроХ</button>
                            </div>

                            <table class="data-table">
                                <thead>
                                    <tr>
                                        <th>x</th>
                                        <th> </th>
                                        <th>y</th>
                                        <th> </th>
                                        <th>k</th>
                                    </tr>
                                </thead>
                                <tbody id="dataTableBody4"></tbody>
                            </table>
                            
                            <div id="plot-tool-activator4" class="hidden">
                                <div id="activatorFinger4">ЁЯСЖ</div>
                                <span>рокрпБро│рпНро│ро┐ропрпИроХрпН роХрпБро▒ро┐роХрпНроХ роЗродрпИ роЕро┤рпБродрпНродро╡рпБроорпН</span>
                            </div>

                            <div class="btn-group">
                                <button id="generatePointsBtn4" class="btn btn-primary" disabled>рокрпБро│рпНро│ро┐роХро│рпИ роЙро░рпБро╡ро╛роХрпНроХро╡рпБроорпН (x, y)</button>
                                <div id="coordinatesDisplay4" class="feedback-box hidden" style="margin-top: 1rem; background-color: #f3f4f6; color: #1f2937;"></div>
                                <button id="plotBtn4" class="btn btn-primary" disabled>1. рокрпБро│рпНро│ро┐роХро│рпИроХрпН роХрпБро▒ро┐роХрпНроХро╡рпБроорпН</button>
                                <button id="lineBtn4" class="btn btn-primary" disabled>2. ро╡ро│рпИроХрпЛроЯрпБ ро╡ро░рпИропро╡рпБроорпН</button>
                            </div>
                            
                             <div id="questionsSection4" class="hidden">
                                 <div class="question-box">
                                     <p>(i) x = 3 роОройро┐ро▓рпН, y-ройрпН роородро┐рокрпНрокрпБ:</p>
                                     <div class="slider-container">
                                         <label for="xSlider4">x-роР родрпЗро░рпНро╡рпБ роЪрпЖропрпНропро╡рпБроорпН: <span id="sliderValue4_x">3</span></label>
                                         <input type="range" id="xSlider4" min="1" max="24" value="3" step="1">
                                     </div>
                                    <div id="resultBox4_y" class="result-box"></div>
                                </div>
                                 <div class="question-box">
                                     <p>(ii) y = 6 роОройро┐ро▓рпН, x-ройрпН роородро┐рокрпНрокрпБ:</p>
                                     <div class="slider-container">
                                         <label for="ySlider4">y-роР родрпЗро░рпНро╡рпБ роЪрпЖропрпНропро╡рпБроорпН: <span id="sliderValue4_y">6</span></label>
                                         <input type="range" id="ySlider4" min="1" max="24" value="6" step="1">
                                     </div>
                                     <div id="resultBox4_x" class="result-box"></div>
                                 </div>
                             </div>


                            <div style="display: flex; gap: 1rem; margin-top: 1.5rem;">
                                <button id="resetBtn4" class="btn btn-secondary" style="flex: 1;">роорпАроЯрпНроЯроорпИ</button>
                                <button id="backBtn4" class="btn btn-secondary" style="flex: 1; background-color: #ef4444;">рокро┐ройрпН роЪрпЖро▓рпН</button>
                            </div>
                            <div class="feedback-box" id="feedbackBox4">
                                ро╡ро┤ро┐роорпБро▒рпИроХро│рпБроХрпНроХрпБ роЗроЩрпНроХрпЗ рокро╛ро░рпНроХрпНроХро╡рпБроорпН.
                            </div>
                        </div>
                        <div class="canvas-panel panel">
                            <canvas id="graphCanvas4"></canvas>
                        </div>
                    </div>
                </div>
                <!-- Model 5 Content -->
                <div id="model5" class="tab-content">
                    <div class="simulation-grid">
                        <div class="controls-panel panel">
                            <h2>рооро╛ро░родрпНродро╛ройрпН роУроЯрпНроЯроорпН</h2>
                            <p>
                                <b>роиро┐ро╖ро╛роирпНродрпН 12 роХро┐.роорпА рооро╛ро░родрпНродро╛ройрпН роУроЯрпНроЯродрпНродро┐ро▓рпН ро╡рпЖро▒рпНро▒ро┐ропро╛ро│ро░рпН. роЕро╡ро░рпН роорогро┐роХрпНроХрпБ 12 роХро┐.роорпА ро╡рпЗроХродрпНродро┐ро▓рпН роУроЯро┐ 1 роорогро┐ роирпЗро░родрпНродро┐ро▓рпН роЗро▓роХрпНроХрпИ роЕроЯрпИроирпНродро╛ро░рпН. рооро▒рпНро▒ роУроЯрпНроЯрокрпНрокроирпНродроп ро╡рпАро░ро░рпНроХро│ро┐ройрпН ро╡рпЗроХроорпН рооро▒рпНро▒рпБроорпН роирпЗро░роорпН роХрпАро┤рпЗ роХрпКроЯрпБроХрпНроХрокрпНрокроЯрпНроЯрпБро│рпНро│родрпБ.</b>
                            </p>
                            
                            <p class="formula"><b>роЪрпВродрпНродро┐ро░роорпН: ро╡рпЗроХроорпН ├Ч роирпЗро░роорпН = 12 роХро┐.роорпА</b></p>

                            <table class="data-table">
                                <thead>
                                    <tr><th>роУроЯрпНроЯрокрпНрокроирпНродроп ро╡рпАро░ро░рпН</th><th>ро╡рпЗроХроорпН (x) роХро┐.роорпА/роорогро┐</th><th>роирпЗро░роорпН (y) роорогро┐</th></tr>
                                </thead>
                                <tbody id="dataTableBody5">
                                    <!-- Data will be populated by script -->
                                </tbody>
                            </table>
                            
                            <div id="plot-tool-activator5" class="hidden">
                                <div id="activatorFinger5">ЁЯСЖ</div>
                                <span>рокрпБро│рпНро│ро┐ропрпИроХрпН роХрпБро▒ро┐роХрпНроХ роЗродрпИ роЕро┤рпБродрпНродро╡рпБроорпН</span>
                            </div>

                            <div class="btn-group">
                                <button id="plotBtn5" class="btn btn-primary">1. рокрпБро│рпНро│ро┐роХро│рпИроХрпН роХрпБро▒ро┐роХрпНроХро╡рпБроорпН</button>
                                <button id="lineBtn5" class="btn btn-primary" disabled>2. ро╡ро│рпИроХрпЛроЯрпБ ро╡ро░рпИропро╡рпБроорпН</button>
                            </div>
                            
                            <div id="questionsSection5" class="hidden">
                                <div class="question-box">
                                    <p>роХрпЖро│роЪро┐роХрпН роорогро┐роХрпНроХрпБ 2.4 роХро┐.роорпА/роорогро┐ ро╡рпЗроХродрпНродро┐ро▓рпН роЪрпЖройрпНро▒ро╛ро▓рпН, роЕро╡ро░рпН роОроЯрпБродрпНродрпБроХрпНроХрпКрогрпНроЯ роирпЗро░родрпНродрпИроХрпН роХро╛рогрпНроХ.</p>
                                    <div class="slider-container">
                                        <label for="speedSlider5">ро╡рпЗроХродрпНродрпИ родрпЗро░рпНро╡рпБ роЪрпЖропрпНропро╡рпБроорпН: <span id="sliderValue5_speed">2.4</span> роХро┐.роорпА/роорогро┐</label>
                                        <input type="range" id="speedSlider5" min="1" max="12" value="2.4" step="0.1">
                                    </div>
                                   <div id="resultBox5_time" class="result-box"></div>
                                </div>
                            </div>

                            <div style="display: flex; gap: 1rem; margin-top: 1.5rem;">
                                <button id="resetBtn5" class="btn btn-secondary" style="flex: 1;">роорпАроЯрпНроЯроорпИ</button>
                                <button id="backBtn5" class="btn btn-secondary" style="flex: 1; background-color: #ef4444;">рокро┐ройрпН роЪрпЖро▓рпН</button>
                            </div>
                            <div class="feedback-box" id="feedbackBox5">
                                ро╡ро┤ро┐роорпБро▒рпИроХро│рпБроХрпНроХрпБ роЗроЩрпНроХрпЗ рокро╛ро░рпНроХрпНроХро╡рпБроорпН.
                            </div>
                        </div>
                        <div class="canvas-panel panel">
                            <canvas id="graphCanvas5"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </main>
        <footer class="app-footer">
            <p>Powered by Artificial Intelligence, this simulation has been created by Kalike, an associate organization of Tata Trusts.</p>
        </footer>
    </div>

<script>
    // --- COMMON ---
    const homeScreen = document.getElementById('homeScreen');
    const simulationScreen = document.getElementById('simulationScreen');
    const graphButton = document.getElementById('graphButton');
    const tabBtns = document.querySelectorAll('.tab-btn');
    const tabContents = document.querySelectorAll('.tab-content');
    const headerTitle = document.getElementById('headerTitle');

    // --- MODEL 1 ELEMENTS ---
    const backBtn = document.getElementById('backBtn');
    const canvas = document.getElementById('graphCanvas');
    const ctx = canvas.getContext('2d');
    const plotBtn = document.getElementById('plotBtn');
    const lineBtn = document.getElementById('lineBtn');
    const sliderSection = document.getElementById('sliderSection');
    const diameterSlider = document.getElementById('diameterSlider');
    const sliderValue = document.getElementById('sliderValue');
    const resultBox = document.getElementById('resultBox');
    const resetBtn = document.getElementById('resetBtn');
    const feedbackBox = document.getElementById('feedbackBox');
    const xInput = document.getElementById('xInput');
    const addPointBtn = document.getElementById('addPointBtn');
    const dataTableBody = document.getElementById('dataTableBody');
    const plotToolActivator = document.getElementById('plot-tool-activator');
    let activatorFinger = document.getElementById('activatorFinger');
    
    // --- MODEL 2 ELEMENTS ---
    const backBtn2 = document.getElementById('backBtn2');
    const canvas2 = document.getElementById('graphCanvas2');
    const ctx2 = canvas2.getContext('2d');
    const plotBtn2 = document.getElementById('plotBtn2');
    const lineBtn2 = document.getElementById('lineBtn2');
    const questionsSection2 = document.getElementById('questionsSection2');
    const timeSlider = document.getElementById('timeSlider');
    const sliderValue2_time = document.getElementById('sliderValue2_time');
    const resultBox2_dist = document.getElementById('resultBox2_dist');
    const distSlider = document.getElementById('distSlider');
    const sliderValue2_dist = document.getElementById('sliderValue2_dist');
    const resultBox2_time = document.getElementById('resultBox2_time');
    const resultBox2_k = document.getElementById('resultBox2_k');
    const resetBtn2 = document.getElementById('resetBtn2');
    const feedbackBox2 = document.getElementById('feedbackBox2');
    const xInput2 = document.getElementById('xInput2');
    const addPointBtn2 = document.getElementById('addPointBtn2');
    const dataTableBody2 = document.getElementById('dataTableBody2');
    const plotToolActivator2 = document.getElementById('plot-tool-activator2');
    let activatorFinger2 = document.getElementById('activatorFinger2');
    
    // --- MODEL 3 ELEMENTS ---
    const backBtn3 = document.getElementById('backBtn3');
    const canvas3 = document.getElementById('graphCanvas3');
    const ctx3 = canvas3.getContext('2d');
    const plotBtn3 = document.getElementById('plotBtn3');
    const lineBtn3 = document.getElementById('lineBtn3');
    const questionsSection3 = document.getElementById('questionsSection3');
    const workersSlider3 = document.getElementById('workersSlider3');
    const sliderValue3_workers = document.getElementById('sliderValue3_workers');
    const resultBox3_days = document.getElementById('resultBox3_days');
    const daysSlider3 = document.getElementById('daysSlider3');
    const sliderValue3_days = document.getElementById('sliderValue3_days');
    const resultBox3_workers = document.getElementById('resultBox3_workers');
    const resultBox3_k = document.getElementById('resultBox3_k');
    const resetBtn3 = document.getElementById('resetBtn3');
    const feedbackBox3 = document.getElementById('feedbackBox3');
    const dataTableBody3 = document.getElementById('dataTableBody3');
    const plotToolActivator3 = document.getElementById('plot-tool-activator3');
    const xInput3 = document.getElementById('xInput3');
    const addPointBtn3 = document.getElementById('addPointBtn3');
    let activatorFinger3 = document.getElementById('activatorFinger3');
    
    // --- MODEL 4 ELEMENTS ---
    const backBtn4 = document.getElementById('backBtn4');
    const canvas4 = document.getElementById('graphCanvas4');
    const ctx4 = canvas4.getContext('2d');
    const plotBtn4 = document.getElementById('plotBtn4');
    const lineBtn4 = document.getElementById('lineBtn4');
    const generatePointsBtn4 = document.getElementById('generatePointsBtn4');
    const questionsSection4 = document.getElementById('questionsSection4');
    const xSlider4 = document.getElementById('xSlider4');
    const sliderValue4_x = document.getElementById('sliderValue4_x');
    const resultBox4_y = document.getElementById('resultBox4_y');
    const ySlider4 = document.getElementById('ySlider4');
    const sliderValue4_y = document.getElementById('sliderValue4_y');
    const resultBox4_x = document.getElementById('resultBox4_x');
    const resetBtn4 = document.getElementById('resetBtn4');
    const feedbackBox4 = document.getElementById('feedbackBox4');
    const dataTableBody4 = document.getElementById('dataTableBody4');
    const plotToolActivator4 = document.getElementById('plot-tool-activator4');
    const xInput4 = document.getElementById('xInput4');
    const addPointBtn4 = document.getElementById('addPointBtn4');
    const coordinatesDisplay4 = document.getElementById('coordinatesDisplay4');
    let activatorFinger4 = document.getElementById('activatorFinger4');

    // --- MODEL 5 ELEMENTS ---
    const backBtn5 = document.getElementById('backBtn5');
    const canvas5 = document.getElementById('graphCanvas5');
    const ctx5 = canvas5.getContext('2d');
    const plotBtn5 = document.getElementById('plotBtn5');
    const lineBtn5 = document.getElementById('lineBtn5');
    const questionsSection5 = document.getElementById('questionsSection5');
    const speedSlider5 = document.getElementById('speedSlider5');
    const sliderValue5_speed = document.getElementById('sliderValue5_speed');
    const resultBox5_time = document.getElementById('resultBox5_time');
    const resetBtn5 = document.getElementById('resetBtn5');
    const feedbackBox5 = document.getElementById('feedbackBox5');
    const dataTableBody5 = document.getElementById('dataTableBody5');
    const plotToolActivator5 = document.getElementById('plot-tool-activator5');
    let activatorFinger5 = document.getElementById('activatorFinger5');


    // --- MODEL 1 STATE ---
    let data = [];
    let pointsPlotted = false;
    let mainLineDrawn = false;
    let solutionLinesDrawn = false;
    let graphDrawn = false;
    let plottingMode = false;
    let waitForX6Click = false;
    let currentPointIndex = 0;
    let userPlottedPoints = [];
    let mouseCanvasPos = { x: -1, y: -1 };
    let snappedGraphPos = { x: -1, y: -1 };
    let isNearTarget = false;
    let isToolActive = false;
    let padding = 60;
    let maxX = 10, maxY = 31;
    let xScale, yScale;
    
    // --- MODEL 2 STATE ---
    let data2 = [];
    let pointsPlotted2 = false;
    let lineDrawn2 = false;
    let graphDrawn2 = false;
    let plottingMode2 = false;
    let currentPointIndex2 = 0;
    let userPlottedPoints2 = [];
    let mouseCanvasPos2 = { x: -1, y: -1 };
    let snappedGraphPos2 = { x: -1, y: -1 };
    let isNearTarget2 = false;
    let isToolActive2 = false;
    let isAnimating2 = false;
    let waitForTimeClick = false;
    let waitForDistClick = false;
    let padding2 = 60;
    let maxX2 = 360, maxY2 = 350;
    let xScale2, yScale2;
    const proportionalityConstant = 5 / 6; // 50km per 60 mins

    // --- MODEL 3 STATE ---
    let data3 = [];
    let pointsPlotted3 = false;
    let lineDrawn3 = false;
    let graphDrawn3 = false;
    let plottingMode3 = false;
    let currentPointIndex3 = 0;
    let userPlottedPoints3 = [];
    let mouseCanvasPos3 = { x: -1, y: -1 };
    let snappedGraphPos3 = { x: -1, y: -1 };
    let isNearTarget3 = false;
    let isToolActive3 = false;
    let isAnimating3 = false;
    let waitForWorkersClick = false;
    let waitForDaysClick = false;
    let padding3 = 60;
    let maxX3 = 200, maxY3 = 300;
    let xScale3, yScale3;
    const inverseConstant = 6000; // 40 workers * 150 days

    // --- MODEL 4 STATE ---
    let data4 = [];
    let pointsPlotted4 = false;
    let lineDrawn4 = false;
    let graphDrawn4 = false;
    let plottingMode4 = false;
    let currentPointIndex4 = 0;
    let userPlottedPoints4 = [];
    let mouseCanvasPos4 = { x: -1, y: -1 };
    let snappedGraphPos4 = { x: -1, y: -1 };
    let isNearTarget4 = false;
    let isToolActive4 = false;
    let isAnimating4 = false;
    let waitForXClick4 = false;
    let waitForYClick4 = false;
    let padding4 = 60;
    let maxX4 = 25, maxY4 = 25;
    let xScale4, yScale4;
    const inverseConstant4 = 24;

    // --- MODEL 5 STATE ---
    let data5 = [];
    let pointsPlotted5 = false;
    let lineDrawn5 = false;
    let graphDrawn5 = false;
    let plottingMode5 = false;
    let currentPointIndex5 = 0;
    let userPlottedPoints5 = [];
    let mouseCanvasPos5 = { x: -1, y: -1 };
    let snappedGraphPos5 = { x: -1, y: -1 };
    let isNearTarget5 = false;
    let isToolActive5 = false;
    let isAnimating5 = false;
    let waitForSpeedClick = false;
    let padding5 = 60;
    let maxX5 = 13, maxY5 = 7; // Speed (x) up to 12, Time (y) up to 6. Give some buffer.
    let xScale5, yScale5;
    const inverseConstant5 = 12;

    // --- EVENT HANDLER REFERENCES ---
    let plotMoveHandler1, touchMoveHandler1, plotClickHandler1;
    let plotMoveHandler2, touchMoveHandler2, plotClickHandler2;
    let plotMoveHandler3, touchMoveHandler3, plotClickHandler3;
    let plotMoveHandler4, touchMoveHandler4, plotClickHandler4;
    let plotMoveHandler5, touchMoveHandler5, plotClickHandler5;

    // --- GENERAL FUNCTIONS ---

    function switchTab(targetTabId) {
        tabContents.forEach(content => content.classList.remove('active'));
        tabBtns.forEach(btn => btn.classList.remove('active'));

        document.getElementById(targetTabId).classList.add('active');
        document.querySelector(`.tab-btn[data-tab="${targetTabId}"]`).classList.add('active');

        if (targetTabId === 'model1') {
            resizeCanvas();
        } else if (targetTabId === 'model2') {
            if (data2.length === 0 && !plottingMode2) {
                initModel2();
            }
            resizeCanvas2();
        } else if (targetTabId === 'model3') {
            if (data3.length === 0 && !plottingMode3) {
                initModel3();
            }
            resizeCanvas3();
        } else if (targetTabId === 'model4') {
            if (data4.length === 0 && !plottingMode4) {
                initModel4();
            }
            resizeCanvas4();
        } else if (targetTabId === 'model5') {
            if (data5.length === 0 && !plottingMode5) {
                initModel5();
            }
            resizeCanvas5();
        }
    }
    
    window.addEventListener('resize', () => {
        const activeTab = document.querySelector('.tab-content.active').id;
        if (activeTab === 'model1') resizeCanvas();
        else if (activeTab === 'model2') resizeCanvas2();
        else if (activeTab === 'model3') resizeCanvas3();
        else if (activeTab === 'model4') resizeCanvas4();
        else if (activeTab === 'model5') resizeCanvas5();
    });

    // --- MODEL 1: CIRCLE SIMULATION ---

    function resizeCanvas() {
        const container = canvas.parentElement;
        const size = Math.min(container.clientWidth - 20, container.clientHeight - 20, 800);
        canvas.width = size;
        canvas.height = size;
        if (graphDrawn) {
            updateGraphBounds();
            drawGraph();
            // If the solution phase is active, redraw the helper lines at the current slider position
            if (solutionLinesDrawn) {
                diameterSlider.dispatchEvent(new Event('input'));
            }
        } else {
             clearCanvas();
        }
    }
    
    function clearCanvas(){
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        ctx.fillStyle = '#6b7280';
        ctx.font = 'bold 16px sans-serif';
        ctx.textAlign = 'center';
        ctx.fillText('роорпБродро▓ро┐ро▓рпН ро╡ро┐роЯрпНроЯродрпНродро┐ройрпН роородро┐рокрпНрокрпБроХро│рпИ роЙро│рпНро│ро┐роЯро╡рпБроорпН', canvas.width / 2, canvas.height / 2);
    }
    
    function updateGraphBounds() {
        if (data.length === 0) return;
        const maxD = data.reduce((max, p) => Math.max(max, p.d), 0);
        const maxC = data.reduce((max, p) => Math.max(max, p.c === '?' ? 0 : p.c), 0);
        maxX = Math.max(10, Math.ceil((maxD + 2)));
        maxY = Math.max(20, Math.ceil((maxC + 5)));
        xScale = (canvas.width - 2 * padding) / maxX;
        yScale = (canvas.height - 2 * padding) / maxY;
        diameterSlider.max = maxX;
    }

    function drawGraph() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        
        if (!graphDrawn) {
            clearCanvas();
            return;
        }
        
        // Draw Scale Text
        ctx.fillStyle = '#1f293b';
        ctx.font = 'bold 13px sans-serif';
        ctx.textAlign = 'right';
        ctx.fillText('роЕро│ро╡рпБродрпНродро┐роЯрпНроЯроорпН:', canvas.width - 20, padding - 15);
        ctx.font = '13px sans-serif';
        ctx.fillText('X-роЕроЪрпНроЪрпБ: 1 роЪрпЖ.роорпА = 1 роЕро▓роХрпБ', canvas.width - 20, padding + 5);
        ctx.fillText('Y-роЕроЪрпНроЪрпБ: 1 роЪрпЖ.роорпА = 2 роЕро▓роХрпБроХро│рпН', canvas.width - 20, padding + 25);

        // Draw Axes
        ctx.beginPath();
        ctx.moveTo(padding, padding);
        ctx.lineTo(padding, canvas.height - padding);
        ctx.lineTo(canvas.width - padding, canvas.height - padding);
        ctx.strokeStyle = '#333';
        ctx.lineWidth = 2;
        ctx.stroke();

        drawArrow(ctx, canvas.width - padding, canvas.height - padding, true);
        drawArrow(ctx, padding, padding, false);

        // Labels
        ctx.fillStyle = '#1e293b';
        ctx.font = 'bold 16px sans-serif';
        ctx.textAlign = 'center';
        ctx.fillText('ро╡ро┐роЯрпНроЯроорпН (x) (роЪрпЖ.роорпА)', canvas.width / 2, canvas.height - 15);
        ctx.save();
        ctx.translate(20, canvas.height / 2);
        ctx.rotate(-Math.PI / 2);
        ctx.fillText('роЪрпБро▒рпНро▒ро│ро╡рпБ (y) (роЪрпЖ.роорпА)', 0, 0);
        ctx.restore();

        // Ticks, Gridlines, and Labels
        ctx.font = 'bold 12px sans-serif';
        ctx.textAlign = 'center';
        ctx.textBaseline = 'top';

        for (let i = 0; i <= maxX; i += 1) {
            const x = padding + i * xScale;
            ctx.fillStyle = '#1e293b';
            ctx.fillText(i, x, canvas.height - padding + 10);
            if (i > 0) {
                ctx.beginPath();
                ctx.moveTo(x, canvas.height - padding);
                ctx.lineTo(x, padding);
                ctx.lineWidth = 1;
                ctx.strokeStyle = '#e2e8f0';
                ctx.stroke();
            }
        }
        
        ctx.textAlign = 'right';
        ctx.textBaseline = 'middle';
        for (let i = 0; i <= maxY; i += 1) {
             const y = canvas.height - padding - i * yScale;
              if (i > 0 && i % 2 === 0) { // Label every 2 units for clarity
                   ctx.fillStyle = '#1e293b';
                   ctx.fillText(i, padding - 10, y);
              }
              if (i > 0) {
                   ctx.beginPath();
                   ctx.moveTo(padding, y);
                   ctx.lineTo(canvas.width - padding, y);
                   ctx.lineWidth = 1;
                   ctx.strokeStyle = '#e2e8f0';
                   ctx.stroke();
              }
        }
        
        userPlottedPoints.forEach(p => drawPoint(p.d, p.c, '#4f46e5', 8));
        
        // Draw permanent coordinate labels for correctly plotted points in Model 1
        ctx.font = 'bold 14px sans-serif';
        ctx.fillStyle = '#1e293b';
        ctx.textAlign = 'left';
        ctx.textBaseline = 'bottom';
        userPlottedPoints.forEach(p => {
            const xPos = padding + p.d * xScale;
            const yPos = canvas.height - padding - p.c * yScale;
            const coordText = `(${p.d}, ${p.c})`;
            ctx.fillText(coordText, xPos + 10, yPos - 10);
        });

        if (isToolActive && mouseCanvasPos.x > 0 && mouseCanvasPos.y > 0) {
            ctx.textAlign = 'center';
            ctx.textBaseline = 'top';
            
            ctx.font = '32px sans-serif';
            ctx.fillStyle = isNearTarget ? '#10b981' : '#ef4444';
            ctx.fillText('ЁЯСЖ', mouseCanvasPos.x, mouseCanvasPos.y);

            const coordText = `(${snappedGraphPos.x.toFixed(1)}, ${snappedGraphPos.y.toFixed(1)})`;
            
            ctx.font = 'bold 20px monospace';
            ctx.textAlign = 'left';
            ctx.textBaseline = 'middle';
            const textMetrics = ctx.measureText(coordText);
            
            const tailXBase = mouseCanvasPos.x;
            const tailY = mouseCanvasPos.y + 15;
            let rectX, textX;

            // Position tooltip to the right by default
            rectX = tailXBase + 20;
            textX = rectX + 5;

            // If it overflows right, position to the left
            if (rectX + textMetrics.width + 10 > canvas.width) {
                rectX = tailXBase - 20 - textMetrics.width - 10;
                textX = rectX + 5;
            }

            ctx.fillStyle = isNearTarget ? 'rgba(16, 185, 129, 0.9)' : 'rgba(30, 41, 59, 0.8)';
            ctx.beginPath();
            ctx.roundRect(rectX, tailY - 14, textMetrics.width + 10, 28, 7);
            ctx.fill();
            
            ctx.fillStyle = '#ffffff';
            ctx.fillText(coordText, textX, tailY);
            
            ctx.textAlign = 'center';
            ctx.textBaseline = 'alphabetic';
            ctx.fillStyle = '#1e293b';
        }


        if (mainLineDrawn) {
            drawLine();
        }
        if(solutionLinesDrawn) {
            diameterSlider.dispatchEvent(new Event('input'));
        }
    }
    
    function drawArrow(ctx, x, y, isHorizontal) {
        ctx.beginPath();
        if (isHorizontal) {
            ctx.moveTo(x, y); ctx.lineTo(x - 10, y - 5); ctx.lineTo(x - 10, y + 5);
        } else {
            ctx.moveTo(x, y); ctx.lineTo(x - 5, y + 10); ctx.lineTo(x + 5, y + 10);
        }
        ctx.closePath(); ctx.fillStyle = '#333'; ctx.fill();
    }

    function drawPoint(d, c, color = '#4f46e5', radius = 6) {
        if (d > maxX || c > maxY) return;
        const x = padding + d * xScale;
        const y = canvas.height - padding - c * yScale;
        ctx.beginPath();
        ctx.arc(x, y, radius, 0, Math.PI * 2);
        ctx.fillStyle = color;
        ctx.fill();
        ctx.strokeStyle = 'white'; ctx.lineWidth = 2; ctx.stroke();
    }
    
    function startManualPlotting() {
        if (data.length < 5) {
            feedbackBox.textContent = 'родрпКроЯроЩрпНроХрпБро╡родро▒рпНроХрпБ роорпБройрпН 5 рокрпБро│рпНро│ро┐роХро│рпИроЪрпН роЪрпЗро░рпНроХрпНроХро╡рпБроорпН.';
            return;
        }

        graphDrawn = true;
        plottingMode = true;
        currentPointIndex = 0;
        userPlottedPoints = [];
        plotBtn.disabled = true;
        updateGraphBounds();
        drawGraph();
        
        plotToolActivator.classList.remove('hidden');
        activatorFinger.addEventListener('click', activatePlottingTool, { once: true });
        updateFeedbackForPlotting();
    }
    
    function activatePlottingTool() {
        isToolActive = true;
        document.body.classList.add('no-select');
        canvas.classList.add('plotting-active');
        plotToolActivator.classList.add('hidden');
        feedbackBox.innerHTML = `ро╡ро░рпИрокроЯродрпНродро┐ро▓рпН родрпКроЯрпНроЯрпБ <b>(${data[currentPointIndex].d}, ${data[currentPointIndex].c})</b> роОройрпНро▒ рокрпБро│рпНро│ро┐ропрпИроХрпН роХрогрпНроЯро▒ро┐ропро╡рпБроорпН.`;
        
        plotMoveHandler1 = (e) => plotMove(e, 1);
        touchMoveHandler1 = (e) => plotMove(e, 1);
        plotClickHandler1 = (e) => handlePlotClick(e, 1);

        document.addEventListener('mousemove', plotMoveHandler1);
        document.addEventListener('touchmove', touchMoveHandler1, { passive: false });
        canvas.addEventListener('click', plotClickHandler1);
    }

    function plotMove(e, model) {
        let currentCanvas, currentPadding, currentXScale, currentYScale, currentMaxX, currentMaxY;
        let currentSnappedPos, currentMousePos, currentTarget, snapValueX, snapValueY;
        let currentIsToolActive, currentIsNearTargetRef;

        e.preventDefault();
        
        switch(model) {
            case 1:
                if (!isToolActive) return;
                currentCanvas = canvas; currentPadding = padding; currentXScale = xScale; currentYScale = yScale;
                currentMaxX = maxX; currentMaxY = maxY; currentSnappedPos = snappedGraphPos;
                currentMousePos = mouseCanvasPos; currentTarget = data[currentPointIndex];
                snapValueX = 10; snapValueY = 10;
                break;
            case 2:
                if (!isToolActive2) return;
                currentCanvas = canvas2; currentPadding = padding2; currentXScale = xScale2; currentYScale = yScale2;
                currentMaxX = maxX2; currentMaxY = maxY2; currentSnappedPos = snappedGraphPos2;
                currentMousePos = mouseCanvasPos2; currentTarget = data2[currentPointIndex2];
                snapValueX = 1; snapValueY = 1;
                break;
            case 3:
                if (!isToolActive3) return;
                currentCanvas = canvas3; currentPadding = padding3; currentXScale = xScale3; currentYScale = yScale3;
                currentMaxX = maxX3; currentMaxY = maxY3; currentSnappedPos = snappedGraphPos3;
                currentMousePos = mouseCanvasPos3; currentTarget = data3[currentPointIndex3];
                snapValueX = 1; snapValueY = 1;
                break;
            case 4:
                if (!isToolActive4) return;
                currentCanvas = canvas4; currentPadding = padding4; currentXScale = xScale4; currentYScale = yScale4;
                currentMaxX = maxX4; currentMaxY = maxY4; currentSnappedPos = snappedGraphPos4;
                currentMousePos = mouseCanvasPos4; currentTarget = data4[currentPointIndex4];
                snapValueX = 1; snapValueY = 1;
                break;
            case 5:
                if (!isToolActive5) return;
                currentCanvas = canvas5; currentPadding = padding5; currentXScale = xScale5; currentYScale = yScale5;
                currentMaxX = maxX5; currentMaxY = maxY5; currentSnappedPos = snappedGraphPos5;
                currentMousePos = mouseCanvasPos5; currentTarget = data5[currentPointIndex5];
                snapValueX = 1; snapValueY = 1;
                break;
        }

        const rect = currentCanvas.getBoundingClientRect();
        let clientX, clientY;
        if (e.touches && e.touches.length > 0) {
            clientX = e.touches[0].clientX; clientY = e.touches[0].clientY;
        } else {
            clientX = e.clientX; clientY = e.clientY;
        }
        
        const rawMouseX = clientX - rect.left;
        const rawMouseY = clientY - rect.top;
        let graphX = (rawMouseX - currentPadding) / currentXScale;
        let graphY = (currentCanvas.height - currentPadding - rawMouseY) / currentYScale;

        graphX = Math.max(0, Math.min(currentMaxX, graphX));
        graphY = Math.max(0, Math.min(currentMaxY, graphY));

        currentSnappedPos.x = parseFloat((Math.round(graphX * snapValueX) / snapValueX).toFixed(model === 1 ? 1 : 0));
        currentSnappedPos.y = parseFloat((Math.round(graphY * snapValueY) / snapValueY).toFixed(model === 1 ? 1 : 0));
        
        currentMousePos.x = currentPadding + currentSnappedPos.x * currentXScale;
        currentMousePos.y = currentCanvas.height - currentPadding - currentSnappedPos.y * currentYScale;
        
        let targetX, targetY;
        if (model === 1) { targetX = currentTarget.d; targetY = currentTarget.c; } 
        else if (model === 2) { targetX = currentTarget.t; targetY = currentTarget.d; } 
        else if (model === 5) { targetX = currentTarget.speed; targetY = currentTarget.time; }
        else { targetX = currentTarget.x; targetY = currentTarget.y; }
        
        if (model === 1) { isNearTarget = (currentSnappedPos.x === targetX && currentSnappedPos.y === targetY); drawGraph(); }
        else if (model === 2) { isNearTarget2 = (currentSnappedPos.x === targetX && currentSnappedPos.y === targetY); drawGraph2(); }
        else if (model === 3){ isNearTarget3 = (currentSnappedPos.x === targetX && currentSnappedPos.y === targetY); drawGraph3(); }
        else if (model === 4){ isNearTarget4 = (currentSnappedPos.x === targetX && currentSnappedPos.y === targetY); drawGraph4(); }
        else if (model === 5){ isNearTarget5 = (currentSnappedPos.x === targetX && currentSnappedPos.y === targetY); drawGraph5(); }
    }
    
    function handlePlotClick(e, model) {
        let currentIsNearTarget;
        
        if (model === 1) { if (!isToolActive) return; currentIsNearTarget = isNearTarget; } 
        else if (model === 2) { if (!isToolActive2) return; currentIsNearTarget = isNearTarget2; } 
        else if (model === 3) { if (!isToolActive3) return; currentIsNearTarget = isNearTarget3; } 
        else if (model === 4) { if (!isToolActive4) return; currentIsNearTarget = isNearTarget4; }
        else if (model === 5) { if (!isToolActive5) return; currentIsNearTarget = isNearTarget5; }

        if (e.target.closest('.controls-panel')) return;
        e.preventDefault();
        
        if (currentIsNearTarget) {
            if (model === 1) {
                userPlottedPoints.push(data[currentPointIndex]);
                currentPointIndex++;

                if (currentPointIndex >= data.length) {
                    plottingMode = false; pointsPlotted = true;
                    feedbackBox.innerHTML = 'роЕро░рпБроорпИ! роОро▓рпНро▓ро╛ рокрпБро│рпНро│ро┐роХро│рпБроорпН роХрпБро▒ро┐роХрпНроХрокрпНрокроЯрпНроЯрой. <b>роЗрокрпНрокрпЛродрпБ "роирпЗро░рпНроХрпНроХрпЛроЯрпБ ро╡ро░рпИропро╡рпБроорпН" рокрпКродрпНродро╛ройрпИ роЕро┤рпБродрпНродро╡рпБроорпН.</b>';
                    lineBtn.disabled = false;
                    
                    if (!data.some(p => p.d === 6)) {
                        data.push({ d: 6, c: '?' });
                        updateTable();
                        updateGraphBounds();
                    }
                } else { updateFeedbackForPlotting(); }
            } else if (model === 2) {
                userPlottedPoints2.push(data2[currentPointIndex2]);
                currentPointIndex2++;
                if (currentPointIndex2 >= data2.length) {
                    plottingMode2 = false; pointsPlotted2 = true; lineBtn2.disabled = false;
                    feedbackBox2.textContent = 'роЕро░рпБроорпИ! роОро▓рпНро▓ро╛ рокрпБро│рпНро│ро┐роХро│рпБроорпН роХрпБро▒ро┐роХрпНроХрокрпНрокроЯрпНроЯрой. роЗрокрпНрокрпЛродрпБ роирпЗро░рпНроХрпНроХрпЛроЯрпБ ро╡ро░рпИропро╡рпБроорпН.';
                } else { updateFeedbackForPlotting2(); }
            } else if (model === 3) {
                userPlottedPoints3.push(data3[currentPointIndex3]);
                currentPointIndex3++;
                if (currentPointIndex3 >= data3.length) {
                    plottingMode3 = false; pointsPlotted3 = true; lineBtn3.disabled = false;
                    feedbackBox3.textContent = 'роЕро░рпБроорпИ! роОро▓рпНро▓ро╛ рокрпБро│рпНро│ро┐роХро│рпБроорпН роХрпБро▒ро┐роХрпНроХрокрпНрокроЯрпНроЯрой. роЗрокрпНрокрпЛродрпБ ро╡ро│рпИроХрпЛроЯрпБ ро╡ро░рпИропро╡рпБроорпН.';
                } else { updateFeedbackForPlotting3(); }
            } else if (model === 4) {
                 userPlottedPoints4.push(data4[currentPointIndex4]);
                 currentPointIndex4++;
                 if (currentPointIndex4 >= data4.length) {
                     plottingMode4 = false; pointsPlotted4 = true; lineBtn4.disabled = false;
                     feedbackBox4.textContent = 'роЕро░рпБроорпИ! роОро▓рпНро▓ро╛ рокрпБро│рпНро│ро┐роХро│рпБроорпН роХрпБро▒ро┐роХрпНроХрокрпНрокроЯрпНроЯрой. роЗрокрпНрокрпЛродрпБ ро╡ро│рпИроХрпЛроЯрпБ ро╡ро░рпИропро╡рпБроорпН.';
                 } else { updateFeedbackForPlotting4(); }
            } else if (model === 5) {
                 userPlottedPoints5.push(data5[currentPointIndex5]);
                 currentPointIndex5++;
                 if (currentPointIndex5 >= data5.length) {
                     plottingMode5 = false; pointsPlotted5 = true; lineBtn5.disabled = false;
                     feedbackBox5.textContent = 'роЕро░рпБроорпИ! роОро▓рпНро▓ро╛ рокрпБро│рпНро│ро┐роХро│рпБроорпН роХрпБро▒ро┐роХрпНроХрокрпНрокроЯрпНроЯрой. роЗрокрпНрокрпЛродрпБ ро╡ро│рпИроХрпЛроЯрпБ ро╡ро░рпИропро╡рпБроорпН.';
                 } else { updateFeedbackForPlotting5(); }
            }
        } else {
            const fb = (model === 1) ? feedbackBox : (model === 2 ? feedbackBox2 : (model === 3 ? feedbackBox3 : (model === 4 ? feedbackBox4 : feedbackBox5)));
            fb.style.backgroundColor = '#fee2e2';
            fb.style.color = '#b91c1c';
            fb.textContent = 'родро╡ро▒ро╛рой роЗроЯроорпН! роЪро░ро┐ропро╛рой рокрпБро│рпНро│ро┐ропрпИроХрпН роХрогрпНроЯро▒ро┐ропро╡рпБроорпН.';
            
            setTimeout(() => {
                fb.style.backgroundColor = '#eef2ff';
                fb.style.color = 'var(--primary-dark)';
                if (model === 1) updateFeedbackForPlotting();
                else if (model === 2) updateFeedbackForPlotting2();
                else if (model === 3) updateFeedbackForPlotting3();
                else if (model === 4) updateFeedbackForPlotting4();
                else if (model === 5) updateFeedbackForPlotting5();
            }, 2000);
        }

        if (model === 1) {
            isToolActive = false;
            document.removeEventListener('mousemove', plotMoveHandler1); document.removeEventListener('touchmove', touchMoveHandler1); canvas.removeEventListener('click', plotClickHandler1);
            canvas.classList.remove('plotting-active'); mouseCanvasPos = { x: -1, y: -1 };
            if (plottingMode && currentPointIndex < data.length) {
                plotToolActivator.classList.remove('hidden');
                activatorFinger.addEventListener('click', activatePlottingTool, { once: true });
            }
            drawGraph();
        } else if (model === 2) {
            isToolActive2 = false;
            document.removeEventListener('mousemove', plotMoveHandler2); document.removeEventListener('touchmove', touchMoveHandler2); canvas2.removeEventListener('click', plotClickHandler2);
            canvas2.classList.remove('plotting-active'); mouseCanvasPos2 = { x: -1, y: -1 };
            if (plottingMode2 && currentPointIndex2 < data2.length) {
                plotToolActivator2.classList.remove('hidden');
                activatorFinger2.addEventListener('click', activatePlottingTool2, { once: true });
            }
            drawGraph2();
        } else if (model === 3) {
             isToolActive3 = false;
            document.removeEventListener('mousemove', plotMoveHandler3); document.removeEventListener('touchmove', touchMoveHandler3); canvas3.removeEventListener('click', plotClickHandler3);
            canvas3.classList.remove('plotting-active'); mouseCanvasPos3 = { x: -1, y: -1 };
            if (plottingMode3 && currentPointIndex3 < data3.length) {
                plotToolActivator3.classList.remove('hidden');
                activatorFinger3.addEventListener('click', activatePlottingTool3, { once: true });
            }
            drawGraph3();
        } else if (model === 4) {
             isToolActive4 = false;
            document.removeEventListener('mousemove', plotMoveHandler4); document.removeEventListener('touchmove', touchMoveHandler4); canvas4.removeEventListener('click', plotClickHandler4);
            canvas4.classList.remove('plotting-active'); mouseCanvasPos4 = { x: -1, y: -1 };
            if (plottingMode4 && currentPointIndex4 < data4.length) {
                plotToolActivator4.classList.remove('hidden');
                activatorFinger4.addEventListener('click', activatePlottingTool4, { once: true });
            }
            drawGraph4();
        } else if (model === 5) {
             isToolActive5 = false;
            document.removeEventListener('mousemove', plotMoveHandler5); document.removeEventListener('touchmove', touchMoveHandler5); canvas5.removeEventListener('click', plotClickHandler5);
            canvas5.classList.remove('plotting-active'); mouseCanvasPos5 = { x: -1, y: -1 };
            if (plottingMode5 && currentPointIndex5 < data5.length) {
                plotToolActivator5.classList.remove('hidden');
                activatorFinger5.addEventListener('click', activatePlottingTool5, { once: true });
            }
            drawGraph5();
        }
        document.body.classList.remove('no-select');
    }
    
    function updateFeedbackForPlotting() {
        if (currentPointIndex < data.length) {
            const target = data[currentPointIndex];
            feedbackBox.innerHTML = `рокрпБро│рпНро│ро┐ роХрпБро▒ро┐роХрпНроХрпБроорпН роХро░рпБро╡ро┐ропрпИ роЕро┤рпБродрпНродро┐, ро╡ро░рпИрокроЯродрпНродро┐ро▓рпН <b>(${target.d}, ${target.c})</b> роОройрпНро▒ рокрпБро│рпНро│ро┐ропрпИроХрпН роХрогрпНроЯро▒ро┐ропро╡рпБроорпН.`;
        }
    }

    function activateX6Finder() {
        plotToolActivator.classList.add('hidden');
        isToolActive = true;
        waitForX6Click = true; // Use this flag to differentiate this mode
        feedbackBox.innerHTML = 'роЕро░рпБроорпИ! роЗрокрпНрокрпЛродрпБ <b>ро╡ро░рпИрокроЯродрпНродро┐ро▓рпН (6.0, 0.0) роОройрпНро▒ рокрпБро│рпНро│ро┐ропрпИроХрпН роХрогрпНроЯро▒ро┐ропро╡рпБроорпН</b>.';
        canvas.classList.add('plotting-active');
        document.body.classList.add('no-select');

        plotMoveHandler1 = (e) => plotMoveForX6(e);
        touchMoveHandler1 = (e) => plotMoveForX6(e);
        plotClickHandler1 = (e) => handlePlotClickForX6(e);

        document.addEventListener('mousemove', plotMoveHandler1);
        document.addEventListener('touchmove', touchMoveHandler1, { passive: false });
        canvas.addEventListener('click', plotClickHandler1);
    }

    function plotMoveForX6(e) {
        if (!isToolActive || !waitForX6Click) return;
        e.preventDefault();
        const rect = canvas.getBoundingClientRect();
        let clientX, clientY;
        if (e.touches && e.touches.length > 0) {
            clientX = e.touches[0].clientX;
            clientY = e.touches[0].clientY;
        } else {
            clientX = e.clientX;
            clientY = e.clientY;
        }
        
        const rawMouseX = clientX - rect.left;
        const rawMouseY = clientY - rect.top;
        let graphX = (rawMouseX - padding) / xScale;
        let graphY = (canvas.height - padding - rawMouseY) / yScale;

        graphX = Math.max(0, Math.min(maxX, graphX));
        graphY = Math.max(0, Math.min(maxY, graphY));

        snappedGraphPos.x = parseFloat((Math.round(graphX * 10) / 10).toFixed(1));
        snappedGraphPos.y = parseFloat((Math.round(graphY * 10) / 10).toFixed(1));

        mouseCanvasPos.x = padding + snappedGraphPos.x * xScale;
        mouseCanvasPos.y = canvas.height - padding - snappedGraphPos.y * yScale;
        
        isNearTarget = (snappedGraphPos.x === 6.0 && snappedGraphPos.y === 0.0);
        drawGraph();
    }

    function handlePlotClickForX6(e) {
        if (!isToolActive || !waitForX6Click) return;
        if (e.target.closest('.controls-panel')) return;
        e.preventDefault();

        if (isNearTarget) {
            // Deactivate tool
            isToolActive = false;
            waitForX6Click = false;
            document.removeEventListener('mousemove', plotMoveHandler1);
            document.removeEventListener('touchmove', touchMoveHandler1);
            canvas.removeEventListener('click', plotClickHandler1);
            canvas.classList.remove('plotting-active');
            document.body.classList.remove('no-select');
            mouseCanvasPos = { x: -1, y: -1 };
            drawGraph(); // Redraw without the tool

            // Start animation
            feedbackBox.textContent = 'роЪро░ро┐ропро╛ройродрпБ! родрпАро░рпНро╡рпБ роОро╡рпНро╡ро╛ро▒рпБ роХрогрпНроЯро▒ро┐ропрокрпНрокроЯрпБроХро┐ро▒родрпБ роОройрпНрокродрпИрокрпН рокро╛ро░рпБроЩрпНроХро│рпН.';
            animateSolutionLines();
        } else {
            feedbackBox.style.backgroundColor = '#fee2e2';
            feedbackBox.style.color = '#b91c1c';
            feedbackBox.textContent = 'родро╡ро▒рпБ. ро╡ро░рпИрокроЯродрпНродро┐ро▓рпН (6.0, 0.0) рокрпБро│рпНро│ро┐ропрпИроХрпН роХрогрпНроЯро▒ро┐ропро╡рпБроорпН.';
            
            setTimeout(() => {
                feedbackBox.style.backgroundColor = '#eef2ff';
                feedbackBox.style.color = 'var(--primary-dark)';
                feedbackBox.innerHTML = 'роЕро░рпБроорпИ! роЗрокрпНрокрпЛродрпБ <b>ро╡ро░рпИрокроЯродрпНродро┐ро▓рпН (6.0, 0.0) роОройрпНро▒ рокрпБро│рпНро│ро┐ропрпИроХрпН роХрогрпНроЯро▒ро┐ропро╡рпБроорпН</b>.';
            }, 2000);
        }
    }


    function animateSolutionLines() {
        const targetY = 18.6;
        const duration = 1500; 
        let startTime = null;

        // 1. Animate Vertical Line
        function animateVertical(timestamp) {
            if (!startTime) startTime = timestamp;
            const progress = timestamp - startTime;
            const percentage = 1 - Math.pow(1 - Math.min(progress / duration, 1), 5); // Ease-out
            const currentY = targetY * percentage;

            drawGraph(); // Redraws points and main red line

            const x_canvas = padding + 6 * xScale;
            const y_start_canvas = canvas.height - padding;
            const y_end_canvas = canvas.height - padding - currentY * yScale;

            ctx.beginPath();
            ctx.setLineDash([5, 5]);
            ctx.strokeStyle = '#10b981'; // Green
            ctx.lineWidth = 2;
            ctx.moveTo(x_canvas, y_start_canvas);
            ctx.lineTo(x_canvas, y_end_canvas);
            ctx.stroke();
            ctx.setLineDash([]);

            if (percentage > 0.05) drawPoint(6, currentY, '#10b981', 6);

            if (progress < duration) {
                requestAnimationFrame(animateVertical);
            } else {
                drawPoint(6, targetY, '#10b981', 8); // Final point
                startTime = null; // Reset for next animation
                requestAnimationFrame(animateHorizontal); // Start horizontal animation
            }
        }

        // 2. Animate Horizontal Line
        function animateHorizontal(timestamp) {
            if (!startTime) startTime = timestamp;
            const progress = timestamp - startTime;
            const percentage = 1 - Math.pow(1 - Math.min(progress / duration, 1), 3); // Ease-out
            const currentX = 6 * (1 - percentage);

            drawGraph(); // Redraw everything

            // Draw the completed vertical line statically
            const x_canvas_vert = padding + 6 * xScale;
            const y_canvas_vert_end = canvas.height - padding - targetY * yScale;
            ctx.beginPath();
            ctx.setLineDash([5, 5]);
            ctx.strokeStyle = '#10b981';
            ctx.lineWidth = 2;
            ctx.moveTo(x_canvas_vert, canvas.height - padding);
            ctx.lineTo(x_canvas_vert, y_canvas_vert_end);
            ctx.stroke();
            drawPoint(6, targetY, '#10b981', 8);

            // Animate the horizontal line
            const y_canvas_horiz = y_canvas_vert_end;
            const x_start_horiz = x_canvas_vert;
            const x_end_horiz = padding + currentX * xScale;

            ctx.beginPath();
            ctx.strokeStyle = '#ef4444'; // Red
            ctx.moveTo(x_start_horiz, y_canvas_horiz);
            ctx.lineTo(x_end_horiz, y_canvas_horiz);
            ctx.stroke();
            ctx.setLineDash([]);


            if (progress < duration) {
                requestAnimationFrame(animateHorizontal);
            } else {
                // Final state after both animations
                solutionLinesDrawn = true;
                
                // Update data model and table
                const pointToUpdate = data.find(p => p.d === 6);
                if(pointToUpdate) pointToUpdate.c = 18.6;
                updateTable();
                
                // Show slider and result
                sliderSection.classList.remove('hidden');
                resultBox.classList.remove('hidden');
                feedbackBox.textContent = 'роЪро┐ро▒рокрпНрокрпБ! роЗрокрпНрокрпЛродрпБ ро╕рпНро▓рпИроЯро░рпИрокрпН рокропройрпНрокроЯрпБродрпНродро┐ ро╡рпЖро╡рпНро╡рпЗро▒рпБ ро╡ро┐роЯрпНроЯродрпНродро┐ро▒рпНроХро╛рой роЪрпБро▒рпНро▒ро│ро╡рпИроХрпН роХрогрпНроЯро▒ро┐ропро╡рпБроорпН.';
                handleSliderInput();
            }
        }

        requestAnimationFrame(animateVertical); // Start the first animation
    }
    
    function drawLine() {
        if (!mainLineDrawn) return;
        
        const slope = 3.1;
        const startX = padding;
        const startY = canvas.height - padding;
        const endX = padding + maxX * xScale;
        const endY = canvas.height - padding - (maxX * slope) * yScale;
        
        ctx.beginPath();
        ctx.moveTo(startX, startY);
        ctx.lineTo(endX, endY);
        ctx.strokeStyle = '#ef4444';
        ctx.lineWidth = 3;
        ctx.stroke();
    }

    function handleSliderInput() {
        if (!solutionLinesDrawn) return;

        const slope = 3.1;
        const diameter = parseFloat(diameterSlider.value);
        sliderValue.textContent = diameter;
        const circumference = diameter * slope;
        
        drawGraph(); 

        const x = padding + diameter * xScale;
        const y = canvas.height - padding - circumference * yScale;
        
        ctx.beginPath();
        ctx.setLineDash([5, 5]);
        ctx.strokeStyle = '#10b981';
        ctx.lineWidth = 2;
        ctx.moveTo(x, canvas.height - padding);
        ctx.lineTo(x, y);
        ctx.lineTo(padding, y);
        ctx.stroke();
        ctx.setLineDash([]);

        drawPoint(diameter, circumference, '#10b981', 8);

        resultBox.textContent = `ро╡ро┐роЯрпНроЯроорпН ${diameter} роЪрпЖ.роорпА роОройро┐ро▓рпН, роЪрпБро▒рпНро▒ро│ро╡рпБ тЙИ ${circumference.toFixed(1)} роЪрпЖ.роорпА`;
    }

    function updateTable() {
        dataTableBody.innerHTML = '';
        data.forEach((point) => {
            const row = document.createElement('tr');
            row.innerHTML = `<td>${point.d}</td><td>${point.c === '?' ? '?' : point.c.toFixed(1) }</td>`;
            dataTableBody.appendChild(row);
        });
    }

    function resetSimulation() {
        data = [];
        pointsPlotted = mainLineDrawn = solutionLinesDrawn = graphDrawn = plottingMode = isToolActive = isNearTarget = false;
        waitForX6Click = false;
        plotBtn.disabled = lineBtn.disabled = true;
        xInput.disabled = addPointBtn.disabled = false;
        xInput.value = '';
        sliderSection.classList.add('hidden');
        resultBox.classList.add('hidden');
        diameterSlider.value = 6;
        sliderValue.textContent = '6';
        updateTable();
        canvas.classList.remove('plotting-active');

        if (plotMoveHandler1) document.removeEventListener('mousemove', plotMoveHandler1);
        if (touchMoveHandler1) document.removeEventListener('touchmove', touchMoveHandler1);
        if (plotClickHandler1) canvas.removeEventListener('click', plotClickHandler1);
        
        currentPointIndex = 0;
        userPlottedPoints = [];
        snappedGraphPos = { x: -1, y: -1 };
        plotToolActivator.classList.add('hidden');
        plotToolActivator.querySelector('span').textContent = 'рокрпБро│рпНро│ро┐ропрпИроХрпН роХрпБро▒ро┐роХрпНроХ роЗродрпИ роЕро┤рпБродрпНродро╡рпБроорпН';
        const newActivator = activatorFinger.cloneNode(true);
        activatorFinger.parentNode.replaceChild(newActivator, activatorFinger);
        activatorFinger = newActivator;
        feedbackBox.innerHTML = '<b>роорпБродро▓ро┐ро▓рпН, 1 роорпБродро▓рпН 5 ро╡ро░рпИ ро╡ро┐роЯрпНроЯродрпНродро┐ройрпН роородро┐рокрпНрокрпБроХро│рпИ роЙро│рпНро│ро┐роЯро╡рпБроорпН.</b>';
        resizeCanvas();
    }

    // --- MODEL 2: BUS SIMULATION ---

    function initModel2() {
        data2 = []; // Start with an empty array
        feedbackBox2.innerHTML = '<b>роЕроЯрпНроЯро╡рогрпИропрпИ роорпБроЯро┐роХрпНроХ 4 роирпЗро░ роородро┐рокрпНрокрпБроХро│рпИ (роиро┐рооро┐роЯроЩрпНроХро│ро┐ро▓рпН) роЙро│рпНро│ро┐роЯро╡рпБроорпН.</b>';
        plotBtn2.disabled = true; // Disable plot button initially
        xInput2.disabled = false; // Enable input
        addPointBtn2.disabled = false; // Enable add button
        xInput2.value = '';
        updateTable2();
        resizeCanvas2();
    }

    function resizeCanvas2() {
        const container = canvas2.parentElement;
        const size = Math.min(container.clientWidth - 20, container.clientHeight - 20, 800);
        canvas2.width = size;
        canvas2.height = size;
        if (graphDrawn2) {
            updateGraphBounds2();
            drawGraph2();
        } else {
             clearCanvas2();
        }
    }

    function clearCanvas2() {
        ctx2.clearRect(0, 0, canvas2.width, canvas2.height);
        ctx2.fillStyle = '#6b7280';
        ctx2.font = 'bold 16px sans-serif';
        ctx2.textAlign = 'center';
        ctx2.fillText('роирпЗро░ роородро┐рокрпНрокрпБроХро│рпИ роЙро│рпНро│ро┐роЯро╡рпБроорпН', canvas2.width / 2, canvas2.height / 2);
    }

    function updateGraphBounds2() {
        maxX2 = 360; // max time in minutes
        maxY2 = 350; // max distance in km
        xScale2 = (canvas2.width - 2 * padding2) / maxX2;
        yScale2 = (canvas2.height - 2 * padding2) / maxY2;
        timeSlider.max = maxX2;
        distSlider.max = maxY2;
    }

    function drawGraph2(drawSliderLines = true) {
        ctx2.clearRect(0, 0, canvas2.width, canvas2.height);

        if (!graphDrawn2) {
            clearCanvas2();
            return;
        }

        // Draw Scale Text
        ctx2.fillStyle = '#1f293b';
        ctx2.font = 'bold 13px sans-serif';
        ctx2.textAlign = 'right';
        ctx2.fillText('роЕро│ро╡рпБродрпНродро┐роЯрпНроЯроорпН:', canvas2.width - 20, padding2 - 15);
        ctx2.font = '13px sans-serif';
        ctx2.fillText('X-роЕроЪрпНроЪрпБ: 1 роЪрпЖ.роорпА = 30 роЕро▓роХрпБроХро│рпН', canvas2.width - 20, padding2 + 5);
        ctx2.fillText('Y-роЕроЪрпНроЪрпБ: 1 роЪрпЖ.роорпА = 50 роЕро▓роХрпБроХро│рпН', canvas2.width - 20, padding2 + 25);

        // Draw Axes
        ctx2.beginPath();
        ctx2.moveTo(padding2, padding2);
        ctx2.lineTo(padding2, canvas2.height - padding2);
        ctx2.lineTo(canvas2.width - padding2, canvas2.height - padding2);
        ctx2.strokeStyle = '#333';
        ctx2.lineWidth = 2;
        ctx2.stroke();
        drawArrow(ctx2, canvas2.width - padding2, canvas2.height - padding2, true);
        drawArrow(ctx2, padding2, padding2, false);

        // Labels
        ctx2.fillStyle = '#1e293b';
        ctx2.font = 'bold 16px sans-serif';
        ctx2.textAlign = 'center';
        ctx2.fillText('роирпЗро░роорпН (x) (роиро┐рооро┐роЯроЩрпНроХро│рпН)', canvas2.width / 2, canvas2.height - 15);
        ctx2.save();
        ctx2.translate(20, canvas2.height / 2);
        ctx2.rotate(-Math.PI / 2);
        ctx2.fillText('родрпВро░роорпН (y) (роХро┐.роорпА)', 0, 0);
        ctx2.restore();

        // Ticks and Gridlines
        ctx2.font = 'bold 12px sans-serif';
        ctx2.textAlign = 'center';
        ctx2.textBaseline = 'top';

        // X-Axis
        for (let i = 0; i <= maxX2; i += 30) {
            const x = padding2 + i * xScale2;
            ctx2.fillStyle = '#1e293b';
            ctx2.fillText(i, x, canvas2.height - padding2 + 10);
            if (i > 0) {
                ctx2.beginPath();
                ctx2.moveTo(x, canvas2.height - padding2);
                ctx2.lineTo(x, padding2);
                ctx2.lineWidth = 1; ctx2.strokeStyle = '#e2e8f0'; ctx2.stroke();
            }
        }

        // Y-Axis
        ctx2.textAlign = 'right';
        ctx2.textBaseline = 'middle';
        for (let i = 0; i <= maxY2; i += 50) {
            const y = canvas2.height - padding2 - i * yScale2;
            if (i >= 0) {
                ctx2.fillStyle = '#1e293b';
                ctx2.fillText(i, padding2 - 10, y);
                if (i > 0) {
                  ctx2.beginPath();
                  ctx2.moveTo(padding2, y);
                  ctx2.lineTo(canvas2.width - padding2, y);
                  ctx2.lineWidth = 1; ctx2.strokeStyle = '#e2e8f0'; ctx2.stroke();
                }
            }
        }

        userPlottedPoints2.forEach(p => {
            drawPoint2(p.t, p.d, '#4f46e5', 8);
        });
        
        // Draw permanent coordinate labels for correctly plotted points
        ctx2.font = 'bold 14px sans-serif';
        ctx2.fillStyle = '#1e293b';
        ctx2.textAlign = 'left';
        ctx2.textBaseline = 'bottom';
        userPlottedPoints2.forEach(p => {
            const xPos = padding2 + p.t * xScale2;
            const yPos = canvas2.height - padding2 - p.d * yScale2;
            const coordText = `(${p.t}, ${p.d})`;
            ctx2.fillText(coordText, xPos + 10, yPos - 10);
        });


        if (isToolActive2 && mouseCanvasPos2.x > 0) {
             ctx2.textAlign = 'center'; 
             ctx2.textBaseline = 'top';
             ctx2.font = '32px sans-serif';
             ctx2.fillStyle = isNearTarget2 ? '#10b981' : '#ef4444';
             ctx2.fillText('ЁЯСЖ', mouseCanvasPos2.x, mouseCanvasPos2.y);
             
             const coordText = `(${snappedGraphPos2.x.toFixed(0)}, ${snappedGraphPos2.y.toFixed(0)})`;
            
             ctx2.font = 'bold 20px monospace';
             ctx2.textAlign = 'left';
             ctx2.textBaseline = 'middle';
             const textMetrics = ctx2.measureText(coordText);
            
             const tailXBase = mouseCanvasPos2.x;
             const tailY = mouseCanvasPos2.y + 15;
             let rectX, textX;

             rectX = tailXBase + 20;
             textX = rectX + 5;

             if (rectX + textMetrics.width + 10 > canvas2.width) {
                 rectX = tailXBase - 20 - textMetrics.width - 10;
                 textX = rectX + 5;
             }
             
             ctx2.fillStyle = isNearTarget2 ? 'rgba(16, 185, 129, 0.9)' : 'rgba(30, 41, 59, 0.8)';
             ctx2.beginPath();
             ctx2.roundRect(rectX, tailY - 14, textMetrics.width + 10, 28, 7);
             ctx2.fill();
            
             ctx2.fillStyle = '#ffffff';
             ctx2.fillText(coordText, textX, tailY);

             ctx2.textAlign = 'center';
             ctx2.textBaseline = 'alphabetic';
             ctx2.fillStyle = '#1e293b';
        }

        if (lineDrawn2) {
            drawLine2();
            if(drawSliderLines && !isAnimating2) {
                drawTimeSliderVisuals();
                drawDistSliderVisuals();
            }
        }
    }
    
    function drawPoint2(t, d, color = '#4f46e5', radius = 6) {
        if (t > maxX2 || d > maxY2) return;
        const x = padding2 + t * xScale2;
        const y = canvas2.height - padding2 - d * yScale2;
        ctx2.beginPath();
        ctx2.arc(x, y, radius, 0, Math.PI * 2);
        ctx2.fillStyle = color;
        ctx2.fill();
        ctx2.strokeStyle = 'white'; ctx2.lineWidth = 2; ctx2.stroke();
    }
    
    function startManualPlotting2() {
        graphDrawn2 = true;
        plottingMode2 = true;
        currentPointIndex2 = 0;
        plotBtn2.disabled = true;
        updateGraphBounds2();
        drawGraph2();
        plotToolActivator2.classList.remove('hidden');
        activatorFinger2.addEventListener('click', activatePlottingTool2, { once: true });
        updateFeedbackForPlotting2();
    }
    
    function activatePlottingTool2() {
        isToolActive2 = true;
        document.body.classList.add('no-select');
        canvas2.classList.add('plotting-active');
        plotToolActivator2.classList.add('hidden');
        updateFeedbackForPlotting2();

        plotMoveHandler2 = (e) => plotMove(e, 2);
        touchMoveHandler2 = (e) => plotMove(e, 2);
        plotClickHandler2 = (e) => handlePlotClick(e, 2);

        document.addEventListener('mousemove', plotMoveHandler2);
        document.addEventListener('touchmove', touchMoveHandler2, { passive: false });
        canvas2.addEventListener('click', plotClickHandler2);
    }
    
    function updateFeedbackForPlotting2() {
        if (currentPointIndex2 < data2.length) {
            const target = data2[currentPointIndex2];
            feedbackBox2.innerHTML = `рокрпБро│рпНро│ро┐ роХрпБро▒ро┐роХрпНроХрпБроорпН роХро░рпБро╡ро┐ропрпИ роЕро┤рпБродрпНродро┐, ро╡ро░рпИрокроЯродрпНродро┐ро▓рпН <b>(${target.t}, ${target.d})</b> роОройрпНро▒ рокрпБро│рпНро│ро┐ропрпИроХрпН роХрогрпНроЯро▒ро┐ропро╡рпБроорпН.`;
        }
    }

    function drawLine2() {
        if (!pointsPlotted2) return;
        const startX = padding2;
        const startY = canvas2.height - padding2;
        const endX = padding2 + maxX2 * xScale2;
        const endY = canvas2.height - padding2 - (maxX2 * proportionalityConstant) * yScale2;
        ctx2.beginPath();
        ctx2.moveTo(startX, startY);
        ctx2.lineTo(endX, endY);
        ctx2.strokeStyle = '#ef4444'; ctx2.lineWidth = 3; ctx2.stroke();
    }
    
    function drawTimeSliderVisuals() {
        if (!lineDrawn2) return;
        const time = parseFloat(timeSlider.value);
        const distance = time * proportionalityConstant;
        const x = padding2 + time * xScale2;
        const y = canvas2.height - padding2 - distance * yScale2;
        
        ctx2.beginPath(); ctx2.setLineDash([5, 5]); ctx2.strokeStyle = '#10b981'; ctx2.lineWidth = 2;
        ctx2.moveTo(x, canvas2.height - padding2); ctx2.lineTo(x, y); ctx2.lineTo(padding2, y);
        ctx2.stroke(); ctx2.setLineDash([]);
        
        drawPoint2(time, distance, '#10b981', 8);
    }

    function drawDistSliderVisuals() {
        if (!lineDrawn2) return;
        const distance = parseFloat(distSlider.value);
        const time = distance / proportionalityConstant;
        const x = padding2 + time * xScale2;
        const y = canvas2.height - padding2 - distance * yScale2;

        ctx2.beginPath(); ctx2.setLineDash([5, 5]); ctx2.strokeStyle = '#0ea5e9'; ctx2.lineWidth = 2;
        ctx2.moveTo(padding2, y); ctx2.lineTo(x, y); ctx2.lineTo(x, canvas2.height - padding2);
        ctx2.stroke(); ctx2.setLineDash([]);
        
        drawPoint2(time, distance, '#0ea5e9', 8);
    }
    
    function handleTimeSlider() {
        if (!lineDrawn2) return;
        const time = parseFloat(timeSlider.value);
        sliderValue2_time.textContent = time;
        const distance = time * proportionalityConstant;
        resultBox2_dist.innerHTML = `y = kx <br> y = (5/6) * ${time} = ${distance.toFixed(1)} роХро┐.роорпА`;
        drawGraph2();
    }

    function handleDistSlider() {
        if (!lineDrawn2) return;
        const distance = parseFloat(distSlider.value);
        sliderValue2_dist.textContent = distance;
        const time = distance / proportionalityConstant;
        resultBox2_time.innerHTML = `x = y/k <br> x = ${distance} / (5/6) = ${time.toFixed(1)} роиро┐рооро┐роЯроЩрпНроХро│рпН`;
        drawGraph2();
    }

    function updateTable2() {
        dataTableBody2.innerHTML = '';
        data2.forEach(point => {
            const row = document.createElement('tr');
            row.innerHTML = `<td>${point.t}</td><td>${point.d}</td>`;
            dataTableBody2.appendChild(row);
        });
    }

    function resetSimulation2() {
        pointsPlotted2 = false; lineDrawn2 = false; graphDrawn2 = false; plottingMode2 = false;
        isToolActive2 = false; isNearTarget2 = false; currentPointIndex2 = 0; isAnimating2 = false;
        waitForTimeClick = false; waitForDistClick = false;
        userPlottedPoints2 = [];
        snappedGraphPos2 = { x: -1, y: -1 };

        lineBtn2.disabled = true;
        questionsSection2.classList.add('hidden');
        timeSlider.value = 90;
        distSlider.value = 300;
        canvas2.classList.remove('plotting-active');
        plotToolActivator2.classList.add('hidden');
        
        const newActivator = activatorFinger2.cloneNode(true);
        activatorFinger2.parentNode.replaceChild(newActivator, activatorFinger2);
        activatorFinger2 = newActivator;

        initModel2();
    }
    
    // --- MODEL 3: INVERSE VARIATION ---
    function initModel3() {
        data3 = [];
        feedbackBox3.innerHTML = '<b>роЕроЯрпНроЯро╡рогрпИропрпИ роорпБроЯро┐роХрпНроХ 4 ро╡рпЗро▓рпИропро╛роЯрпНроХро│рпН (x) роородро┐рокрпНрокрпБроХро│рпИ роЙро│рпНро│ро┐роЯро╡рпБроорпН.</b>';
        plotBtn3.disabled = true;
        lineBtn3.disabled = true;
        xInput3.disabled = false;
        addPointBtn3.disabled = false;
        xInput3.value = '';
        updateTable3();
        resizeCanvas3();
    }

    function resizeCanvas3() {
        const container = canvas3.parentElement;
        const size = Math.min(container.clientWidth - 20, container.clientHeight - 20, 800);
        canvas3.width = size;
        canvas3.height = size;
        if (graphDrawn3) {
            updateGraphBounds3();
            drawGraph3();
        } else {
             clearCanvas3();
        }
    }

    function clearCanvas3() {
        ctx3.clearRect(0, 0, canvas3.width, canvas3.height);
        ctx3.fillStyle = '#6b7280';
        ctx3.font = 'bold 16px sans-serif';
        ctx3.textAlign = 'center';
        ctx3.fillText('ро╡ро░рпИрокроЯродрпНродрпИ ро╡ро░рпИропро╡рпБроорпН', canvas3.width / 2, canvas3.height / 2);
    }
    
    function updateGraphBounds3() {
        maxX3 = 200; 
        maxY3 = 300;
        xScale3 = (canvas3.width - 2 * padding3) / maxX3;
        yScale3 = (canvas3.height - 2 * padding3) / maxY3;
        workersSlider3.max = maxX3;
        daysSlider3.max = maxY3;
    }
    
    function drawGraph3(drawSliderLines = true) {
        ctx3.clearRect(0, 0, canvas3.width, canvas3.height);

        if (!graphDrawn3) {
            clearCanvas3();
            return;
        }

        // Draw Scale Text
        ctx3.fillStyle = '#1f293b';
        ctx3.font = 'bold 13px sans-serif';
        ctx3.textAlign = 'right';
        ctx3.fillText('роЕро│ро╡рпБродрпНродро┐роЯрпНроЯроорпН:', canvas3.width - 20, padding3 - 15);
        ctx3.font = '13px sans-serif';
        ctx3.fillText('X-роЕроЪрпНроЪрпБ: 1 роЪрпЖ.роорпА = 20 роЕро▓роХрпБроХро│рпН', canvas3.width - 20, padding3 + 5);
        ctx3.fillText('Y-роЕроЪрпНроЪрпБ: 1 роЪрпЖ.роорпА = 25 роЕро▓роХрпБроХро│рпН', canvas3.width - 20, padding3 + 25);

        // Axes and Labels
        ctx3.beginPath();
        ctx3.moveTo(padding3, padding3);
        ctx3.lineTo(padding3, canvas3.height - padding3);
        ctx3.lineTo(canvas3.width - padding3, canvas3.height - padding3);
        ctx3.strokeStyle = '#333'; ctx3.lineWidth = 2; ctx3.stroke();
        drawArrow(ctx3, canvas3.width - padding3, canvas3.height - padding3, true);
        drawArrow(ctx3, padding3, padding3, false);
        ctx3.fillStyle = '#1e293b'; ctx3.font = 'bold 16px sans-serif'; ctx3.textAlign = 'center';
        ctx3.fillText('ро╡рпЗро▓рпИропро╛роЯрпНроХро│рпН (x)', canvas3.width / 2, canvas3.height - 15);
        ctx3.save();
        ctx3.translate(20, canvas3.height / 2);
        ctx3.rotate(-Math.PI / 2);
        ctx3.fillText('роиро╛роЯрпНроХро│рпН (y)', 0, 0);
        ctx3.restore();

        // Ticks and Gridlines
        ctx3.font = 'bold 12px sans-serif';
        ctx3.textAlign = 'center'; ctx3.textBaseline = 'top';
        for (let i = 0; i <= maxX3; i += 20) {
            const x = padding3 + i * xScale3;
            ctx3.fillStyle = '#1e293b';
            ctx3.fillText(i, x, canvas3.height - padding3 + 10);
            if (i > 0) {
                ctx3.beginPath(); ctx3.moveTo(x, canvas3.height - padding3);
                ctx3.lineTo(x, padding3);
                ctx3.lineWidth = 1; ctx3.strokeStyle = '#e2e8f0'; ctx3.stroke();
            }
        }
        ctx3.textAlign = 'right'; ctx3.textBaseline = 'middle';
        for (let i = 0; i <= maxY3; i += 25) {
            const y = canvas3.height - padding3 - i * yScale3;
            if (i >= 0) {
                ctx3.fillStyle = '#1e293b';
                ctx3.fillText(i, padding3 - 10, y);
                if (i > 0) {
                    ctx3.beginPath(); ctx3.moveTo(padding3, y);
                    ctx3.lineTo(canvas3.width - padding3, y);
                    ctx3.lineWidth = 1; ctx3.strokeStyle = '#e2e8f0'; ctx3.stroke();
                }
            }
        }

        userPlottedPoints3.forEach(p => drawPoint3(p.x, p.y, '#4f46e5', 8));
        
        ctx3.font = 'bold 14px sans-serif'; ctx3.fillStyle = '#1e293b';
        ctx3.textAlign = 'left'; ctx3.textBaseline = 'bottom';
        userPlottedPoints3.forEach(p => {
            const xPos = padding3 + p.x * xScale3;
            const yPos = canvas3.height - padding3 - p.y * yScale3;
            ctx3.fillText(`(${p.x}, ${p.y})`, xPos + 10, yPos - 10);
        });

        if (isToolActive3 && mouseCanvasPos3.x > 0) {
             ctx3.textAlign = 'center'; ctx3.textBaseline = 'top'; ctx3.font = '32px sans-serif';
             ctx3.fillStyle = isNearTarget3 ? '#10b981' : '#ef4444';
             ctx3.fillText('ЁЯСЖ', mouseCanvasPos3.x, mouseCanvasPos3.y);
             const coordText = `(${snappedGraphPos3.x}, ${snappedGraphPos3.y})`;
             ctx3.font = 'bold 20px monospace'; ctx3.textAlign = 'left'; ctx3.textBaseline = 'middle';
             const textMetrics = ctx3.measureText(coordText);
             const tailXBase = mouseCanvasPos3.x; const tailY = mouseCanvasPos3.y + 15;
             let rectX = tailXBase + 20; let textX = rectX + 5;
             if (rectX + textMetrics.width + 10 > canvas3.width) {
                 rectX = tailXBase - 20 - textMetrics.width - 10; textX = rectX + 5;
             }
             ctx3.fillStyle = isNearTarget3 ? 'rgba(16, 185, 129, 0.9)' : 'rgba(30, 41, 59, 0.8)';
             ctx3.beginPath();
             ctx3.roundRect(rectX, tailY - 14, textMetrics.width + 10, 28, 7);
             ctx3.fill();
             ctx3.fillStyle = '#ffffff'; ctx3.fillText(coordText, textX, tailY);
        }

        if (lineDrawn3) {
            drawLine3();
            if(drawSliderLines && !isAnimating3){
                drawWorkersSliderVisuals();
                drawDaysSliderVisuals();
            }
        }
    }

    function drawPoint3(xVal, yVal, color = '#4f46e5', radius = 6) {
        if (xVal > maxX3 || yVal > maxY3) return;
        const x = padding3 + xVal * xScale3;
        const y = canvas3.height - padding3 - yVal * yScale3;
        ctx3.beginPath(); ctx3.arc(x, y, radius, 0, Math.PI * 2);
        ctx3.fillStyle = color; ctx3.fill();
        ctx3.strokeStyle = 'white'; ctx3.lineWidth = 2; ctx3.stroke();
    }
    
    function startManualPlotting3() {
        graphDrawn3 = true; plottingMode3 = true; currentPointIndex3 = 0; userPlottedPoints3 = [];
        plotBtn3.disabled = true;
        updateGraphBounds3();
        drawGraph3();
        plotToolActivator3.classList.remove('hidden');
        activatorFinger3.addEventListener('click', activatePlottingTool3, { once: true });
        updateFeedbackForPlotting3();
    }
    
    function activatePlottingTool3() {
        isToolActive3 = true; document.body.classList.add('no-select');
        canvas3.classList.add('plotting-active');
        plotToolActivator3.classList.add('hidden');
        updateFeedbackForPlotting3();
        plotMoveHandler3 = (e) => plotMove(e, 3);
        touchMoveHandler3 = (e) => plotMove(e, 3);
        plotClickHandler3 = (e) => handlePlotClick(e, 3);
        document.addEventListener('mousemove', plotMoveHandler3);
        document.addEventListener('touchmove', touchMoveHandler3, { passive: false });
        canvas3.addEventListener('click', plotClickHandler3);
    }
    
    function updateFeedbackForPlotting3() {
        if (currentPointIndex3 < data3.length) {
            const target = data3[currentPointIndex3];
            feedbackBox3.innerHTML = `рокрпБро│рпНро│ро┐ роХрпБро▒ро┐роХрпНроХрпБроорпН роХро░рпБро╡ро┐ропрпИ роЕро┤рпБродрпНродро┐, ро╡ро░рпИрокроЯродрпНродро┐ро▓рпН <b>(${target.x}, ${target.y})</b> роОройрпНро▒ рокрпБро│рпНро│ро┐ропрпИроХрпН роХрогрпНроЯро▒ро┐ропро╡рпБроорпН.`;
        }
    }

    function drawLine3() {
        if (!pointsPlotted3) return;
        ctx3.beginPath();
        ctx3.strokeStyle = '#ef4444'; ctx3.lineWidth = 3;
        let firstPoint = true;
        for (let xVal = 20; xVal <= maxX3; xVal += 1) {
            const yVal = inverseConstant / xVal;
            if (yVal <= maxY3) {
                const x = padding3 + xVal * xScale3;
                const y = canvas3.height - padding3 - yVal * yScale3;
                if (firstPoint) {
                    ctx3.moveTo(x, y);
                    firstPoint = false;
                } else {
                    ctx3.lineTo(x, y);
                }
            }
        }
        ctx3.stroke();
    }
    
    function drawWorkersSliderVisuals() {
        if (!lineDrawn3) return;
        const workers = parseFloat(workersSlider3.value);
        const days = inverseConstant / workers;
        const x = padding3 + workers * xScale3;
        const y = canvas3.height - padding3 - days * yScale3;
        ctx3.beginPath(); ctx3.setLineDash([5, 5]); ctx3.strokeStyle = '#10b981'; ctx3.lineWidth = 2;
        ctx3.moveTo(x, canvas3.height - padding3); ctx3.lineTo(x, y); ctx3.lineTo(padding3, y);
        ctx3.stroke(); ctx3.setLineDash([]);
        drawPoint3(workers, days, '#10b981', 8);
    }

    function drawDaysSliderVisuals() {
        if (!lineDrawn3) return;
        const days = parseFloat(daysSlider3.value);
        const workers = inverseConstant / days;
        const x = padding3 + workers * xScale3;
        const y = canvas3.height - padding3 - days * yScale3;
        ctx3.beginPath(); ctx3.setLineDash([5, 5]); ctx3.strokeStyle = '#0ea5e9'; ctx3.lineWidth = 2;
        ctx3.moveTo(padding3, y); ctx3.lineTo(x, y); ctx3.lineTo(x, canvas3.height - padding3);
        ctx3.stroke(); ctx3.setLineDash([]);
        drawPoint3(workers, days, '#0ea5e9', 8);
    }
    
    function handleWorkersSlider3() {
        if (!lineDrawn3) return;
        const workers = parseFloat(workersSlider3.value);
        sliderValue3_workers.textContent = workers;
        const days = inverseConstant / workers;
        resultBox3_days.innerHTML = `y = k/x <br> y = ${inverseConstant} / ${workers} = ${days.toFixed(0)} роиро╛роЯрпНроХро│рпН`;
        drawGraph3();
    }

    function handleDaysSlider3() {
        if (!lineDrawn3) return;
        const days = parseFloat(daysSlider3.value);
        sliderValue3_days.textContent = days;
        const workers = inverseConstant / days;
        resultBox3_workers.innerHTML = `x = k/y <br> x = ${inverseConstant} / ${days} = ${workers.toFixed(0)} ро╡рпЗро▓рпИропро╛роЯрпНроХро│рпН`;
        drawGraph3();
    }

    function updateTable3() {
        dataTableBody3.innerHTML = '';
        data3.forEach(point => {
            const row = document.createElement('tr');
            row.innerHTML = `<td>${point.x}</td><td>${point.y}</td>`;
            dataTableBody3.appendChild(row);
        });
    }

    function resetSimulation3() {
        pointsPlotted3 = false; lineDrawn3 = false; graphDrawn3 = false; plottingMode3 = false;
        isToolActive3 = false; isNearTarget3 = false; currentPointIndex3 = 0; isAnimating3 = false;
        waitForWorkersClick = false; waitForDaysClick = false;
        userPlottedPoints3 = [];
        snappedGraphPos3 = { x: -1, y: -1 };
        lineBtn3.disabled = true;
        questionsSection3.classList.add('hidden');
        workersSlider3.value = 120;
        daysSlider3.value = 200;
        canvas3.classList.remove('plotting-active');
        plotToolActivator3.classList.add('hidden');
        const newActivator = activatorFinger3.cloneNode(true);
        activatorFinger3.parentNode.replaceChild(newActivator, activatorFinger3);
        activatorFinger3 = newActivator;
        initModel3();
    }

    // --- MODEL 4: xy = 24 ---
    function initModel4() {
        data4 = [];
        feedbackBox4.innerHTML = '<b>xy = 24-роХрпНроХро╛рой роЕроЯрпНроЯро╡рогрпИропрпИ роорпБроЯро┐роХрпНроХ 24-ройрпН 8 роХро╛ро░рогро┐роХро│рпИ (1, 2, 3, 4, 6, 8, 12, 24) роЙро│рпНро│ро┐роЯро╡рпБроорпН.</b>';
        plotBtn4.disabled = true;
        generatePointsBtn4.disabled = true;
        lineBtn4.disabled = true;
        xInput4.disabled = false;
        addPointBtn4.disabled = false;
        xInput4.value = '';
        coordinatesDisplay4.classList.add('hidden');
        coordinatesDisplay4.innerHTML = '';
        updateTable4();
        resizeCanvas4();
    }

    function resizeCanvas4() {
        const container = canvas4.parentElement;
        const size = Math.min(container.clientWidth - 20, container.clientHeight - 20, 800);
        canvas4.width = size;
        canvas4.height = size;
        if (graphDrawn4) {
            updateGraphBounds4();
            drawGraph4();
        } else {
             clearCanvas4();
        }
    }

    function clearCanvas4() {
        ctx4.clearRect(0, 0, canvas4.width, canvas4.height);
        ctx4.fillStyle = '#6b7280';
        ctx4.font = 'bold 16px sans-serif';
        ctx4.textAlign = 'center';
        ctx4.fillText('ро╡ро░рпИрокроЯродрпНродрпИ ро╡ро░рпИропро╡рпБроорпН', canvas4.width / 2, canvas4.height / 2);
    }
    
    function updateGraphBounds4() {
        maxX4 = 25; 
        maxY4 = 25;
        xScale4 = (canvas4.width - 2 * padding4) / maxX4;
        yScale4 = (canvas4.height - 2 * padding4) / maxY4;
        xSlider4.max = maxX4;
        ySlider4.max = maxY4;
    }
    
    function drawGraph4(drawSliderLines = true) {
        ctx4.clearRect(0, 0, canvas4.width, canvas4.height);

        if (!graphDrawn4) {
            clearCanvas4();
            return;
        }

        // Draw Scale Text
        ctx4.fillStyle = '#1f293b';
        ctx4.font = 'bold 13px sans-serif';
        ctx4.textAlign = 'right';
        ctx4.fillText('роЕро│ро╡рпБродрпНродро┐роЯрпНроЯроорпН:', canvas4.width - 20, padding4 - 15);
        ctx4.font = '13px sans-serif';
        ctx4.fillText('X-роЕроЪрпНроЪрпБ: 1 роЪрпЖ.роорпА = 2 роЕро▓роХрпБроХро│рпН', canvas4.width - 20, padding4 + 5);
        ctx4.fillText('Y-роЕроЪрпНроЪрпБ: 1 роЪрпЖ.роорпА = 2 роЕро▓роХрпБроХро│рпН', canvas4.width - 20, padding4 + 25);

        // Axes and Labels
        ctx4.beginPath();
        ctx4.moveTo(padding4, padding4);
        ctx4.lineTo(padding4, canvas4.height - padding4);
        ctx4.lineTo(canvas4.width - padding4, canvas4.height - padding4);
        ctx4.strokeStyle = '#333'; ctx4.lineWidth = 2; ctx4.stroke();
        drawArrow(ctx4, canvas4.width - padding4, canvas4.height - padding4, true);
        drawArrow(ctx4, padding4, padding4, false);
        ctx4.fillStyle = '#1e293b'; ctx4.font = 'bold 16px sans-serif'; ctx4.textAlign = 'center';
        ctx4.fillText('x', canvas4.width / 2, canvas4.height - 15);
        ctx4.save();
        ctx4.translate(20, canvas4.height / 2);
        ctx4.rotate(-Math.PI / 2);
        ctx4.fillText('y', 0, 0);
        ctx4.restore();

        // Ticks and Gridlines
        ctx4.font = 'bold 12px sans-serif';
        ctx4.textAlign = 'center'; ctx4.textBaseline = 'top';
        for (let i = 0; i <= maxX4; i += 2) {
            const x = padding4 + i * xScale4;
            ctx4.fillStyle = '#1e293b';
            ctx4.fillText(i, x, canvas4.height - padding4 + 10);
            if (i > 0) {
                ctx4.beginPath(); ctx4.moveTo(x, canvas4.height - padding4);
                ctx4.lineTo(x, padding4);
                ctx4.lineWidth = 1; ctx4.strokeStyle = '#e2e8f0'; ctx4.stroke();
            }
        }
        ctx4.textAlign = 'right'; ctx4.textBaseline = 'middle';
        for (let i = 0; i <= maxY4; i += 2) {
            const y = canvas4.height - padding4 - i * yScale4;
            if (i > 0) {
                ctx4.fillStyle = '#1e293b';
                ctx4.fillText(i, padding4 - 10, y);
                ctx4.beginPath(); ctx4.moveTo(padding4, y);
                ctx4.lineTo(canvas4.width - padding4, y);
                ctx4.lineWidth = 1; ctx4.strokeStyle = '#e2e8f0'; ctx4.stroke();
            }
        }

        userPlottedPoints4.forEach(p => drawPoint4(p.x, p.y, '#4f46e5', 8));
        
        ctx4.font = 'bold 14px sans-serif'; ctx4.fillStyle = '#1e293b';
        ctx4.textAlign = 'left'; ctx4.textBaseline = 'bottom';
        userPlottedPoints4.forEach(p => {
            const xPos = padding4 + p.x * xScale4;
            const yPos = canvas4.height - padding4 - p.y * yScale4;
            ctx4.fillText(`(${p.x}, ${p.y})`, xPos + 10, yPos - 10);
        });

        if (isToolActive4 && mouseCanvasPos4.x > 0) {
             ctx4.textAlign = 'center'; ctx4.textBaseline = 'top'; ctx4.font = '32px sans-serif';
             ctx4.fillStyle = isNearTarget4 ? '#10b981' : '#ef4444';
             ctx4.fillText('ЁЯСЖ', mouseCanvasPos4.x, mouseCanvasPos4.y);
             const coordText = `(${snappedGraphPos4.x}, ${snappedGraphPos4.y})`;
             ctx4.font = 'bold 20px monospace'; ctx4.textAlign = 'left'; ctx4.textBaseline = 'middle';
             const textMetrics = ctx4.measureText(coordText);
             const tailXBase = mouseCanvasPos4.x; const tailY = mouseCanvasPos4.y + 15;
             let rectX = tailXBase + 20; let textX = rectX + 5;
             if (rectX + textMetrics.width + 10 > canvas4.width) {
                 rectX = tailXBase - 20 - textMetrics.width - 10; textX = rectX + 5;
             }
             ctx4.fillStyle = isNearTarget4 ? 'rgba(16, 185, 129, 0.9)' : 'rgba(30, 41, 59, 0.8)';
             ctx4.beginPath();
             ctx4.roundRect(rectX, tailY - 14, textMetrics.width + 10, 28, 7);
             ctx4.fill();
             ctx4.fillStyle = '#ffffff'; ctx4.fillText(coordText, textX, tailY);
        }

        if (lineDrawn4) {
            drawLine4();
            if(drawSliderLines && !isAnimating4){
                drawXSliderVisuals4();
                drawYSliderVisuals4();
            }
        }
    }

    function drawPoint4(xVal, yVal, color = '#4f46e5', radius = 6) {
        if (xVal > maxX4 || yVal > maxY4 || xVal <=0 || yVal <= 0) return;
        const x = padding4 + xVal * xScale4;
        const y = canvas4.height - padding4 - yVal * yScale4;
        ctx4.beginPath(); ctx4.arc(x, y, radius, 0, Math.PI * 2);
        ctx4.fillStyle = color; ctx4.fill();
        ctx4.strokeStyle = 'white'; ctx4.lineWidth = 2; ctx4.stroke();
    }
    
    function startManualPlotting4() {
        graphDrawn4 = true; plottingMode4 = true; currentPointIndex4 = 0;
        // Sort data before plotting
        data4.sort((a,b) => a.x - b.x);
        userPlottedPoints4 = [];
        plotBtn4.disabled = true;
        updateGraphBounds4();
        drawGraph4();
        plotToolActivator4.classList.remove('hidden');
        activatorFinger4.addEventListener('click', activatePlottingTool4, { once: true });
        updateFeedbackForPlotting4();
    }
    
    function activatePlottingTool4() {
        isToolActive4 = true; document.body.classList.add('no-select');
        canvas4.classList.add('plotting-active');
        plotToolActivator4.classList.add('hidden');
        updateFeedbackForPlotting4();
        plotMoveHandler4 = (e) => plotMove(e, 4);
        touchMoveHandler4 = (e) => plotMove(e, 4);
        plotClickHandler4 = (e) => handlePlotClick(e, 4);
        document.addEventListener('mousemove', plotMoveHandler4);
        document.addEventListener('touchmove', touchMoveHandler4, { passive: false });
        canvas4.addEventListener('click', plotClickHandler4);
    }
    
    function updateFeedbackForPlotting4() {
        if (currentPointIndex4 < data4.length) {
            const target = data4[currentPointIndex4];
            feedbackBox4.innerHTML = `рокрпБро│рпНро│ро┐ роХрпБро▒ро┐роХрпНроХрпБроорпН роХро░рпБро╡ро┐ропрпИ роЕро┤рпБродрпНродро┐, ро╡ро░рпИрокроЯродрпНродро┐ро▓рпН <b>(${target.x}, ${target.y})</b> роОройрпНро▒ рокрпБро│рпНро│ро┐ропрпИроХрпН роХрогрпНроЯро▒ро┐ропро╡рпБроорпН.`;
        }
    }

    function drawLine4() {
        if (!pointsPlotted4) return;
        ctx4.beginPath();
        ctx4.strokeStyle = '#ef4444'; ctx4.lineWidth = 3;
        let firstPoint = true;
        for (let xVal = 1; xVal <= maxX4; xVal += 0.1) {
            const yVal = inverseConstant4 / xVal;
            if (yVal <= maxY4) {
                const x = padding4 + xVal * xScale4;
                const y = canvas4.height - padding4 - yVal * yScale4;
                if (firstPoint) {
                    ctx4.moveTo(x, y);
                    firstPoint = false;
                } else {
                    ctx4.lineTo(x, y);
                }
            }
        }
        ctx4.stroke();
    }
    
    function drawXSliderVisuals4() {
        if (!lineDrawn4) return;
        const xVal = parseFloat(xSlider4.value);
        const yVal = inverseConstant4 / xVal;
        const x = padding4 + xVal * xScale4;
        const y = canvas4.height - padding4 - yVal * yScale4;
        ctx4.beginPath(); ctx4.setLineDash([5, 5]); ctx4.strokeStyle = '#10b981'; ctx4.lineWidth = 2;
        ctx4.moveTo(x, canvas4.height - padding4); ctx4.lineTo(x, y); ctx4.lineTo(padding4, y);
        ctx4.stroke(); ctx4.setLineDash([]);
        drawPoint4(xVal, yVal, '#10b981', 8);
    }

    function drawYSliderVisuals4() {
        if (!lineDrawn4) return;
        const yVal = parseFloat(ySlider4.value);
        const xVal = inverseConstant4 / yVal;
        const x = padding4 + xVal * xScale4;
        const y = canvas4.height - padding4 - yVal * yScale4;
        ctx4.beginPath(); ctx4.setLineDash([5, 5]); ctx4.strokeStyle = '#0ea5e9'; ctx4.lineWidth = 2;
        ctx4.moveTo(padding4, y); ctx4.lineTo(x, y); ctx4.lineTo(x, canvas4.height - padding4);
        ctx4.stroke(); ctx4.setLineDash([]);
        drawPoint4(xVal, yVal, '#0ea5e9', 8);
    }
    
    function handleXSlider4() {
        if (!lineDrawn4) return;
        const xVal = parseFloat(xSlider4.value);
        sliderValue4_x.textContent = xVal;
        const yVal = inverseConstant4 / xVal;
        resultBox4_y.innerHTML = `y = 24/x <br> y = 24 / ${xVal} = ${yVal.toFixed(1)}`;
        drawGraph4();
    }

    function handleYSlider4() {
        if (!lineDrawn4) return;
        const yVal = parseFloat(ySlider4.value);
        sliderValue4_y.textContent = yVal;
        const xVal = inverseConstant4 / yVal;
        resultBox4_x.innerHTML = `x = 24/y <br> x = 24 / ${yVal} = ${xVal.toFixed(1)}`;
        drawGraph4();
    }

    function updateTable4() {
        dataTableBody4.innerHTML = '';
        data4.sort((a, b) => a.x - b.x).forEach(point => {
            const row = document.createElement('tr');
            row.innerHTML = `<td>${point.x}</td><td>&times;</td><td>${point.y}</td><td>=</td><td>24</td>`;
            dataTableBody4.appendChild(row);
        });
    }

    function resetSimulation4() {
        pointsPlotted4 = false; lineDrawn4 = false; graphDrawn4 = false; plottingMode4 = false;
        isToolActive4 = false; isNearTarget4 = false; currentPointIndex4 = 0; isAnimating4 = false;
        waitForXClick4 = false; waitForYClick4 = false;
        userPlottedPoints4 = [];
        snappedGraphPos4 = { x: -1, y: -1 };
        lineBtn4.disabled = true;
        questionsSection4.classList.add('hidden');
        xSlider4.value = 3;
        ySlider4.value = 6;
        canvas4.classList.remove('plotting-active');
        plotToolActivator4.classList.add('hidden');
        const newActivator = activatorFinger4.cloneNode(true);
        activatorFinger4.parentNode.replaceChild(newActivator, activatorFinger4);
        activatorFinger4 = newActivator;
        
        coordinatesDisplay4.classList.add('hidden');
        coordinatesDisplay4.innerHTML = '';

        initModel4();
    }
    
    // --- MODEL 5: MARATHON SIMULATION ---
    function initModel5() {
        data5 = [
            { name: 'роиро┐ро╖ро╛роирпНродрпН', speed: 12, time: 1, icon: 'ЁЯПГтАНтЩВя╕П' },
            { name: 'роЖро░ро╛родройро╛', speed: 6, time: 2, icon: 'ЁЯПГтАНтЩАя╕П' },
            { name: 'роЬрпЖропроирпНродрпН', speed: 4, time: 3, icon: 'ЁЯПГтАНтЩВя╕П' },
            { name: 'роЪродрпНропро╛', speed: 3, time: 4, icon: 'ЁЯПГтАНтЩАя╕П' },
            { name: 'ро╕рпНро╡рпЗродро╛', speed: 2, time: 6, icon: 'ЁЯПГтАНтЩАя╕П' }
        ];
        
        pointsPlotted5 = false; lineDrawn5 = false; graphDrawn5 = false; plottingMode5 = false;
        isToolActive5 = false; isNearTarget5 = false; currentPointIndex5 = 0;
        isAnimating5 = false; waitForSpeedClick = false;
        userPlottedPoints5 = [];
        snappedGraphPos5 = { x: -1, y: -1 };

        plotBtn5.disabled = false;
        lineBtn5.disabled = true;
        questionsSection5.classList.add('hidden');
        speedSlider5.value = 2.4;
        sliderValue5_speed.textContent = '2.4';
        
        feedbackBox5.innerHTML = '<b>ро╡ро░рпИрокроЯродрпНродро┐ро▓рпН рокрпБро│рпНро│ро┐роХро│рпИроХрпН роХрпБро▒ро┐роХрпНроХ, "рокрпБро│рпНро│ро┐роХро│рпИроХрпН роХрпБро▒ро┐роХрпНроХро╡рпБроорпН" рокрпКродрпНродро╛ройрпИ роЕро┤рпБродрпНродро╡рпБроорпН.</b>';
        updateTable5();
        resizeCanvas5();
    }
    
    function updateTable5() {
        dataTableBody5.innerHTML = '';
        data5.forEach(runner => {
            const row = document.createElement('tr');
            row.innerHTML = `<td>${runner.icon} ${runner.name}</td><td>${runner.speed}</td><td>${runner.time}</td>`;
            dataTableBody5.appendChild(row);
        });
    }
    
    function resizeCanvas5() {
        const container = canvas5.parentElement;
        const size = Math.min(container.clientWidth - 20, container.clientHeight - 20, 800);
        canvas5.width = size;
        canvas5.height = size;
        if (graphDrawn5) {
            updateGraphBounds5();
            drawGraph5();
        } else {
             clearCanvas5();
        }
    }
    
    function clearCanvas5() {
        ctx5.clearRect(0, 0, canvas5.width, canvas5.height);
        ctx5.fillStyle = '#6b7280';
        ctx5.font = 'bold 16px sans-serif';
        ctx5.textAlign = 'center';
        ctx5.fillText('ро╡ро░рпИрокроЯродрпНродрпИ ро╡ро░рпИропро╡рпБроорпН', canvas5.width / 2, canvas5.height / 2);
    }

    function updateGraphBounds5() {
        maxX5 = 13; // Speed
        maxY5 = 7; // Time
        xScale5 = (canvas5.width - 2 * padding5) / maxX5;
        yScale5 = (canvas5.height - 2 * padding5) / maxY5;
    }
    
    function drawGraph5() {
        ctx5.clearRect(0, 0, canvas5.width, canvas5.height);

        if (!graphDrawn5) {
            clearCanvas5();
            return;
        }

        // Scale Text
        ctx5.fillStyle = '#1f293b';
        ctx5.font = 'bold 13px sans-serif';
        ctx5.textAlign = 'right';
        ctx5.fillText('роЕро│ро╡рпБродрпНродро┐роЯрпНроЯроорпН:', canvas5.width - 20, padding5 - 15);
        ctx5.font = '13px sans-serif';
        ctx5.fillText('X-роЕроЪрпНроЪрпБ: 1 роЪрпЖ.роорпА = 1 роЕро▓роХрпБ', canvas5.width - 20, padding5 + 5);
        ctx5.fillText('Y-роЕроЪрпНроЪрпБ: 1 роЪрпЖ.роорпА = 1 роЕро▓роХрпБ', canvas5.width - 20, padding5 + 25);

        // Axes and Labels
        ctx5.beginPath();
        ctx5.moveTo(padding5, padding5);
        ctx5.lineTo(padding5, canvas5.height - padding5);
        ctx5.lineTo(canvas5.width - padding5, canvas5.height - padding5);
        ctx5.strokeStyle = '#333'; ctx5.lineWidth = 2; ctx5.stroke();
        drawArrow(ctx5, canvas5.width - padding5, canvas5.height - padding5, true);
        drawArrow(ctx5, padding5, padding5, false);
        ctx5.fillStyle = '#1e293b'; ctx5.font = 'bold 16px sans-serif'; ctx5.textAlign = 'center';
        ctx5.fillText('ро╡рпЗроХроорпН (x) (роХро┐.роорпА/роорогро┐)', canvas5.width / 2, canvas5.height - 15);
        ctx5.save();
        ctx5.translate(20, canvas5.height / 2);
        ctx5.rotate(-Math.PI / 2);
        ctx5.fillText('роирпЗро░роорпН (y) (роорогро┐)', 0, 0);
        ctx5.restore();

        // Ticks and Gridlines
        ctx5.font = 'bold 12px sans-serif';
        ctx5.textAlign = 'center'; ctx5.textBaseline = 'top';
        for (let i = 0; i <= maxX5; i++) {
            const x = padding5 + i * xScale5;
            ctx5.fillStyle = '#1e293b';
            ctx5.fillText(i, x, canvas5.height - padding5 + 10);
            if (i > 0) {
                ctx5.beginPath(); ctx5.moveTo(x, canvas5.height - padding5);
                ctx5.lineTo(x, padding5);
                ctx5.lineWidth = 1; ctx5.strokeStyle = '#e2e8f0'; ctx5.stroke();
            }
        }
        ctx5.textAlign = 'right'; ctx5.textBaseline = 'middle';
        for (let i = 0; i <= maxY5; i++) {
            const y = canvas5.height - padding5 - i * yScale5;
            if (i > 0) {
                ctx5.fillStyle = '#1e293b';
                ctx5.fillText(i, padding5 - 10, y);
                ctx5.beginPath(); ctx5.moveTo(padding5, y);
                ctx5.lineTo(canvas5.width - padding5, y);
                ctx5.lineWidth = 1; ctx5.strokeStyle = '#e2e8f0'; ctx5.stroke();
            }
        }

        userPlottedPoints5.forEach(p => drawPoint5(p.speed, p.time, '#4f46e5', 8));
        
        ctx5.font = 'bold 14px sans-serif'; ctx5.fillStyle = '#1e293b';
        ctx5.textAlign = 'left'; ctx5.textBaseline = 'bottom';
        userPlottedPoints5.forEach(p => {
            const xPos = padding5 + p.speed * xScale5;
            const yPos = canvas5.height - padding5 - p.time * yScale5;
            ctx5.fillText(`(${p.speed}, ${p.time})`, xPos + 10, yPos - 10);
        });

        if (isToolActive5 && mouseCanvasPos5.x > 0) {
             ctx5.textAlign = 'center'; ctx5.textBaseline = 'top'; ctx5.font = '32px sans-serif';
             const isCorrect = isNearTarget5;
             
             ctx5.fillStyle = isCorrect ? '#10b981' : '#ef4444';
             ctx5.fillText('ЁЯСЖ', mouseCanvasPos5.x, mouseCanvasPos5.y);
             const coordText = `(${snappedGraphPos5.x.toFixed(1)}, ${snappedGraphPos5.y.toFixed(1)})`;
             ctx5.font = 'bold 20px monospace'; ctx5.textAlign = 'left'; ctx5.textBaseline = 'middle';
             const textMetrics = ctx5.measureText(coordText);
             const tailXBase = mouseCanvasPos5.x; const tailY = mouseCanvasPos5.y + 15;
             let rectX = tailXBase + 20; let textX = rectX + 5;
             if (rectX + textMetrics.width + 10 > canvas5.width) {
                 rectX = tailXBase - 20 - textMetrics.width - 10; textX = rectX + 5;
             }
             ctx5.fillStyle = isCorrect ? 'rgba(16, 185, 129, 0.9)' : 'rgba(30, 41, 59, 0.8)';
             ctx5.beginPath();
             ctx5.roundRect(rectX, tailY - 14, textMetrics.width + 10, 28, 7);
             ctx5.fill();
             ctx5.fillStyle = '#ffffff'; ctx5.fillText(coordText, textX, tailY);
        }

        if (lineDrawn5) {
            drawLine5();
             if (!isAnimating5) {
                drawSpeedSliderVisuals5();
            }
        }
    }
    
    function drawPoint5(speed, time, color = '#4f46e5', radius = 6) {
        if (speed > maxX5 || time > maxY5) return;
        const x = padding5 + speed * xScale5;
        const y = canvas5.height - padding5 - time * yScale5;
        ctx5.beginPath(); ctx5.arc(x, y, radius, 0, Math.PI * 2);
        ctx5.fillStyle = color; ctx5.fill();
        ctx5.strokeStyle = 'white'; ctx5.lineWidth = 2; ctx5.stroke();
    }
    
    function startManualPlotting5() {
        graphDrawn5 = true; plottingMode5 = true; currentPointIndex5 = 0; userPlottedPoints5 = [];
        plotBtn5.disabled = true;
        updateGraphBounds5();
        drawGraph5();
        plotToolActivator5.classList.remove('hidden');
        activatorFinger5.addEventListener('click', activatePlottingTool5, { once: true });
        updateFeedbackForPlotting5();
    }
    
    function activatePlottingTool5() {
        isToolActive5 = true; document.body.classList.add('no-select');
        canvas5.classList.add('plotting-active');
        plotToolActivator5.classList.add('hidden');
        updateFeedbackForPlotting5();
        plotMoveHandler5 = (e) => plotMove(e, 5);
        touchMoveHandler5 = (e) => plotMove(e, 5);
        plotClickHandler5 = (e) => handlePlotClick(e, 5);
        document.addEventListener('mousemove', plotMoveHandler5);
        document.addEventListener('touchmove', touchMoveHandler5, { passive: false });
        canvas5.addEventListener('click', plotClickHandler5);
    }
    
    function updateFeedbackForPlotting5() {
        if (currentPointIndex5 < data5.length) {
            const target = data5[currentPointIndex5];
            feedbackBox5.innerHTML = `${target.icon} <b>${target.name}</b>-роЗройрпН рокрпБро│рпНро│ро┐ропрпИроХрпН роХрпБро▒ро┐роХрпНроХро╡рпБроорпН: <b>(${target.speed}, ${target.time})</b>`;
        }
    }

    function drawLine5() {
        if (!pointsPlotted5) return;
        ctx5.beginPath();
        ctx5.strokeStyle = '#ef4444'; ctx5.lineWidth = 3;
        let firstPoint = true;
        for (let xVal = 1; xVal <= maxX5; xVal += 0.1) {
            const yVal = inverseConstant5 / xVal;
            if (yVal <= maxY5 && yVal > 0) {
                const x = padding5 + xVal * xScale5;
                const y = canvas5.height - padding5 - yVal * yScale5;
                if (firstPoint) {
                    ctx5.moveTo(x, y);
                    firstPoint = false;
                } else {
                    ctx5.lineTo(x, y);
                }
            }
        }
        ctx5.stroke();
    }
    
    function drawSpeedSliderVisuals5() {
        if (!lineDrawn5 || questionsSection5.classList.contains('hidden')) return;
        const speed = parseFloat(speedSlider5.value);
        const time = inverseConstant5 / speed;
        
        // Draw helper lines
        const x = padding5 + speed * xScale5;
        const y = canvas5.height - padding5 - time * yScale5;
        if(x > padding5 && y > padding5 && x < (canvas5.width - padding5) && y < (canvas5.height - padding5) ){
            ctx5.beginPath(); ctx5.setLineDash([5, 5]); ctx5.strokeStyle = '#10b981'; ctx5.lineWidth = 2;
            ctx5.moveTo(x, canvas5.height - padding5); ctx5.lineTo(x, y); ctx5.lineTo(padding5, y);
            ctx5.stroke(); ctx5.setLineDash([]);
            drawPoint5(speed, time, '#10b981', 8);
        }
    }

    function handleSpeedSlider5() {
        if (!lineDrawn5) return;
        const speed = parseFloat(speedSlider5.value);
        sliderValue5_speed.textContent = speed.toFixed(1);
        const time = inverseConstant5 / speed;
        resultBox5_time.innerHTML = `роирпЗро░роорпН = родрпВро░роорпН / ро╡рпЗроХроорпН <br> роирпЗро░роорпН = 12 / ${speed.toFixed(1)} = <b>${time.toFixed(1)} роорогро┐</b>`;
        
        drawGraph5(); 
    }

    function activateSpeedFinder() {
        plotToolActivator5.classList.add('hidden');
        isToolActive5 = true;
        waitForSpeedClick = true;
        feedbackBox5.innerHTML = 'ро╡ро░рпИрокроЯродрпНродро┐ро▓рпН x- роЕроЪрпНроЪро┐ро▓рпН <b>(2.4, 0)</b> роОройрпНро▒ рокрпБро│рпНро│ро┐ропрпИроХрпН роХрогрпНроЯро▒ро┐ропро╡рпБроорпН.';
        canvas5.classList.add('plotting-active');
        document.body.classList.add('no-select');

        plotMoveHandler5 = (e) => plotMoveForSpeed(e);
        touchMoveHandler5 = (e) => plotMoveForSpeed(e);
        plotClickHandler5 = (e) => handlePlotClickForSpeed(e);

        document.addEventListener('mousemove', plotMoveHandler5);
        document.addEventListener('touchmove', touchMoveHandler5, { passive: false });
        canvas5.addEventListener('click', plotClickHandler5);
    }

    function plotMoveForSpeed(e) {
        if (!isToolActive5 || !waitForSpeedClick) return;
        e.preventDefault();
        const rect = canvas5.getBoundingClientRect();
        let clientX, clientY;
        if (e.touches && e.touches.length > 0) { clientX = e.touches[0].clientX; clientY = e.touches[0].clientY; }
        else { clientX = e.clientX; clientY = e.clientY; }

        const rawMouseX = clientX - rect.left;
        const rawMouseY = clientY - rect.top;
        let graphX = (rawMouseX - padding5) / xScale5;
        let graphY = (canvas5.height - padding5 - rawMouseY) / yScale5;

        graphX = Math.max(0, Math.min(maxX5, graphX));
        graphY = Math.max(0, Math.min(maxY5, graphY));

        snappedGraphPos5.x = parseFloat((Math.round(graphX * 10) / 10).toFixed(1));
        snappedGraphPos5.y = parseFloat(Math.round(graphY).toFixed(1));

        mouseCanvasPos5.x = padding5 + snappedGraphPos5.x * xScale5;
        mouseCanvasPos5.y = canvas5.height - padding5 - snappedGraphPos5.y * yScale5;

        isNearTarget5 = (snappedGraphPos5.x === 2.4 && snappedGraphPos5.y === 0.0);
        drawGraph5();
    }

    function handlePlotClickForSpeed(e) {
        if (!isToolActive5 || !waitForSpeedClick) return;
        if (e.target.closest('.controls-panel')) return;
        e.preventDefault();

        if (isNearTarget5) {
            isToolActive5 = false;
            waitForSpeedClick = false;
            document.removeEventListener('mousemove', plotMoveHandler5);
            document.removeEventListener('touchmove', touchMoveHandler5);
            canvas5.removeEventListener('click', plotClickHandler5);
            canvas5.classList.remove('plotting-active');
            document.body.classList.remove('no-select');
            mouseCanvasPos5 = { x: -1, y: -1 };
            
            feedbackBox5.textContent = 'роЪро░ро┐ропро╛ройродрпБ! родрпАро░рпНро╡рпБ роОро╡рпНро╡ро╛ро▒рпБ роХрогрпНроЯро▒ро┐ропрокрпНрокроЯрпБроХро┐ро▒родрпБ роОройрпНрокродрпИрокрпН рокро╛ро░рпБроЩрпНроХро│рпН...';
            animateSolution5_speedToTime(2.4, () => {
                questionsSection5.classList.remove('hidden');
                handleSpeedSlider5();
                feedbackBox5.textContent = 'роЪро┐ро▒рокрпНрокрпБ! роЗрокрпНрокрпЛродрпБ ро╕рпНро▓рпИроЯро░рпИрокрпН рокропройрпНрокроЯрпБродрпНродро┐ рооро▒рпНро▒ ро╡рпЗроХроЩрпНроХро│рпБроХрпНроХро╛рой роирпЗро░родрпНродрпИроХрпН роХрогрпНроЯро▒ро┐ропро╡рпБроорпН.';
            });
        } else {
            feedbackBox5.style.backgroundColor = '#fee2e2';
            feedbackBox5.style.color = '#b91c1c';
            feedbackBox5.textContent = 'родро╡ро▒рпБ. ро╡ро░рпИрокроЯродрпНродро┐ро▓рпН x- роЕроЪрпНроЪро┐ро▓рпН (2.4, 0) рокрпБро│рпНро│ро┐ропрпИроХрпН роХрогрпНроЯро▒ро┐ропро╡рпБроорпН.';
            setTimeout(() => {
                feedbackBox5.style.backgroundColor = '#eef2ff';
                feedbackBox5.style.color = 'var(--primary-dark)';
                feedbackBox5.innerHTML = 'ро╡ро░рпИрокроЯродрпНродро┐ро▓рпН x- роЕроЪрпНроЪро┐ро▓рпН <b>(2.4, 0)</b> роОройрпНро▒ рокрпБро│рпНро│ро┐ропрпИроХрпН роХрогрпНроЯро▒ро┐ропро╡рпБроорпН.';
            }, 2000);
        }
    }

    function animateSolution5_speedToTime(speed, onComplete) {
        const time = inverseConstant5 / speed;
        const duration = 1500;
        let startTime = null;
        isAnimating5 = true;

        function animate(timestamp) {
            if (!startTime) startTime = timestamp;
            const progress = timestamp - startTime;
            const percentage = Math.min(progress / (duration * 2), 1);

            drawGraph5(); 

            const x_canvas = padding5 + speed * xScale5;
            const y_intersect_canvas = canvas5.height - padding5 - time * yScale5;

            if (percentage <= 0.5) { 
                const p = percentage * 2;
                const y_start_canvas = canvas5.height - padding5;
                const y_current_canvas = y_start_canvas + (y_intersect_canvas - y_start_canvas) * p;
                ctx5.beginPath();
                ctx5.setLineDash([5, 5]);
                ctx5.strokeStyle = '#10b981';
                ctx5.lineWidth = 2;
                ctx5.moveTo(x_canvas, y_start_canvas);
                ctx5.lineTo(x_canvas, y_current_canvas);
                ctx5.stroke();
            } else { 
                drawPoint5(speed, time, '#10b981', 8);
                const p = (percentage - 0.5) * 2;
                ctx5.beginPath();
                ctx5.setLineDash([5, 5]);
                ctx5.strokeStyle = '#10b981';
                ctx5.lineWidth = 2;
                ctx5.moveTo(x_canvas, canvas5.height - padding5);
                ctx5.lineTo(x_canvas, y_intersect_canvas);

                const x_start_canvas = x_canvas;
                const x_target_canvas = padding5;
                const x_current_canvas = x_start_canvas + (x_target_canvas - x_start_canvas) * p;
                ctx5.moveTo(x_start_canvas, y_intersect_canvas);
                ctx5.lineTo(x_current_canvas, y_intersect_canvas);
                ctx5.stroke();
            }
            ctx5.setLineDash([]);

            if (progress < (duration * 2)) {
                requestAnimationFrame(animate);
            } else {
                isAnimating5 = false;
                if (onComplete) onComplete();
            }
        }
        requestAnimationFrame(animate);
    }

    function resetSimulation5() {
        if (plotMoveHandler5) document.removeEventListener('mousemove', plotMoveHandler5);
        if (touchMoveHandler5) document.removeEventListener('touchmove', touchMoveHandler5);
        if (plotClickHandler5) canvas5.removeEventListener('click', plotClickHandler5);
        
        const newActivator = activatorFinger5.cloneNode(true);
        activatorFinger5.parentNode.replaceChild(newActivator, activatorFinger5);
        activatorFinger5 = newActivator;
    
        initModel5();
    }

    // --- EVENT LISTENERS ---

    // General
    headerTitle.addEventListener('click', () => {
        homeScreen.classList.remove('hidden');
        simulationScreen.classList.add('hidden');
        resetSimulation(); resetSimulation2(); resetSimulation3(); resetSimulation4(); resetSimulation5();
    });

    graphButton.addEventListener('click', () => {
        homeScreen.classList.add('hidden');
        simulationScreen.classList.remove('hidden');
        switchTab('model1');
    });

    tabBtns.forEach(btn => {
        btn.addEventListener('click', () => switchTab(btn.dataset.tab));
    });

    // Model 1
    backBtn.addEventListener('click', () => {
        homeScreen.classList.remove('hidden');
        simulationScreen.classList.add('hidden');
        resetSimulation(); resetSimulation2(); resetSimulation3(); resetSimulation4(); resetSimulation5();
    });

    addPointBtn.addEventListener('click', () => {
        if (data.length >= 5) {
            feedbackBox.textContent = '5 роородро┐рокрпНрокрпБроХро│рпН роЪрпЗро░рпНроХрпНроХрокрпНрокроЯрпНроЯрой.'; return;
        }
        const x = parseFloat(xInput.value);
        if (!isNaN(x) && x > 0) {
            const y = parseFloat((x * 3.1).toFixed(1));
            data.push({ d: x, c: y });
            updateTable();
            xInput.value = ''; xInput.focus();
            if (data.length >= 5) {
                plotBtn.disabled = false;
                xInput.disabled = true; addPointBtn.disabled = true;
                feedbackBox.innerHTML = '<b>5 роородро┐рокрпНрокрпБроХро│рпН роЪрпЗро░рпНроХрпНроХрокрпНрокроЯрпНроЯрой. роЗрокрпНрокрпЛродрпБ "рокрпБро│рпНро│ро┐роХро│рпИроХрпН роХрпБро▒ро┐роХрпНроХро╡рпБроорпН" рокрпКродрпНродро╛ройрпИ роЕро┤рпБродрпНродро╡рпБроорпН.</b>';
            } else {
                 feedbackBox.textContent = `(${x}, ${y}) рокрпБро│рпНро│ро┐ роЪрпЗро░рпНроХрпНроХрокрпНрокроЯрпНроЯродрпБ.`;
            }
        } else {
            feedbackBox.textContent = 'ро╡ро┐роЯрпНроЯродрпНродро┐ро▒рпНроХрпБ роЪро░ро┐ропро╛рой роирпЗро░рпНрооро▒рпИ роОрогрпНрогрпИ роЙро│рпНро│ро┐роЯро╡рпБроорпН.';
        }
    });

    plotBtn.addEventListener('click', startManualPlotting);
    
    lineBtn.addEventListener('click', () => {
        if (!pointsPlotted) return;
        mainLineDrawn = true;
        drawGraph();
        lineBtn.disabled = true;
        
        feedbackBox.innerHTML = 'роЪро┐ро▒рокрпНрокрпБ! роЗрокрпНрокрпЛродрпБ ро╡ро┐роЯрпНроЯрооро╛ройродрпБ 6 роЪрпЖ.роорпА роЖроХ роЗро░рпБроХрпНроХрпБроорпНрокрпЛродрпБ роЕродройрпН роЪрпБро▒рпНро▒ро│ро╡рпИроХрпН роХрогрпНроЯро▒ро┐ропрпБроорпН роХро░рпБро╡ро┐ропрпИ роЗропроХрпНроХ, рокрпКродрпНродро╛ройрпИ роЕро┤рпБродрпНродро╡рпБроорпН.';
        plotToolActivator.querySelector('span').textContent = 'x = 6 роЗро▓рпН роородро┐рокрпНрокрпИроХрпН роХрогрпНроЯро▒ро┐ропро╡рпБроорпН';
        plotToolActivator.classList.remove('hidden');

        const newActivator = activatorFinger.cloneNode(true);
        activatorFinger.parentNode.replaceChild(newActivator, activatorFinger);
        activatorFinger = newActivator;
        
        activatorFinger.addEventListener('click', activateX6Finder, { once: true });
    });

    diameterSlider.addEventListener('input', handleSliderInput);
    resetBtn.addEventListener('click', resetSimulation);
    
    // Model 2
    backBtn2.addEventListener('click', () => {
        homeScreen.classList.remove('hidden');
        simulationScreen.classList.add('hidden');
        resetSimulation(); resetSimulation2(); resetSimulation3(); resetSimulation4(); resetSimulation5();
    });

    addPointBtn2.addEventListener('click', () => {
        if (data2.length >= 4) {
            feedbackBox2.textContent = '4 роородро┐рокрпНрокрпБроХро│рпН роПро▒рпНроХройро╡рпЗ роЪрпЗро░рпНроХрпНроХрокрпНрокроЯрпНроЯрпБро│рпНро│рой.';
            return;
        }

        const t = parseFloat(xInput2.value);
        if (!isNaN(t) && t > 0) {
            const d = parseFloat((t * proportionalityConstant).toFixed(1));
            data2.push({ t, d });
            updateTable2();
            xInput2.value = '';
            xInput2.focus();

            if (data2.length === 4) {
                feedbackBox2.innerHTML = '<b>роЕро░рпБроорпИ! роЗрокрпНрокрпЛродрпБ ро╡ро░рпИрокроЯродрпНродро┐ро▓рпН "рокрпБро│рпНро│ро┐роХро│рпИроХрпН роХрпБро▒ро┐роХрпНроХро╡рпБроорпН".</b>';
                plotBtn2.disabled = false;
                xInput2.disabled = true;
                addPointBtn2.disabled = true;
            } else {
                feedbackBox2.textContent = `(${t}, ${d}) рокрпБро│рпНро│ро┐ роЪрпЗро░рпНроХрпНроХрокрпНрокроЯрпНроЯродрпБ. роорпАродроорпБро│рпНро│ ${4 - data2.length} роородро┐рокрпНрокрпБроХро│рпИ роЙро│рпНро│ро┐роЯро╡рпБроорпН.`;
            }
        } else {
            feedbackBox2.textContent = 'роирпЗро░родрпНродро┐ро▒рпНроХрпБ роЪро░ро┐ропро╛рой роирпЗро░рпНрооро▒рпИ роОрогрпНрогрпИ роЙро│рпНро│ро┐роЯро╡рпБроорпН.';
        }
    });

    plotBtn2.addEventListener('click', startManualPlotting2);
    
    lineBtn2.addEventListener('click', () => {
        if (!pointsPlotted2) return;
        lineDrawn2 = true;
        lineBtn2.disabled = true;
        
        feedbackBox2.innerHTML = '<b>роХрпЗро│рпНро╡ро┐ (ii)</b>: 90 роиро┐рооро┐роЯроЩрпНроХро│ро┐ро▓рпН рокропрогро┐роХрпНроХрпБроорпН родрпВро░родрпНродрпИроХрпН роХрогрпНроЯро▒ро┐ропрпБроорпН роХро░рпБро╡ро┐ропрпИ роЗропроХрпНроХ, рокрпКродрпНродро╛ройрпИ роЕро┤рпБродрпНродро╡рпБроорпН.';
        plotToolActivator2.querySelector('span').textContent = 'x = 90 роЗро▓рпН роородро┐рокрпНрокрпИроХрпН роХрогрпНроЯро▒ро┐ропро╡рпБроорпН';
        plotToolActivator2.classList.remove('hidden');

        const newActivator = activatorFinger2.cloneNode(true);
        activatorFinger2.parentNode.replaceChild(newActivator, activatorFinger2);
        activatorFinger2 = newActivator;

        activatorFinger2.addEventListener('click', activateTimeFinder, { once: true });
    });

    function activateTimeFinder() {
        plotToolActivator2.classList.add('hidden');
        isToolActive2 = true;
        waitForTimeClick = true;
        feedbackBox2.innerHTML = 'ро╡ро░рпИрокроЯродрпНродро┐ро▓рпН <b>(90, 0)</b> роОройрпНро▒ рокрпБро│рпНро│ро┐ропрпИроХрпН роХрогрпНроЯро▒ро┐ропро╡рпБроорпН.';
        canvas2.classList.add('plotting-active');
        document.body.classList.add('no-select');

        plotMoveHandler2 = (e) => plotMoveForTime(e);
        touchMoveHandler2 = (e) => plotMoveForTime(e);
        plotClickHandler2 = (e) => handlePlotClickForTime(e);

        document.addEventListener('mousemove', plotMoveHandler2);
        document.addEventListener('touchmove', touchMoveHandler2, { passive: false });
        canvas2.addEventListener('click', plotClickHandler2);
    }

    function plotMoveForTime(e) {
        if (!isToolActive2 || !waitForTimeClick) return;
        e.preventDefault();
        const rect = canvas2.getBoundingClientRect();
        let clientX, clientY;
        if (e.touches && e.touches.length > 0) { clientX = e.touches[0].clientX; clientY = e.touches[0].clientY; } 
        else { clientX = e.clientX; clientY = e.clientY; }
        
        const rawMouseX = clientX - rect.left;
        const rawMouseY = clientY - rect.top;
        let graphX = (rawMouseX - padding2) / xScale2;
        let graphY = (canvas2.height - padding2 - rawMouseY) / yScale2;

        graphX = Math.max(0, Math.min(maxX2, graphX));
        graphY = Math.max(0, Math.min(maxY2, graphY));

        snappedGraphPos2.x = Math.round(graphX);
        snappedGraphPos2.y = Math.round(graphY);

        mouseCanvasPos2.x = padding2 + snappedGraphPos2.x * xScale2;
        mouseCanvasPos2.y = canvas2.height - padding2 - snappedGraphPos2.y * yScale2;
        
        isNearTarget2 = (snappedGraphPos2.x === 90 && snappedGraphPos2.y === 0);
        drawGraph2(false);
    }

    function handlePlotClickForTime(e) {
        if (!isToolActive2 || !waitForTimeClick) return;
        if (e.target.closest('.controls-panel')) return;
        e.preventDefault();

        if (isNearTarget2) {
            isToolActive2 = false;
            waitForTimeClick = false;
            document.removeEventListener('mousemove', plotMoveHandler2);
            document.removeEventListener('touchmove', touchMoveHandler2);
            canvas2.removeEventListener('click', plotClickHandler2);
            canvas2.classList.remove('plotting-active');
            document.body.classList.remove('no-select');
            mouseCanvasPos2 = { x: -1, y: -1 };
            drawGraph2(false);

            feedbackBox2.textContent = 'роЪро░ро┐ропро╛ройродрпБ! родрпАро░рпНро╡рпБ роОро╡рпНро╡ро╛ро▒рпБ роХрогрпНроЯро▒ро┐ропрокрпНрокроЯрпБроХро┐ро▒родрпБ роОройрпНрокродрпИрокрпН рокро╛ро░рпБроЩрпНроХро│рпН...';
            animateSolution2_timeToDist(90, () => {
                feedbackBox2.innerHTML = '<b>роХрпЗро│рпНро╡ро┐ (iii)</b>: 300 роХро┐.роорпА. рокропрогро┐роХрпНроХ роЖроХрпБроорпН роирпЗро░родрпНродрпИроХрпН роХрогрпНроЯро▒ро┐ропрпБроорпН роХро░рпБро╡ро┐ропрпИ роЗропроХрпНроХ, рокрпКродрпНродро╛ройрпИ роЕро┤рпБродрпНродро╡рпБроорпН.';
                plotToolActivator2.querySelector('span').textContent = 'y = 300 роЗро▓рпН роородро┐рокрпНрокрпИроХрпН роХрогрпНроЯро▒ро┐ропро╡рпБроорпН';
                plotToolActivator2.classList.remove('hidden');

                const newActivator = activatorFinger2.cloneNode(true);
                activatorFinger2.parentNode.replaceChild(newActivator, activatorFinger2);
                activatorFinger2 = newActivator;
                
                activatorFinger2.addEventListener('click', activateDistFinder, { once: true });
            });
        } else {
            feedbackBox2.style.backgroundColor = '#fee2e2';
            feedbackBox2.style.color = '#b91c1c';
            feedbackBox2.textContent = 'родро╡ро▒рпБ. ро╡ро░рпИрокроЯродрпНродро┐ро▓рпН (90, 0) рокрпБро│рпНро│ро┐ропрпИроХрпН роХрогрпНроЯро▒ро┐ропро╡рпБроорпН.';
            setTimeout(() => {
                feedbackBox2.style.backgroundColor = '#eef2ff';
                feedbackBox2.style.color = 'var(--primary-dark)';
                feedbackBox2.innerHTML = 'ро╡ро░рпИрокроЯродрпНродро┐ро▓рпН <b>(90, 0)</b> роОройрпНро▒ рокрпБро│рпНро│ро┐ропрпИроХрпН роХрогрпНроЯро▒ро┐ропро╡рпБроорпН.';
            }, 2000);
        }
    }

    function activateDistFinder() {
        plotToolActivator2.classList.add('hidden');
        isToolActive2 = true;
        waitForDistClick = true;
        feedbackBox2.innerHTML = 'ро╡ро░рпИрокроЯродрпНродро┐ро▓рпН <b>(0, 300)</b> роОройрпНро▒ рокрпБро│рпНро│ро┐ропрпИроХрпН роХрогрпНроЯро▒ро┐ропро╡рпБроорпН.';
        canvas2.classList.add('plotting-active');
        document.body.classList.add('no-select');

        plotMoveHandler2 = (e) => plotMoveForDist(e);
        touchMoveHandler2 = (e) => plotMoveForDist(e);
        plotClickHandler2 = (e) => handlePlotClickForDist(e);

        document.addEventListener('mousemove', plotMoveHandler2);
        document.addEventListener('touchmove', touchMoveHandler2, { passive: false });
        canvas2.addEventListener('click', plotClickHandler2);
    }
    
    function plotMoveForDist(e) {
        if (!isToolActive2 || !waitForDistClick) return;
        e.preventDefault();
        const rect = canvas2.getBoundingClientRect();
        let clientX, clientY;
        if (e.touches && e.touches.length > 0) { clientX = e.touches[0].clientX; clientY = e.touches[0].clientY; } 
        else { clientX = e.clientX; clientY = e.clientY; }
        
        const rawMouseX = clientX - rect.left;
        const rawMouseY = clientY - rect.top;
        let graphX = (rawMouseX - padding2) / xScale2;
        let graphY = (canvas2.height - padding2 - rawMouseY) / yScale2;

        graphX = Math.max(0, Math.min(maxX2, graphX));
        graphY = Math.max(0, Math.min(maxY2, graphY));

        snappedGraphPos2.x = Math.round(graphX);
        snappedGraphPos2.y = Math.round(graphY);

        mouseCanvasPos2.x = padding2 + snappedGraphPos2.x * xScale2;
        mouseCanvasPos2.y = canvas2.height - padding2 - snappedGraphPos2.y * yScale2;
        
        isNearTarget2 = (snappedGraphPos2.x === 0 && snappedGraphPos2.y === 300);
        drawGraph2(false);
    }

    function handlePlotClickForDist(e) {
        if (!isToolActive2 || !waitForDistClick) return;
        if (e.target.closest('.controls-panel')) return;
        e.preventDefault();

        if (isNearTarget2) {
            isToolActive2 = false;
            waitForDistClick = false;
            document.removeEventListener('mousemove', plotMoveHandler2);
            document.removeEventListener('touchmove', touchMoveHandler2);
            canvas2.removeEventListener('click', plotClickHandler2);
            canvas2.classList.remove('plotting-active');
            document.body.classList.remove('no-select');
            mouseCanvasPos2 = { x: -1, y: -1 };
            drawGraph2(false);

            feedbackBox2.textContent = 'роЪро░ро┐ропро╛ройродрпБ! родрпАро░рпНро╡рпБ роОро╡рпНро╡ро╛ро▒рпБ роХрогрпНроЯро▒ро┐ропрокрпНрокроЯрпБроХро┐ро▒родрпБ роОройрпНрокродрпИрокрпН рокро╛ро░рпБроЩрпНроХро│рпН...';
            animateSolution2_distToTime(300, () => {
                isAnimating2 = false;
                questionsSection2.classList.remove('hidden');
                resultBox2_k.textContent = 'k = y/x = 50 роХро┐.роорпА / 60 роиро┐рооро┐роЯроЩрпНроХро│рпН = 5/6';
                handleTimeSlider();
                handleDistSlider();
                feedbackBox2.textContent = 'роЪро┐ро▒рокрпНрокрпБ! роЗрокрпНрокрпЛродрпБ ро╕рпНро▓рпИроЯро░рпНроХро│рпИрокрпН рокропройрпНрокроЯрпБродрпНродро┐ роХрпЗро│рпНро╡ро┐роХро│рпБроХрпНроХрпБ ро╡ро┐роЯрпИропро│ро┐роХрпНроХро╡рпБроорпН.';
                drawGraph2();
            });
        } else {
             feedbackBox2.style.backgroundColor = '#fee2e2';
            feedbackBox2.style.color = '#b91c1c';
            feedbackBox2.textContent = 'родро╡ро▒рпБ. ро╡ро░рпИрокроЯродрпНродро┐ро▓рпН (0, 300) рокрпБро│рпНро│ро┐ропрпИроХрпН роХрогрпНроЯро▒ро┐ропро╡рпБроорпН.';
            setTimeout(() => {
                feedbackBox2.style.backgroundColor = '#eef2ff';
                feedbackBox2.style.color = 'var(--primary-dark)';
                feedbackBox2.innerHTML = 'ро╡ро░рпИрокроЯродрпНродро┐ро▓рпН <b>(0, 300)</b> роОройрпНро▒ рокрпБро│рпНро│ро┐ропрпИроХрпН роХрогрпНроЯро▒ро┐ропро╡рпБроорпН.';
            }, 2000);
        }
    }


    function animateSolution2_timeToDist(time, onComplete) {
        const distance = time * proportionalityConstant;
        const duration = 1500;
        let startTime = null;
        isAnimating2 = true;

        function animateVertical(timestamp) {
            if (!startTime) startTime = timestamp;
            const progress = timestamp - startTime;
            const percentage = Math.min(progress / duration, 1);
            
            drawGraph2(false); 

            const x_canvas = padding2 + time * xScale2;
            const y_start_canvas = canvas2.height - padding2;
            const y_target_canvas = canvas2.height - padding2 - distance * yScale2;
            const y_current_canvas = y_start_canvas + (y_target_canvas - y_start_canvas) * percentage;

            ctx2.beginPath();
            ctx2.setLineDash([5, 5]);
            ctx2.strokeStyle = '#10b981';
            ctx2.lineWidth = 2;
            ctx2.moveTo(x_canvas, y_start_canvas);
            ctx2.lineTo(x_canvas, y_current_canvas);
            ctx2.stroke();
            ctx2.setLineDash([]);
            
            if (progress < duration) {
                requestAnimationFrame(animateVertical);
            } else {
                startTime = null;
                requestAnimationFrame(animateHorizontal);
            }
        }

        function animateHorizontal(timestamp) {
            if (!startTime) startTime = timestamp;
            const progress = timestamp - startTime;
            const percentage = Math.min(progress / duration, 1);

            drawGraph2(false);
            
            const x_canvas = padding2 + time * xScale2;
            const y_canvas_intersect = canvas2.height - padding2 - distance * yScale2;
            ctx2.beginPath();
            ctx2.setLineDash([5, 5]);
            ctx2.strokeStyle = '#10b981';
            ctx2.lineWidth = 2;
            ctx2.moveTo(x_canvas, canvas2.height - padding2);
            ctx2.lineTo(x_canvas, y_canvas_intersect);
            ctx2.stroke();

            const x_start_canvas = x_canvas;
            const x_target_canvas = padding2;
            const x_current_canvas = x_start_canvas + (x_target_canvas - x_start_canvas) * percentage;

            ctx2.moveTo(x_start_canvas, y_canvas_intersect);
            ctx2.lineTo(x_current_canvas, y_canvas_intersect);
            ctx2.stroke();
            ctx2.setLineDash([]);
            drawPoint2(time, distance, '#10b981', 8);

            if (progress < duration) {
                requestAnimationFrame(animateHorizontal);
            } else {
                isAnimating2 = false;
                if (onComplete) onComplete();
            }
        }
        requestAnimationFrame(animateVertical);
    }

    function animateSolution2_distToTime(distance, onComplete) {
        const time = distance / proportionalityConstant;
        const duration = 1500;
        let startTime = null;
        isAnimating2 = true;

        function animateHorizontal(timestamp) {
            if (!startTime) startTime = timestamp;
            const progress = timestamp - startTime;
            const percentage = Math.min(progress / duration, 1);
            
            drawGraph2(false);
            drawTimeSliderVisuals(); // Redraw the first solution statically

            const y_canvas = canvas2.height - padding2 - distance * yScale2;
            const x_start_canvas = padding2;
            const x_target_canvas = padding2 + time * xScale2;
            const x_current_canvas = x_start_canvas + (x_target_canvas - x_start_canvas) * percentage;
            
            ctx2.beginPath();
            ctx2.setLineDash([5, 5]);
            ctx2.strokeStyle = '#0ea5e9';
            ctx2.lineWidth = 2;
            ctx2.moveTo(x_start_canvas, y_canvas);
            ctx2.lineTo(x_current_canvas, y_canvas);
            ctx2.stroke();
            ctx2.setLineDash([]);
            
            if (progress < duration) {
                requestAnimationFrame(animateHorizontal);
            } else {
                startTime = null;
                requestAnimationFrame(animateVertical);
            }
        }

        function animateVertical(timestamp) {
             if (!startTime) startTime = timestamp;
            const progress = timestamp - startTime;
            const percentage = Math.min(progress / duration, 1);

            drawGraph2(false);
            drawTimeSliderVisuals(); 

            const y_canvas = canvas2.height - padding2 - distance * yScale2;
            const x_canvas_intersect = padding2 + time * xScale2;
            ctx2.beginPath();
            ctx2.setLineDash([5, 5]);
            ctx2.strokeStyle = '#0ea5e9';
            ctx2.lineWidth = 2;
            ctx2.moveTo(padding2, y_canvas);
            ctx2.lineTo(x_canvas_intersect, y_canvas);
            ctx2.stroke();

            const y_start_canvas = y_canvas;
            const y_target_canvas = canvas2.height - padding2;
            const y_current_canvas = y_start_canvas + (y_target_canvas - y_start_canvas) * percentage;

            ctx2.moveTo(x_canvas_intersect, y_start_canvas);
            ctx2.lineTo(x_canvas_intersect, y_current_canvas);
            ctx2.stroke();
            ctx2.setLineDash([]);
            drawPoint2(time, distance, '#0ea5e9', 8);

            if (progress < duration) {
                requestAnimationFrame(animateVertical);
            } else {
                isAnimating2 = false;
                if (onComplete) onComplete();
            }
        }
        requestAnimationFrame(animateHorizontal);
    }
    
    timeSlider.addEventListener('input', handleTimeSlider);
    distSlider.addEventListener('input', handleDistSlider);
    resetBtn2.addEventListener('click', resetSimulation2);
    
    // Model 3
    backBtn3.addEventListener('click', () => {
        homeScreen.classList.remove('hidden');
        simulationScreen.classList.add('hidden');
        resetSimulation(); resetSimulation2(); resetSimulation3(); resetSimulation4(); resetSimulation5();
    });

    addPointBtn3.addEventListener('click', () => {
        if (data3.length >= 4) {
            feedbackBox3.textContent = '4 роородро┐рокрпНрокрпБроХро│рпН роПро▒рпНроХройро╡рпЗ роЪрпЗро░рпНроХрпНроХрокрпНрокроЯрпНроЯрпБро│рпНро│рой.';
            return;
        }

        const x = parseFloat(xInput3.value);
        if (!isNaN(x) && x > 0) {
            const y = Math.round(inverseConstant / x);
            data3.push({ x, y });
            updateTable3();
            xInput3.value = '';
            xInput3.focus();

            if (data3.length === 4) {
                feedbackBox3.innerHTML = '<b>роЕро░рпБроорпИ! роЗрокрпНрокрпЛродрпБ ро╡ро░рпИрокроЯродрпНродро┐ро▓рпН "рокрпБро│рпНро│ро┐роХро│рпИроХрпН роХрпБро▒ро┐роХрпНроХро╡рпБроорпН".</b>';
                plotBtn3.disabled = false;
                xInput3.disabled = true;
                addPointBtn3.disabled = true;
            } else {
                feedbackBox3.textContent = `(${x}, ${y}) рокрпБро│рпНро│ро┐ роЪрпЗро░рпНроХрпНроХрокрпНрокроЯрпНроЯродрпБ. роорпАродроорпБро│рпНро│ ${4 - data3.length} роородро┐рокрпНрокрпБроХро│рпИ роЙро│рпНро│ро┐роЯро╡рпБроорпН.`;
            }
        } else {
            feedbackBox3.textContent = 'ро╡рпЗро▓рпИропро╛роЯрпНроХро│рпБроХрпНроХрпБ роЪро░ро┐ропро╛рой роирпЗро░рпНрооро▒рпИ роОрогрпНрогрпИ роЙро│рпНро│ро┐роЯро╡рпБроорпН.';
        }
    });

    plotBtn3.addEventListener('click', startManualPlotting3);
    
    lineBtn3.addEventListener('click', () => {
        if (!pointsPlotted3) return;
        lineDrawn3 = true;
        lineBtn3.disabled = true;
        
        feedbackBox3.innerHTML = '<b>роХрпЗро│рпНро╡ро┐ (ii)</b>: 120 ро╡рпЗро▓рпИропро╛роЯрпНроХро│рпН ро╡рпЗро▓рпИ роЪрпЖропрпНродро╛ро▓рпН, ро╡рпЗро▓рпИ роорпБроЯро┐роп роОродрпНродройрпИ роиро╛роЯрпНроХро│рпН роЖроХрпБроорпН роОройрпНрокродрпИ роХрогрпНроЯро▒ро┐ропрпБроорпН роХро░рпБро╡ро┐ропрпИ роЗропроХрпНроХ, рокрпКродрпНродро╛ройрпИ роЕро┤рпБродрпНродро╡рпБроорпН.';
        plotToolActivator3.querySelector('span').textContent = 'x = 120 роЗро▓рпН роородро┐рокрпНрокрпИроХрпН роХрогрпНроЯро▒ро┐ропро╡рпБроорпН';
        plotToolActivator3.classList.remove('hidden');

        const newActivator = activatorFinger3.cloneNode(true);
        activatorFinger3.parentNode.replaceChild(newActivator, activatorFinger3);
        activatorFinger3 = newActivator;

        activatorFinger3.addEventListener('click', activateWorkersFinder, { once: true });
    });

     function activateWorkersFinder() {
        plotToolActivator3.classList.add('hidden');
        isToolActive3 = true;
        waitForWorkersClick = true;
        feedbackBox3.innerHTML = 'ро╡ро░рпИрокроЯродрпНродро┐ро▓рпН <b>(120, 0)</b> роОройрпНро▒ рокрпБро│рпНро│ро┐ропрпИроХрпН роХрогрпНроЯро▒ро┐ропро╡рпБроорпН.';
        canvas3.classList.add('plotting-active');
        document.body.classList.add('no-select');

        plotMoveHandler3 = (e) => plotMoveForWorkers(e);
        touchMoveHandler3 = (e) => plotMoveForWorkers(e);
        plotClickHandler3 = (e) => handlePlotClickForWorkers(e);

        document.addEventListener('mousemove', plotMoveHandler3);
        document.addEventListener('touchmove', touchMoveHandler3, { passive: false });
        canvas3.addEventListener('click', plotClickHandler3);
    }

    function plotMoveForWorkers(e) {
        if (!isToolActive3 || !waitForWorkersClick) return;
        e.preventDefault();
        const rect = canvas3.getBoundingClientRect();
        let clientX, clientY;
        if (e.touches && e.touches.length > 0) { clientX = e.touches[0].clientX; clientY = e.touches[0].clientY; } 
        else { clientX = e.clientX; clientY = e.clientY; }
        
        const rawMouseX = clientX - rect.left;
        const rawMouseY = clientY - rect.top;
        let graphX = (rawMouseX - padding3) / xScale3;
        let graphY = (canvas3.height - padding3 - rawMouseY) / yScale3;

        graphX = Math.max(0, Math.min(maxX3, graphX));
        graphY = Math.max(0, Math.min(maxY3, graphY));

        snappedGraphPos3.x = Math.round(graphX);
        snappedGraphPos3.y = Math.round(graphY);

        mouseCanvasPos3.x = padding3 + snappedGraphPos3.x * xScale3;
        mouseCanvasPos3.y = canvas3.height - padding3 - snappedGraphPos3.y * yScale3;
        
        isNearTarget3 = (snappedGraphPos3.x === 120 && snappedGraphPos3.y === 0);
        drawGraph3(false);
    }

    function handlePlotClickForWorkers(e) {
        if (!isToolActive3 || !waitForWorkersClick) return;
        if (e.target.closest('.controls-panel')) return;
        e.preventDefault();

        if (isNearTarget3) {
            isToolActive3 = false;
            waitForWorkersClick = false;
            document.removeEventListener('mousemove', plotMoveHandler3);
            document.removeEventListener('touchmove', touchMoveHandler3);
            canvas3.removeEventListener('click', plotClickHandler3);
            canvas3.classList.remove('plotting-active');
            document.body.classList.remove('no-select');
            mouseCanvasPos3 = { x: -1, y: -1 };
            drawGraph3(false);

            feedbackBox3.textContent = 'роЪро░ро┐ропро╛ройродрпБ! родрпАро░рпНро╡рпБ роОро╡рпНро╡ро╛ро▒рпБ роХрогрпНроЯро▒ро┐ропрокрпНрокроЯрпБроХро┐ро▒родрпБ роОройрпНрокродрпИрокрпН рокро╛ро░рпБроЩрпНроХро│рпН...';
            animateSolution3_workersToDays(120, () => {
                feedbackBox3.innerHTML = '<b>роХрпЗро│рпНро╡ро┐ (iii)</b>: ро╡рпЗро▓рпИропро╛ройродрпБ 200 роиро╛роЯрпНроХро│ро┐ро▓рпН роорпБроЯро┐роп ро╡рпЗрогрпНроЯрпБроорпН роОройро┐ро▓рпН, роОродрпНродройрпИ ро╡рпЗро▓рпИропро╛роЯрпНроХро│рпН родрпЗро╡рпИ роОройрпНрокродрпИроХрпН роХрогрпНроЯро▒ро┐ропрпБроорпН роХро░рпБро╡ро┐ропрпИ роЗропроХрпНроХ, рокрпКродрпНродро╛ройрпИ роЕро┤рпБродрпНродро╡рпБроорпН.';
                plotToolActivator3.querySelector('span').textContent = 'y = 200 роЗро▓рпН роородро┐рокрпНрокрпИроХрпН роХрогрпНроЯро▒ро┐ропро╡рпБроорпН';
                plotToolActivator3.classList.remove('hidden');

                const newActivator = activatorFinger3.cloneNode(true);
                activatorFinger3.parentNode.replaceChild(newActivator, activatorFinger3);
                activatorFinger3 = newActivator;
                
                activatorFinger3.addEventListener('click', activateDaysFinder, { once: true });
            });
        } else {
            feedbackBox3.style.backgroundColor = '#fee2e2';
            feedbackBox3.style.color = '#b91c1c';
            feedbackBox3.textContent = 'родро╡ро▒рпБ. ро╡ро░рпИрокроЯродрпНродро┐ро▓рпН (120, 0) рокрпБро│рпНро│ро┐ропрпИроХрпН роХрогрпНроЯро▒ро┐ропро╡рпБроорпН.';
            setTimeout(() => {
                feedbackBox3.style.backgroundColor = '#eef2ff';
                feedbackBox3.style.color = 'var(--primary-dark)';
                feedbackBox3.innerHTML = 'ро╡ро░рпИрокроЯродрпНродро┐ро▓рпН <b>(120, 0)</b> роОройрпНро▒ рокрпБро│рпНро│ро┐ропрпИроХрпН роХрогрпНроЯро▒ро┐ропро╡рпБроорпН.';
            }, 2000);
        }
    }

    function activateDaysFinder() {
        plotToolActivator3.classList.add('hidden');
        isToolActive3 = true;
        waitForDaysClick = true;
        feedbackBox3.innerHTML = 'ро╡ро░рпИрокроЯродрпНродро┐ро▓рпН <b>(0, 200)</b> роОройрпНро▒ рокрпБро│рпНро│ро┐ропрпИроХрпН роХрогрпНроЯро▒ро┐ропро╡рпБроорпН.';
        canvas3.classList.add('plotting-active');
        document.body.classList.add('no-select');

        plotMoveHandler3 = (e) => plotMoveForDays(e);
        touchMoveHandler3 = (e) => plotMoveForDays(e);
        plotClickHandler3 = (e) => handlePlotClickForDays(e);

        document.addEventListener('mousemove', plotMoveHandler3);
        document.addEventListener('touchmove', touchMoveHandler3, { passive: false });
        canvas3.addEventListener('click', plotClickHandler3);
    }

    function plotMoveForDays(e) {
        if (!isToolActive3 || !waitForDaysClick) return;
        e.preventDefault();
        const rect = canvas3.getBoundingClientRect();
        let clientX, clientY;
        if (e.touches && e.touches.length > 0) { clientX = e.touches[0].clientX; clientY = e.touches[0].clientY; } 
        else { clientX = e.clientX; clientY = e.clientY; }
        
        const rawMouseX = clientX - rect.left;
        const rawMouseY = clientY - rect.top;
        let graphX = (rawMouseX - padding3) / xScale3;
        let graphY = (canvas3.height - padding3 - rawMouseY) / yScale3;

        graphX = Math.max(0, Math.min(maxX3, graphX));
        graphY = Math.max(0, Math.min(maxY3, graphY));

        snappedGraphPos3.x = Math.round(graphX);
        snappedGraphPos3.y = Math.round(graphY);

        mouseCanvasPos3.x = padding3 + snappedGraphPos3.x * xScale3;
        mouseCanvasPos3.y = canvas3.height - padding3 - snappedGraphPos3.y * yScale3;
        
        isNearTarget3 = (snappedGraphPos3.x === 0 && snappedGraphPos3.y === 200);
        drawGraph3(false);
    }

     function handlePlotClickForDays(e) {
        if (!isToolActive3 || !waitForDaysClick) return;
        if (e.target.closest('.controls-panel')) return;
        e.preventDefault();

        if (isNearTarget3) {
            isToolActive3 = false;
            waitForDaysClick = false;
            document.removeEventListener('mousemove', plotMoveHandler3);
            document.removeEventListener('touchmove', touchMoveHandler3);
            canvas3.removeEventListener('click', plotClickHandler3);
            canvas3.classList.remove('plotting-active');
            document.body.classList.remove('no-select');
            mouseCanvasPos3 = { x: -1, y: -1 };
            drawGraph3(false);

            feedbackBox3.textContent = 'роЪро░ро┐ропро╛ройродрпБ! родрпАро░рпНро╡рпБ роОро╡рпНро╡ро╛ро▒рпБ роХрогрпНроЯро▒ро┐ропрокрпНрокроЯрпБроХро┐ро▒родрпБ роОройрпНрокродрпИрокрпН рокро╛ро░рпБроЩрпНроХро│рпН...';
            animateSolution3_daysToWorkers(200, () => {
                isAnimating3 = false;
                questionsSection3.classList.remove('hidden');
                resultBox3_k.textContent = 'роЗродрпБ роТро░рпБ роОродро┐ро░рпН рооро╛ро▒рпБрокро╛роЯрпБ (xy = k)';
                handleWorkersSlider3();
                handleDaysSlider3();
                feedbackBox3.textContent = 'роЪро┐ро▒рокрпНрокрпБ! роЗрокрпНрокрпЛродрпБ ро╕рпНро▓рпИроЯро░рпНроХро│рпИрокрпН рокропройрпНрокроЯрпБродрпНродро┐ роХрпЗро│рпНро╡ро┐роХро│рпБроХрпНроХрпБ ро╡ро┐роЯрпИропро│ро┐роХрпНроХро╡рпБроорпН.';
                drawGraph3();
            });
        } else {
             feedbackBox3.style.backgroundColor = '#fee2e2';
            feedbackBox3.style.color = '#b91c1c';
            feedbackBox3.textContent = 'родро╡ро▒рпБ. ро╡ро░рпИрокроЯродрпНродро┐ро▓рпН (0, 200) рокрпБро│рпНро│ро┐ропрпИроХрпН роХрогрпНроЯро▒ро┐ропро╡рпБроорпН.';
            setTimeout(() => {
                feedbackBox3.style.backgroundColor = '#eef2ff';
                feedbackBox3.style.color = 'var(--primary-dark)';
                feedbackBox3.innerHTML = 'ро╡ро░рпИрокроЯродрпНродро┐ро▓рпН <b>(0, 200)</b> роОройрпНро▒ рокрпБро│рпНро│ро┐ропрпИроХрпН роХрогрпНроЯро▒ро┐ропро╡рпБроорпН.';
            }, 2000);
        }
    }


     function animateSolution3_workersToDays(workers, onComplete) {
        const days = inverseConstant / workers;
        const duration = 1500;
        let startTime = null;
        isAnimating3 = true;

        function animate(timestamp) {
            if (!startTime) startTime = timestamp;
            const progress = timestamp - startTime;
            const percentage = Math.min(progress / (duration * 2), 1);
            
            drawGraph3(false); 

            const x_canvas = padding3 + workers * xScale3;
            const y_intersect_canvas = canvas3.height - padding3 - days * yScale3;
            
            if (percentage <= 0.5) { // Animate vertical line
                const p = percentage * 2;
                const y_start_canvas = canvas3.height - padding3;
                const y_current_canvas = y_start_canvas + (y_intersect_canvas - y_start_canvas) * p;
                ctx3.beginPath();
                ctx3.setLineDash([5, 5]);
                ctx3.strokeStyle = '#10b981';
                ctx3.lineWidth = 2;
                ctx3.moveTo(x_canvas, y_start_canvas);
                ctx3.lineTo(x_canvas, y_current_canvas);
                ctx3.stroke();
            } else { // Animate horizontal line
                drawPoint3(workers, days, '#10b981', 8);
                const p = (percentage - 0.5) * 2;
                // Draw static vertical line
                ctx3.beginPath();
                ctx3.setLineDash([5, 5]);
                ctx3.strokeStyle = '#10b981';
                ctx3.lineWidth = 2;
                ctx3.moveTo(x_canvas, canvas3.height - padding3);
                ctx3.lineTo(x_canvas, y_intersect_canvas);

                // Animate horizontal
                const x_start_canvas = x_canvas;
                const x_target_canvas = padding3;
                const x_current_canvas = x_start_canvas + (x_target_canvas - x_start_canvas) * p;
                ctx3.moveTo(x_start_canvas, y_intersect_canvas);
                ctx3.lineTo(x_current_canvas, y_intersect_canvas);
                ctx3.stroke();
            }
             ctx3.setLineDash([]);
            
            if (progress < (duration*2)) {
                requestAnimationFrame(animate);
            } else {
                isAnimating3 = false;
                if (onComplete) onComplete();
            }
        }
        requestAnimationFrame(animate);
    }

    function animateSolution3_daysToWorkers(days, onComplete) {
        const workers = inverseConstant / days;
        const duration = 1500;
        let startTime = null;
        isAnimating3 = true;

        function animate(timestamp) {
            if (!startTime) startTime = timestamp;
            const progress = timestamp - startTime;
            const percentage = Math.min(progress / (duration * 2), 1);
            
            drawGraph3(false);
            // Draw previous animation statically
            drawWorkersSliderVisuals();


            const y_canvas = canvas3.height - padding3 - days * yScale3;
            const x_intersect_canvas = padding3 + workers * xScale3;
            
            if (percentage <= 0.5) { // Animate horizontal line
                const p = percentage * 2;
                const x_start_canvas = padding3;
                const x_current_canvas = x_start_canvas + (x_intersect_canvas - x_start_canvas) * p;
                ctx3.beginPath();
                ctx3.setLineDash([5, 5]);
                ctx3.strokeStyle = '#0ea5e9';
                ctx3.lineWidth = 2;
                ctx3.moveTo(x_start_canvas, y_canvas);
                ctx3.lineTo(x_current_canvas, y_canvas);
                ctx3.stroke();
            } else { // Animate vertical line
                drawPoint3(workers, days, '#0ea5e9', 8);
                const p = (percentage - 0.5) * 2;
                // Draw static horizontal line
                ctx3.beginPath();
                ctx3.setLineDash([5, 5]);
                ctx3.strokeStyle = '#0ea5e9';
                ctx3.lineWidth = 2;
                ctx3.moveTo(padding3, y_canvas);
                ctx3.lineTo(x_intersect_canvas, y_canvas);
                // Animate vertical
                const y_start_canvas = y_canvas;
                const y_target_canvas = canvas3.height - padding3;
                const y_current_canvas = y_start_canvas + (y_target_canvas - y_start_canvas) * p;
                ctx3.moveTo(x_intersect_canvas, y_start_canvas);
                ctx3.lineTo(x_intersect_canvas, y_current_canvas);
                ctx3.stroke();
            }
            ctx3.setLineDash([]);
            
            if (progress < (duration*2)) {
                requestAnimationFrame(animate);
            } else {
                isAnimating3 = false;
                if (onComplete) onComplete();
            }
        }
        requestAnimationFrame(animate);
    }
    
    workersSlider3.addEventListener('input', handleWorkersSlider3);
    daysSlider3.addEventListener('input', handleDaysSlider3);
    resetBtn3.addEventListener('click', resetSimulation3);
    
    // Model 4
    backBtn4.addEventListener('click', () => {
        homeScreen.classList.remove('hidden');
        simulationScreen.classList.add('hidden');
        resetSimulation(); resetSimulation2(); resetSimulation3(); resetSimulation4(); resetSimulation5();
    });

    addPointBtn4.addEventListener('click', () => {
        const validFactors = [1, 2, 3, 4, 6, 8, 12, 24];
        const x = parseInt(xInput4.value, 10);

        if (data4.length >= 8) {
            feedbackBox4.textContent = '8 роородро┐рокрпНрокрпБроХро│рпН роПро▒рпНроХройро╡рпЗ роЪрпЗро░рпНроХрпНроХрокрпНрокроЯрпНроЯрпБро│рпНро│рой.';
            return;
        }
        
        const isDuplicate = data4.some(p => p.x === x);
        if (isDuplicate) {
            feedbackBox4.textContent = `${x} роПро▒рпНроХройро╡рпЗ роЪрпЗро░рпНроХрпНроХрокрпНрокроЯрпНроЯродрпБ. ро╡рпЗро▒рпБ роХро╛ро░рогро┐ропрпИ роЙро│рпНро│ро┐роЯро╡рпБроорпН.`;
            feedbackBox4.style.backgroundColor = '#fee2e2';
            feedbackBox4.style.color = '#b91c1c';
            xInput4.value = '';
            xInput4.focus();
            setTimeout(() => {
                feedbackBox4.textContent = `роорпАродроорпБро│рпНро│ ${8 - data4.length} роородро┐рокрпНрокрпБроХро│рпИ роЙро│рпНро│ро┐роЯро╡рпБроорпН.`;
                feedbackBox4.style.backgroundColor = '#eef2ff';
                feedbackBox4.style.color = 'var(--primary-dark)';
            }, 2500);
            return;
        }

        if (!isNaN(x) && validFactors.includes(x)) {
            const y = inverseConstant4 / x;
            data4.push({ x, y });
            updateTable4();
            xInput4.value = '';
            xInput4.focus();

            if (data4.length >= 8) {
                feedbackBox4.innerHTML = '<b>роЕро░рпБроорпИ! роЗрокрпНрокрпЛродрпБ "рокрпБро│рпНро│ро┐роХро│рпИ роЙро░рпБро╡ро╛роХрпНроХро╡рпБроорпН" рокрпКродрпНродро╛ройрпИ роЕро┤рпБродрпНродро╡рпБроорпН.</b>';
                generatePointsBtn4.disabled = false;
                xInput4.disabled = true;
                addPointBtn4.disabled = true;
            } else {
                feedbackBox4.textContent = `(${x}, ${y}) рокрпБро│рпНро│ро┐ роЪрпЗро░рпНроХрпНроХрокрпНрокроЯрпНроЯродрпБ. роорпАродроорпБро│рпНро│ ${8 - data4.length} роородро┐рокрпНрокрпБроХро│рпИ роЙро│рпНро│ро┐роЯро╡рпБроорпН.`;
            }
        } else {
            feedbackBox4.textContent = `${x} роОройрпНрокродрпБ 24-ройрпН роЪро░ро┐ропро╛рой роХро╛ро░рогро┐ роЕро▓рпНро▓. (1, 2, 3, 4, 6, 8, 12, 24) роЗро╡ро▒рпНро▒ро┐ро▓рпН роТройрпНро▒рпИ роЙро│рпНро│ро┐роЯро╡рпБроорпН.`;
            feedbackBox4.style.backgroundColor = '#fee2e2';
            feedbackBox4.style.color = '#b91c1c';
            xInput4.value = '';
            xInput4.focus();

            setTimeout(() => {
                feedbackBox4.textContent = `роорпАродроорпБро│рпНро│ ${8 - data4.length} роородро┐рокрпНрокрпБроХро│рпИ роЙро│рпНро│ро┐роЯро╡рпБроорпН.`;
                feedbackBox4.style.backgroundColor = '#eef2ff';
                feedbackBox4.style.color = 'var(--primary-dark)';
            }, 2500);
        }
    });

    generatePointsBtn4.addEventListener('click', () => {
        if (data4.length < 8) return;
        const coordinatesText = data4
            .sort((a, b) => a.x - b.x) // Sort to ensure order
            .map(p => `<b>(${p.x}, ${p.y})</b>`)
            .join(', ');
        coordinatesDisplay4.innerHTML = coordinatesText;
        coordinatesDisplay4.classList.remove('hidden');
        generatePointsBtn4.disabled = true;
        plotBtn4.disabled = false;
        feedbackBox4.innerHTML = '<b>роЗрокрпНрокрпЛродрпБ ро╡ро░рпИрокроЯродрпНродро┐ро▓рпН "рокрпБро│рпНро│ро┐роХро│рпИроХрпН роХрпБро▒ро┐роХрпНроХро╡рпБроорпН".</b>';
    });

    plotBtn4.addEventListener('click', startManualPlotting4);
    
    lineBtn4.addEventListener('click', () => {
        if (!pointsPlotted4) return;
        lineDrawn4 = true;
        lineBtn4.disabled = true;
        
        feedbackBox4.innerHTML = '<b>роХрпЗро│рпНро╡ро┐ (i)</b>: x = 3 роОройро┐ро▓рпН y-ройрпН роородро┐рокрпНрокрпИроХрпН роХрогрпНроЯро▒ро┐ропрпБроорпН роХро░рпБро╡ро┐ропрпИ роЗропроХрпНроХ, рокрпКродрпНродро╛ройрпИ роЕро┤рпБродрпНродро╡рпБроорпН.';
        plotToolActivator4.querySelector('span').textContent = 'x = 3 роЗро▓рпН роородро┐рокрпНрокрпИроХрпН роХрогрпНроЯро▒ро┐ропро╡рпБроорпН';
        plotToolActivator4.classList.remove('hidden');

        const newActivator = activatorFinger4.cloneNode(true);
        activatorFinger4.parentNode.replaceChild(newActivator, activatorFinger4);
        activatorFinger4 = newActivator;

        activatorFinger4.addEventListener('click', activateXFinder4, { once: true });
    });

    function activateXFinder4() {
        plotToolActivator4.classList.add('hidden');
        isToolActive4 = true;
        waitForXClick4 = true;
        feedbackBox4.innerHTML = 'ро╡ро░рпИрокроЯродрпНродро┐ро▓рпН <b>(3, 0)</b> роОройрпНро▒ рокрпБро│рпНро│ро┐ропрпИроХрпН роХрогрпНроЯро▒ро┐ропро╡рпБроорпН.';
        canvas4.classList.add('plotting-active');
        document.body.classList.add('no-select');

        plotMoveHandler4 = (e) => plotMoveForX4(e);
        touchMoveHandler4 = (e) => plotMoveForX4(e);
        plotClickHandler4 = (e) => handlePlotClickForX4(e);

        document.addEventListener('mousemove', plotMoveHandler4);
        document.addEventListener('touchmove', touchMoveHandler4, { passive: false });
        canvas4.addEventListener('click', plotClickHandler4);
    }

    function plotMoveForX4(e) {
        if (!isToolActive4 || !waitForXClick4) return;
        e.preventDefault();
        const rect = canvas4.getBoundingClientRect();
        let clientX, clientY;
        if (e.touches && e.touches.length > 0) { clientX = e.touches[0].clientX; clientY = e.touches[0].clientY; } 
        else { clientX = e.clientX; clientY = e.clientY; }
        
        const rawMouseX = clientX - rect.left;
        const rawMouseY = clientY - rect.top;
        let graphX = (rawMouseX - padding4) / xScale4;
        let graphY = (canvas4.height - padding4 - rawMouseY) / yScale4;

        graphX = Math.max(0, Math.min(maxX4, graphX));
        graphY = Math.max(0, Math.min(maxY4, graphY));

        snappedGraphPos4.x = Math.round(graphX);
        snappedGraphPos4.y = Math.round(graphY);

        mouseCanvasPos4.x = padding4 + snappedGraphPos4.x * xScale4;
        mouseCanvasPos4.y = canvas4.height - padding4 - snappedGraphPos4.y * yScale4;
        
        isNearTarget4 = (snappedGraphPos4.x === 3 && snappedGraphPos4.y === 0);
        drawGraph4(false);
    }

    function handlePlotClickForX4(e) {
        if (!isToolActive4 || !waitForXClick4) return;
        if (e.target.closest('.controls-panel')) return;
        e.preventDefault();

        if (isNearTarget4) {
            isToolActive4 = false;
            waitForXClick4 = false;
            document.removeEventListener('mousemove', plotMoveHandler4);
            document.removeEventListener('touchmove', touchMoveHandler4);
            canvas4.removeEventListener('click', plotClickHandler4);
            canvas4.classList.remove('plotting-active');
            document.body.classList.remove('no-select');
            mouseCanvasPos4 = { x: -1, y: -1 };
            drawGraph4(false);

            feedbackBox4.textContent = 'роЪро░ро┐ропро╛ройродрпБ! родрпАро░рпНро╡рпБ роОро╡рпНро╡ро╛ро▒рпБ роХрогрпНроЯро▒ро┐ропрокрпНрокроЯрпБроХро┐ро▒родрпБ роОройрпНрокродрпИрокрпН рокро╛ро░рпБроЩрпНроХро│рпН...';
            animateSolution4_xToY(3, () => {
                feedbackBox4.innerHTML = '<b>роХрпЗро│рпНро╡ро┐ (ii)</b>: y = 6 роОройро┐ро▓рпН x-ройрпН роородро┐рокрпНрокрпИроХрпН роХрогрпНроЯро▒ро┐ропрпБроорпН роХро░рпБро╡ро┐ропрпИ роЗропроХрпНроХ, рокрпКродрпНродро╛ройрпИ роЕро┤рпБродрпНродро╡рпБроорпН.';
                plotToolActivator4.querySelector('span').textContent = 'y = 6 роЗро▓рпН роородро┐рокрпНрокрпИроХрпН роХрогрпНроЯро▒ро┐ропро╡рпБроорпН';
                plotToolActivator4.classList.remove('hidden');

                const newActivator = activatorFinger4.cloneNode(true);
                activatorFinger4.parentNode.replaceChild(newActivator, activatorFinger4);
                activatorFinger4 = newActivator;
                
                activatorFinger4.addEventListener('click', activateYFinder4, { once: true });
            });
        } else {
            feedbackBox4.style.backgroundColor = '#fee2e2';
            feedbackBox4.style.color = '#b91c1c';
            feedbackBox4.textContent = 'родро╡ро▒рпБ. ро╡ро░рпИрокроЯродрпНродро┐ро▓рпН (3, 0) рокрпБро│рпНро│ро┐ропрпИроХрпН роХрогрпНроЯро▒ро┐ропро╡рпБроорпН.';
            setTimeout(() => {
                feedbackBox4.style.backgroundColor = '#eef2ff';
                feedbackBox4.style.color = 'var(--primary-dark)';
                feedbackBox4.innerHTML = 'ро╡ро░рпИрокроЯродрпНродро┐ро▓рпН <b>(3, 0)</b> роОройрпНро▒ рокрпБро│рпНро│ро┐ропрпИроХрпН роХрогрпНроЯро▒ро┐ропро╡рпБроорпН.';
            }, 2000);
        }
    }

     function activateYFinder4() {
        plotToolActivator4.classList.add('hidden');
        isToolActive4 = true;
        waitForYClick4 = true;
        feedbackBox4.innerHTML = 'ро╡ро░рпИрокроЯродрпНродро┐ро▓рпН <b>(0, 6)</b> роОройрпНро▒ рокрпБро│рпНро│ро┐ропрпИроХрпН роХрогрпНроЯро▒ро┐ропро╡рпБроорпН.';
        canvas4.classList.add('plotting-active');
        document.body.classList.add('no-select');

        plotMoveHandler4 = (e) => plotMoveForY4(e);
        touchMoveHandler4 = (e) => plotMoveForY4(e);
        plotClickHandler4 = (e) => handlePlotClickForY4(e);

        document.addEventListener('mousemove', plotMoveHandler4);
        document.addEventListener('touchmove', touchMoveHandler4, { passive: false });
        canvas4.addEventListener('click', plotClickHandler4);
    }
    
    function plotMoveForY4(e) {
        if (!isToolActive4 || !waitForYClick4) return;
        e.preventDefault();
        const rect = canvas4.getBoundingClientRect();
        let clientX, clientY;
        if (e.touches && e.touches.length > 0) { clientX = e.touches[0].clientX; clientY = e.touches[0].clientY; } 
        else { clientX = e.clientX; clientY = e.clientY; }
        
        const rawMouseX = clientX - rect.left;
        const rawMouseY = clientY - rect.top;
        let graphX = (rawMouseX - padding4) / xScale4;
        let graphY = (canvas4.height - padding4 - rawMouseY) / yScale4;

        graphX = Math.max(0, Math.min(maxX4, graphX));
        graphY = Math.max(0, Math.min(maxY4, graphY));

        snappedGraphPos4.x = Math.round(graphX);
        snappedGraphPos4.y = Math.round(graphY);

        mouseCanvasPos4.x = padding4 + snappedGraphPos4.x * xScale4;
        mouseCanvasPos4.y = canvas4.height - padding4 - snappedGraphPos4.y * yScale4;
        
        isNearTarget4 = (snappedGraphPos4.x === 0 && snappedGraphPos4.y === 6);
        drawGraph4(false);
    }

     function handlePlotClickForY4(e) {
        if (!isToolActive4 || !waitForYClick4) return;
        if (e.target.closest('.controls-panel')) return;
        e.preventDefault();

        if (isNearTarget4) {
            isToolActive4 = false;
            waitForYClick4 = false;
            document.removeEventListener('mousemove', plotMoveHandler4);
            document.removeEventListener('touchmove', touchMoveHandler4);
            canvas4.removeEventListener('click', plotClickHandler4);
            canvas4.classList.remove('plotting-active');
            document.body.classList.remove('no-select');
            mouseCanvasPos4 = { x: -1, y: -1 };
            drawGraph4(false);

            feedbackBox4.textContent = 'роЪро░ро┐ропро╛ройродрпБ! родрпАро░рпНро╡рпБ роОро╡рпНро╡ро╛ро▒рпБ роХрогрпНроЯро▒ро┐ропрокрпНрокроЯрпБроХро┐ро▒родрпБ роОройрпНрокродрпИрокрпН рокро╛ро░рпБроЩрпНроХро│рпН...';
            animateSolution4_yToX(6, () => {
                isAnimating4 = false;
                questionsSection4.classList.remove('hidden');
                handleXSlider4();
                handleYSlider4();
                feedbackBox4.textContent = 'роЪро┐ро▒рокрпНрокрпБ! роЗрокрпНрокрпЛродрпБ ро╕рпНро▓рпИроЯро░рпНроХро│рпИрокрпН рокропройрпНрокроЯрпБродрпНродро┐ роХрпЗро│рпНро╡ро┐роХро│рпБроХрпНроХрпБ ро╡ро┐роЯрпИропро│ро┐роХрпНроХро╡рпБроорпН.';
                drawGraph4();
            });
        } else {
             feedbackBox4.style.backgroundColor = '#fee2e2';
            feedbackBox4.style.color = '#b91c1c';
            feedbackBox4.textContent = 'родро╡ро▒рпБ. ро╡ро░рпИрокроЯродрпНродро┐ро▓рпН (0, 6) рокрпБро│рпНро│ро┐ропрпИроХрпН роХрогрпНроЯро▒ро┐ропро╡рпБроорпН.';
            setTimeout(() => {
                feedbackBox4.style.backgroundColor = '#eef2ff';
                feedbackBox4.style.color = 'var(--primary-dark)';
                feedbackBox4.innerHTML = 'ро╡ро░рпИрокроЯродрпНродро┐ро▓рпН <b>(0, 6)</b> роОройрпНро▒ рокрпБро│рпНро│ро┐ропрпИроХрпН роХрогрпНроЯро▒ро┐ропро╡рпБроорпН.';
            }, 2000);
        }
    }


    function animateSolution4_xToY(xVal, onComplete) {
        const yVal = inverseConstant4 / xVal;
        const duration = 1500;
        let startTime = null;
        isAnimating4 = true;

        function animate(timestamp) {
            if (!startTime) startTime = timestamp;
            const progress = timestamp - startTime;
            const percentage = Math.min(progress / (duration * 2), 1);
            
            drawGraph4(false); 

            const x_canvas = padding4 + xVal * xScale4;
            const y_intersect_canvas = canvas4.height - padding4 - yVal * yScale4;
            
            if (percentage <= 0.5) { // Animate vertical line
                const p = percentage * 2;
                const y_start_canvas = canvas4.height - padding4;
                const y_current_canvas = y_start_canvas + (y_intersect_canvas - y_start_canvas) * p;
                ctx4.beginPath();
                ctx4.setLineDash([5, 5]);
                ctx4.strokeStyle = '#10b981';
                ctx4.lineWidth = 2;
                ctx4.moveTo(x_canvas, y_start_canvas);
                ctx4.lineTo(x_canvas, y_current_canvas);
                ctx4.stroke();
            } else { // Animate horizontal line
                drawPoint4(xVal, yVal, '#10b981', 8);
                const p = (percentage - 0.5) * 2;
                ctx4.beginPath();
                ctx4.setLineDash([5, 5]);
                ctx4.strokeStyle = '#10b981';
                ctx4.lineWidth = 2;
                ctx4.moveTo(x_canvas, canvas4.height - padding4);
                ctx4.lineTo(x_canvas, y_intersect_canvas);

                const x_start_canvas = x_canvas;
                const x_target_canvas = padding4;
                const x_current_canvas = x_start_canvas + (x_target_canvas - x_start_canvas) * p;
                ctx4.moveTo(x_start_canvas, y_intersect_canvas);
                ctx4.lineTo(x_current_canvas, y_intersect_canvas);
                ctx4.stroke();
            }
             ctx4.setLineDash([]);
            
            if (progress < (duration*2)) {
                requestAnimationFrame(animate);
            } else {
                isAnimating4 = false;
                if (onComplete) onComplete();
            }
        }
        requestAnimationFrame(animate);
    }

    function animateSolution4_yToX(yVal, onComplete) {
        const xVal = inverseConstant4 / yVal;
        const duration = 1500;
        let startTime = null;
        isAnimating4 = true;

        function animate(timestamp) {
            if (!startTime) startTime = timestamp;
            const progress = timestamp - startTime;
            const percentage = Math.min(progress / (duration * 2), 1);
            
            drawGraph4(false);
            drawXSliderVisuals4(); // Redraw previous solution

            const y_canvas = canvas4.height - padding4 - yVal * yScale4;
            const x_intersect_canvas = padding4 + xVal * xScale4;
            
            if (percentage <= 0.5) { // Animate horizontal line
                const p = percentage * 2;
                const x_start_canvas = padding4;
                const x_current_canvas = x_start_canvas + (x_intersect_canvas - x_start_canvas) * p;
                ctx4.beginPath();
                ctx4.setLineDash([5, 5]);
                ctx4.strokeStyle = '#0ea5e9';
                ctx4.lineWidth = 2;
                ctx4.moveTo(x_start_canvas, y_canvas);
                ctx4.lineTo(x_current_canvas, y_canvas);
                ctx4.stroke();
            } else { // Animate vertical line
                drawPoint4(xVal, yVal, '#0ea5e9', 8);
                const p = (percentage - 0.5) * 2;
                ctx4.beginPath();
                ctx4.setLineDash([5, 5]);
                ctx4.strokeStyle = '#0ea5e9';
                ctx4.lineWidth = 2;
                ctx4.moveTo(padding4, y_canvas);
                ctx4.lineTo(x_intersect_canvas, y_canvas);

                const y_start_canvas = y_canvas;
                const y_target_canvas = canvas4.height - padding4;
                const y_current_canvas = y_start_canvas + (y_target_canvas - y_start_canvas) * p;
                ctx4.moveTo(x_intersect_canvas, y_start_canvas);
                ctx4.lineTo(x_intersect_canvas, y_current_canvas);
                ctx4.stroke();
            }
            ctx4.setLineDash([]);
            
            if (progress < (duration*2)) {
                requestAnimationFrame(animate);
            } else {
                isAnimating4 = false;
                if (onComplete) onComplete();
            }
        }
        requestAnimationFrame(animate);
    }
    
    xSlider4.addEventListener('input', handleXSlider4);
    ySlider4.addEventListener('input', handleYSlider4);
    resetBtn4.addEventListener('click', resetSimulation4);

    // Model 5
    backBtn5.addEventListener('click', () => {
        homeScreen.classList.remove('hidden');
        simulationScreen.classList.add('hidden');
        resetSimulation(); resetSimulation2(); resetSimulation3(); resetSimulation4(); resetSimulation5();
    });
    
    plotBtn5.addEventListener('click', startManualPlotting5);
    lineBtn5.addEventListener('click', () => {
        if (!pointsPlotted5) return;
        lineDrawn5 = true;
        lineBtn5.disabled = true;
        drawGraph5();

        feedbackBox5.innerHTML = '<b>роХрпЗро│рпНро╡ро┐</b>: роХрпЖро│роЪро┐роХрпНроХро┐ройрпН роирпЗро░родрпНродрпИроХрпН роХрогрпНроЯро▒ро┐роп, ро╡ро░рпИрокроЯродрпНродро┐ро▓рпН <b>ро╡рпЗроХроорпН (x) = 2.4</b> роРроХрпН роХрогрпНроЯро▒ро┐ропрпБроорпН роХро░рпБро╡ро┐ропрпИ роЗропроХрпНроХро╡рпБроорпН.';
        plotToolActivator5.querySelector('span').textContent = 'x = 2.4 роЗро▓рпН роородро┐рокрпНрокрпИроХрпН роХрогрпНроЯро▒ро┐ропро╡рпБроорпН';
        plotToolActivator5.classList.remove('hidden');

        const newActivator = activatorFinger5.cloneNode(true);
        activatorFinger5.parentNode.replaceChild(newActivator, activatorFinger5);
        activatorFinger5 = newActivator;

        activatorFinger5.addEventListener('click', activateSpeedFinder, { once: true });
    });
    
    speedSlider5.addEventListener('input', handleSpeedSlider5);
    resetBtn5.addEventListener('click', resetSimulation5);


    // Initial setup
    clearCanvas();
    clearCanvas2();
    clearCanvas3();
    clearCanvas4();
    clearCanvas5();

</script>

</body>
</html>

